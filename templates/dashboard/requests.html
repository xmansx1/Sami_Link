{% extends "dashboard/base_admin.html" %}
{% block title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª{% endblock %}

{% block page_header %}
<section class="page-section admin-requests-page">
  <div class="profile-section" style="background: linear-gradient(135deg, var(--primary-50) 0%, var(--white) 100%); border: none; margin-bottom: 1.5rem;">
    <div class="admin-header-content" style="display: flex; flex-direction: column; gap: 1.5rem;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 2rem;">
        <div style="flex: 1;">
          <div class="section-badge" style="margin-bottom: 1rem;">
            ğŸ› ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
          </div>
          <h1 class="section-title" style="margin-bottom: 0.5rem;">
            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù†ØµÙ‘Ø©
          </h1>
          <p class="section-description">
            Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆÙ†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªÙØ§ØµÙŠÙ„ ÙƒÙ„ Ø·Ù„Ø¨.
          </p>
        </div>

        <div class="admin-meta" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; min-width: 220px;">
          <div class="profile-section text-center" style="padding: 1rem;">
            <div class="meta-label" style="font-size: 0.875rem; color: var(--dark-500); margin-bottom: 0.5rem;">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</div>
            <div class="meta-value" style="font-size: 1.25rem; font-weight: 800; color: var(--dark-800);">{{ today|date:"Y-m-d" }}</div>
          </div>
          <div class="profile-section text-center" style="padding: 1rem;">
            <div class="meta-label" style="font-size: 0.875rem; color: var(--dark-500); margin-bottom: 0.5rem;">ğŸ“¦ Ø¹Ø¯Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙÙ„ØªØ±Ø©</div>
            <div class="meta-value" style="font-size: 1.25rem; font-weight: 800; color: var(--dark-800);">
              {% if page_obj %}{{ page_obj.paginator.count }}{% else %}0{% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block content %}
<section class="page-section admin-requests-page">
  <div class="container">

    <div class="profile-section" style="margin-bottom: 2rem;">
      <form method="get" class="filter-form">
        <div class="form-grid-5" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1rem;">
          <div class="form-field" style="grid-column: span 2;">
            <label class="form-label">ğŸ” Ø¨Ø­Ø«</label>
            <input type="text" name="q" value="{{ q }}" class="input" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„â€¦">
          </div>

          <div class="form-field">
            <label class="form-label">ğŸ“… Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input type="date" name="start" value="{{ start }}" class="input">
          </div>

          <div class="form-field">
            <label class="form-label">ğŸ“… Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input type="date" name="end" value="{{ end }}" class="input">
          </div>

          <div class="form-field">
            <label class="form-label">ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select name="state" class="input">
              <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
              {% for value, label in state_choices %}
                <option value="{{ value }}" {% if state == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="form-actions" style="display: flex; gap: 0.5rem;">
          <button class="btn btn-primary">
            ğŸ” Ø¨Ø­Ø«
          </button>
          <a href="." class="btn btn-outline">
            ğŸ”„ ØªØµÙÙŠØ±
          </a>
        </div>
      </form>
    </div>

    <div class="profile-section">
      <div class="table-wrapper">
        <table class="table table-clean">
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
              <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody>
            {% if page_obj %}
              {% for r in page_obj %}
                <tr>
                  <td class="text-muted">R{{ r.id }}</td>

                  <td>
                    <div class="table-cell-main">
                      <div class="table-cell-title">{{ r.title|default:"-" }}</div>
                    </div>
                  </td>

                  <td>
                    <div class="client-info">
                      {% if r.client_name %}
                        {{ r.client_name }}
                      {% elif r.client and r.client.name %}
                        {{ r.client.name }}
                      {% elif r.client and r.client.get_full_name %}
                        {{ r.client.get_full_name }}
                      {% elif r.client and r.client.username %}
                        {{ r.client.username }}
                      {% else %}-{% endif %}
                    </div>
                  </td>

                  <td>
                    {% with req_state=r.state %}
                      {% if req_state %}
                        {% for value, label in state_choices %}
                          {% if value == req_state %}
                            <span class="badge 
                              {% if value == 'new' or value == 'pending' %}badge-pending
                              {% elif value == 'completed' or value == 'done' %}badge-verified
                              {% elif value == 'cancelled' or value == 'canceled' or value == 'rejected' %}badge-rejected
                              {% elif value == 'in_progress' or value == 'processing' %}badge-default
                              {% elif value == 'disputed' %}badge-rejected
                              {% elif value == 'offer_selected' %}badge-pending
                              {% elif value == 'agreement_pending' or value == 'awaiting_payment_confirmation' %}badge-pending
                              {% else %}badge-default{% endif %}">
                              {{ label }}
                            </span>
                          {% endif %}
                        {% endfor %}
                      {% elif r.status %}
                        {% for value, label in state_choices %}
                          {% if value == r.status %}
                            <span class="badge badge-default">{{ label }}</span>
                          {% endif %}
                        {% endfor %}
                      {% elif r.phase %}
                        <span class="badge badge-default">{{ r.phase }}</span>
                      {% else %}-{% endif %}
                    {% endwith %}
                  </td>

                  <td class="text-muted">
                    {% if r.created_at %}{{ r.created_at|date:"Y-m-d" }}{% else %}-{% endif %}
                  </td>

                  <td>
                    <div class="table-actions">
                      <a href="{% url 'marketplace:request_detail' r.id %}"
                         class="btn btn-outline btn-sm">
                        ğŸ‘ï¸ ÙØªØ­
                      </a>
                      <a href="{% url 'marketplace:admin_request_reassign' r.id %}"
                         class="btn btn-secondary btn-sm">
                        ğŸ”„ Ø¥Ø³Ù†Ø§Ø¯
                      </a>
                      <a href="{% url 'marketplace:admin_request_delete' r.id %}"
                         class="btn btn-danger btn-sm"
                         onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')">
                        ğŸ—‘ï¸ Ø­Ø°Ù
                      </a>
                    </div>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="6" class="text-center text-muted" style="padding: 3rem;">
                    <div class="empty-state">
                      <div class="empty-icon" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">ğŸ“­</div>
                      <h3 class="empty-title" style="font-size: 1.2rem; margin-bottom: 0.5rem; color: var(--dark-600);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</h3>
                      <p class="empty-description" style="color: var(--dark-500);">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«</p>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="6" class="text-center text-muted" style="padding: 3rem;">
                  <div class="empty-state">
                    <div class="empty-icon" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">âš™ï¸</div>
                    <h3 class="empty-title" style="font-size: 1.2rem; margin-bottom: 0.5rem; color: var(--dark-600);">Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØºÙŠØ± Ù…ØªÙˆÙØ±</h3>
                    <p class="empty-description" style="color: var(--dark-500);">Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Request ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠÙ‹Ø§</p>
                  </div>
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    {% if page_obj %}
      <div class="pagination profile-section" style="text-align: center; padding: 1.5rem;">
        <div class="pagination-inner employee-actions">
          {% if page_obj.has_previous %}
            <a class="btn btn-outline btn-sm"
               href="?page={{ page_obj.previous_page_number }}&q={{ q }}&state={{ state }}&start={{ start }}&end={{ end }}">
              â€¹ Ø§Ù„Ø³Ø§Ø¨Ù‚
            </a>
          {% else %}
            <span class="btn btn-outline btn-sm" style="opacity: 0.5; cursor: not-allowed;">â€¹ Ø§Ù„Ø³Ø§Ø¨Ù‚</span>
          {% endif %}

          <span class="pagination-info badge badge-default">
            Ø§Ù„ØµÙØ­Ø© {{ page_obj.number }} Ù…Ù† {{ page_obj.paginator.num_pages }}
          </span>

          {% if page_obj.has_next %}
            <a class="btn btn-outline btn-sm"
               href="?page={{ page_obj.next_page_number }}&q={{ q }}&state={{ state }}&start={{ start }}&end={{ end }}">
              Ø§Ù„ØªØ§Ù„ÙŠ â€º
            </a>
          {% else %}
            <span class="btn btn-outline btn-sm" style="opacity: 0.5; cursor: not-allowed;">Ø§Ù„ØªØ§Ù„ÙŠ â€º</span>
          {% endif %}
        </div>
      </div>
    {% endif %}

    {% if page_obj %}
    <div class="profile-section" style="background: var(--dark-50); margin-top: 2rem;">
      <div class="card-section-title">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</div>
      <div class="quick-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <div class="stat-item">
          <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø¶Ù…Ù† Ø§Ù„ÙÙ„ØªØ±Ø©)</div>
          <div class="stat-number">{{ page_obj.paginator.count|default:0 }}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©</div>
          <div class="stat-number">{{ page_obj|length }}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
          <div class="stat-number">{{ page_obj.number }}</div>
        </div>
        {% if q or start or end or state %}
        <div class="stat-item">
          <div class="stat-label">Ø¨Ø­Ø« Ù…ÙØ¹Ù„</div>
          <div class="stat-number">âœ…</div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

  </div>
</section>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script>
  (function () {
    // Ø¥Ø²Ø§Ù„Ø© ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø³Ø¨Ø¨Ø© Ù„Ù„Ù…Ø´ÙƒÙ„Ø©
    document.querySelectorAll('.scroll-reveal').forEach(el => {
      el.classList.remove('scroll-reveal');
    });

    document.querySelectorAll('.btn').forEach(function (button) {
      button.addEventListener('click', function() {
        if (typeof animateButtonClick === 'function') {
          animateButtonClick(this);
        }
      });
    });

    var filterForm = document.querySelector('.filter-form');
    if (filterForm) {
      var inputs = filterForm.querySelectorAll('input, select');

      inputs.forEach(function (input) {
        input.addEventListener('focus', function() {
          this.style.borderColor = 'var(--primary-500)';
          this.style.boxShadow = '0 0 0 3px rgba(34, 197, 94, 0.1)';
        });

        input.addEventListener('blur', function() {
          this.style.borderColor = '';
          this.style.boxShadow = '';
        });

        input.addEventListener('change', function() {
          this.style.background = 'var(--primary-50)';
          setTimeout(() => {
            this.style.background = '';
          }, 500);
        });
      });

      var searchInput = filterForm.querySelector('input[name="q"]');
      if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            filterForm.submit();
          }
        });
      }
    }

    document.querySelectorAll('.table-clean tbody tr').forEach(function (row) {
      row.addEventListener('mouseenter', function() {
        this.style.background = 'var(--primary-50)';
      });

      row.addEventListener('mouseleave', function() {
        this.style.background = '';
      });

      row.addEventListener('click', function(e) {
        if (!e.target.closest('.table-actions')) {
          var viewLink = this.querySelector('a[href*="request_detail"]');
          if (viewLink) {
            viewLink.style.transform = 'scale(0.95)';
            setTimeout(function () {
              viewLink.style.transform = '';
            }, 150);
          }
        }
      });
    });

    document.querySelectorAll('a[href*="admin_request_delete"]').forEach(function (link) {
      link.addEventListener('click', function(e) {
        var parts = this.href.split('/').filter(function (p) { return p; });
        var requestId = parts[parts.length - 1];
        var msg = "âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù\\n\\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ #R" + requestId +
                  " Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§.\\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.\\n\\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ";

        if (!confirm(msg)) {
          e.preventDefault();
          return false;
        }

        if (typeof showToast === 'function') {
          showToast('Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨...', 'info');
        }
      });
    });
  })();
  </script>

  <style>
  .admin-requests-page .form-grid-5 {
    grid-template-columns: repeat(5, 1fr);
  }

  .admin-requests-page .form-field {
    margin-bottom: 0;
  }

  .admin-requests-page .form-label {
    display: block;
    font-weight: 600;
    color: var(--dark-700);
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
  }

  .admin-requests-page .input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid var(--dark-300);
    border-radius: var(--radius-lg);
    background: var(--white);
    font-family: inherit;
    font-size: 1rem;
    transition: var(--transition);
  }

  .admin-requests-page .input:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
  }

  .admin-requests-page .table-wrapper {
    overflow-x: auto;
    border-radius: var(--radius-xl);
    border: 1px solid var(--dark-200);
  }

  .admin-requests-page .table-clean {
    width: 100%;
    border-collapse: collapse;
  }

  .admin-requests-page .table-clean th {
    background: var(--dark-50);
    color: var(--dark-700);
    font-weight: 600;
    padding: 1rem;
    text-align: right;
    border-bottom: 1px solid var(--dark-200);
  }

  .admin-requests-page .table-clean td {
    padding: 1rem;
    border-bottom: 1px solid var(--dark-100);
    vertical-align: middle;
    transition: all 0.3s ease;
  }

  .admin-requests-page .table-clean tr:last-child td {
    border-bottom: none;
  }

  .admin-requests-page .table-cell-main {
    min-width: 200px;
  }

  .admin-requests-page .table-cell-title {
    font-weight: 600;
    color: var(--dark-900);
  }

  .admin-requests-page .client-info {
    min-width: 150px;
    font-size: 0.95rem;
  }

  .admin-requests-page .table-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .admin-requests-page .text-muted {
    color: var(--dark-500);
  }

  .admin-requests-page .text-center {
    text-align: center;
  }

  .admin-requests-page .empty-state {
    padding: 2rem;
  }

  .admin-requests-page .empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .admin-requests-page .empty-title {
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
    color: var(--dark-600);
  }

  .admin-requests-page .empty-description {
    color: var(--dark-500);
  }

  .admin-requests-page .pagination-inner {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
  }

  .admin-requests-page .pagination-info {
    padding: 0.5rem 1rem;
  }

  .admin-requests-page .quick-stats {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }

  .admin-requests-page .stat-item {
    text-align: center;
    padding: 1rem;
    background: var(--white);
    border-radius: var(--radius-lg);
    border: 1px solid var(--dark-200);
  }

  .admin-requests-page .stat-label {
    font-size: 0.875rem;
    color: var(--dark-600);
    margin-bottom: 0.5rem;
  }

  .admin-requests-page .stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-600);
  }

  @media (max-width: 1024px) {
    .admin-requests-page .form-grid-5 {
      grid-template-columns: 1fr 1fr;
    }

    .admin-requests-page .form-field:first-child {
      grid-column: span 2;
    }
  }

  @media (max-width: 768px) {
    .admin-requests-page .form-grid-5 {
      grid-template-columns: 1fr;
    }

    .admin-requests-page .form-field:first-child {
      grid-column: span 1;
    }

    .admin-requests-page .table-actions {
      flex-direction: column;
    }

    .admin-requests-page .table-actions .btn {
      width: 100%;
    }

    .admin-requests-page .pagination-inner {
      flex-direction: column;
      gap: 0.5rem;
    }

    .admin-requests-page .quick-stats {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 480px) {
    .admin-requests-page .quick-stats {
      grid-template-columns: 1fr;
    }

    .admin-requests-page .table-wrapper {
      font-size: 0.875rem;
    }

    .admin-requests-page .table-clean th,
    .admin-requests-page .table-clean td {
      padding: 0.75rem 0.5rem;
    }
  }

  /* Ø¥Ø²Ø§Ù„Ø© ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø³Ø¨Ø¨Ø© Ù„Ù„Ù…Ø´ÙƒÙ„Ø© */
  .admin-requests-page .scroll-reveal {
    opacity: 1 !important;
    transform: none !important;
    animation: none !important;
  }
  </style>
{% endblock %}