{# marketplace/templates/marketplace/request_detail.html #}
{% extends "base.html" %}

{% block title %}Ø·Ù„Ø¨ #{{ req.pk }}{% endblock %}

{% block content %}

{# ===== Ø¹Ø±Ø¶ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ØªØ§Ø± Ø¨Ø´ÙƒÙ„ Ø¨Ø§Ø±Ø² Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© ===== #}

<section class="page-section request-detail-page">
  <div class="container">
    <div class="request-detail-card profile-section">

      {# ===== Ø§Ù„Ù‡ÙŠØ¯Ø± ===== #}
      <div class="card-header request-header-section">
        <div class="request-header">
          <div class="request-header-main">
            <div class="request-title-row">
              <h1 class="request-title profile-name">
                {{ req.title }}
              </h1>
              <div class="request-badges">
                <span class="badge badge-default">#{{ req.pk }}</span>
                <span class="badge
                  {% if req.status == 'completed' %}badge-verified
                  {% elif req.status == 'in_progress' %}badge-pending
                  {% elif req.status == 'cancelled' %}badge-rejected
                  {% else %}badge-default{% endif %}">
                  {{ req.get_status_display|default:req.status }}
                </span>
                {% if req.agreement_overdue %}
                  <span class="badge badge-rejected">
                    âš ï¸ ØªØ¬Ø§ÙˆØ²Øª Ù…Ù‡Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©
                  </span>
                {% endif %}
              </div>
            </div>
            <div class="request-meta">
              <div class="employee-location">
                <span>ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: <strong>{{ req.client }}</strong></span>
                {% if req.assigned_employee %}
                  <span> â€” ğŸ› ï¸ Ø§Ù„Ù…ÙˆØ¸Ù: <strong>{{ req.assigned_employee }}</strong></span>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="request-updated-at">
            <span class="text-muted">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {{ req.updated_at|date:"Y-m-d H:i" }}</span>
          </div>
        </div>

        {# ===== Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù‘Ù… Ø§Ù„Ø­Ø§Ù„Ø© ===== #}
        <div class="request-steps employee-stats" style="margin-top: 1.25rem;">
          <div class="employee-stat">
            <span class="badge {% if current_step >= 0 %}badge-verified{% else %}badge-muted{% endif %}">
              Ù¡. Ø·Ù„Ø¨
            </span>
          </div>
          <div class="step-separator"></div>
          <div class="employee-stat">
            <span class="badge {% if current_step >= 1 %}badge-verified{% else %}badge-muted{% endif %}">
              Ù¢. Ø¹Ø±Ø¶ Ù…Ø®ØªØ§Ø±
            </span>
          </div>
          <div class="step-separator"></div>
          <div class="employee-stat">
            <span class="badge {% if current_step >= 2 %}badge-verified{% else %}badge-muted{% endif %}">
              Ù£. Ø§ØªÙØ§Ù‚ÙŠØ©
            </span>
          </div>
          <div class="step-separator"></div>
          <div class="employee-stat">
            <span class="badge {% if current_step >= 3 %}badge-pending{% else %}badge-muted{% endif %}">
              Ù¤. ØªÙ†ÙÙŠØ°/ØªØ³Ù„ÙŠÙ…
            </span>
          </div>
          <div class="step-separator"></div>
          <div class="employee-stat">
            <span class="badge {% if current_step >= 4 %}badge-verified{% else %}badge-muted{% endif %}">
              Ù¥. Ø¥ÙƒÙ…Ø§Ù„
            </span>
          </div>
        </div>

        {# ===== Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¹Ø§Ù… ===== #}
        {% if request.user.is_authenticated %}
          <div class="request-header-actions employee-actions">
            {% if request.user.id == req.client_id or request.user.id == req.assigned_employee_id or request.user.is_staff or request.user.role == 'admin' %}
              <a href="{% url 'disputes:open_by_request' req.pk %}"
                 class="btn btn-danger btn-sm"
                 rel="nofollow">
                âš¡ ÙØªØ­ Ù†Ø²Ø§Ø¹
              </a>
            {% endif %}

            {% if request.user.is_staff or request.user.role == 'admin' %}
              <div class="request-status-panel">
                <span class="status-panel-label">ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©:</span>

                <form method="post"
                      action="{% url 'marketplace:request_change_status' req.pk %}"
                      class="inline-form"
                      onsubmit="return confirm('Ø³ÙŠØªÙ… ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ Â«Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°Â». Ù…ØªØ§Ø¨Ø¹Ø©ØŸ');">
                  {% csrf_token %}
                  <input type="hidden" name="status" value="in_progress">
                  <button class="btn btn-secondary btn-sm" aria-label="ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°">
                    ğŸš€ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
                  </button>
                </form>

                <form method="post"
                      action="{% url 'marketplace:request_change_status' req.pk %}"
                      class="inline-form"
                      onsubmit="return confirm('Ø³ÙŠØªÙ… ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ Â«Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§ØªÙØ§Ù‚ÙŠØ©Â». Ù…ØªØ§Ø¨Ø¹Ø©ØŸ');">
                  {% csrf_token %}
                  <input type="hidden" name="status" value="agreement_pending">
                  <button class="btn btn-secondary btn-sm" aria-label="ØªØ¹ÙŠÙŠÙ† Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§ØªÙØ§Ù‚ÙŠØ©">
                    ğŸ“ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§ØªÙØ§Ù‚ÙŠØ©
                  </button>
                </form>

                <form method="post"
                      action="{% url 'marketplace:request_change_status' req.pk %}"
                      class="inline-form"
                      onsubmit="return confirm('ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ Â«Ù…ÙƒØªÙ…Ù„Â» ÙŠØ¯ÙˆÙŠÙ‹Ø§ØŸ ÙŠÙÙØ¶Ù‘ÙÙ„ Ø§ÙƒØªÙ…Ø§Ù„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ø¯Ø§Ø¯.');">
                  {% csrf_token %}
                  <input type="hidden" name="status" value="completed">
                  <button class="btn btn-success btn-sm" aria-label="ØªØ¹ÙŠÙŠÙ† Ù…ÙƒØªÙ…Ù„">
                    âœ… Ù…ÙƒØªÙ…Ù„
                  </button>
                </form>

                <form method="post"
                      action="{% url 'marketplace:request_cancel' req.pk %}"
                      class="inline-form request-cancel-form"
                      onsubmit="return !!this.querySelector('[name=reason]').value || (alert('ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡.'), false)">
                  {% csrf_token %}
                  <div class="input-group">
                    <input type="text"
                           name="reason"
                           class="input input-sm"
                           placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡"
                           required>
                    <button class="btn btn-danger btn-sm">
                      ğŸ—‘ï¸ Ø¥Ù„ØºØ§Ø¡
                    </button>
                  </div>
                </form>
              </div>
            {% elif request.user.id == req.assigned_employee_id %}
              <div class="request-status-panel">
                <span class="status-panel-label">ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©:</span>
                <form method="post"
                      action="{% url 'marketplace:request_change_status' req.pk %}"
                      class="inline-form"
                      onsubmit="return confirm('Ø³ÙŠØªÙ… ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ Â«Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°Â». Ù…ØªØ§Ø¨Ø¹Ø©ØŸ');">
                  {% csrf_token %}
                  <input type="hidden" name="status" value="in_progress">
                  <button class="btn btn-secondary btn-sm">
                    ğŸš€ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
                  </button>
                </form>
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>

      <div class="card-body request-detail-body">

        {# ===== Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… ===== #}
        {% if request.user.is_authenticated %}
          {% if request.user.role == 'admin' or request.user.is_staff %}
            <div class="admin-panel profile-section" style="background: var(--secondary-50); border-color: var(--secondary-200);">
              <div class="admin-panel-header">
                <div class="admin-panel-title card-section-title">ğŸ‘‘ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</div>
              </div>
              <div class="admin-panel-actions employee-actions">
                <form method="post"
                      action="{% url 'marketplace:request_reset_to_new' req.pk %}"
                      onsubmit="return confirm('Ø³ÙŠÙØ¹Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨ ÙƒØ¬Ø¯ÙŠØ¯: Ø³ÙŠØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ ÙˆØ±ÙØ¶ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø£Ø±Ø´ÙØ©. ØªØ£ÙƒÙŠØ¯ØŸ');">
                  {% csrf_token %}
                  <button class="btn btn-outline btn-sm">
                    ğŸ”„ Ø¥Ø±Ø¬Ø§Ø¹ ÙƒØ¬Ø¯ÙŠØ¯
                  </button>
                </form>

                <a class="btn btn-outline btn-sm"
                   href="{% url 'marketplace:admin_request_reassign' req.pk %}">
                  ğŸ‘¥ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø³Ù†Ø§Ø¯ Ù„Ù…ÙˆØ¸Ù Ø¢Ø®Ø±
                </a>

                <form method="post"
                      action="{% url 'marketplace:admin_request_delete' req.pk %}"
                      onsubmit="return confirm('Ø³ÙŠØªÙ… Ø´Ø·Ø¨ Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹. ØªØ£ÙƒÙŠØ¯ØŸ');">
                  {% csrf_token %}
                  <button class="btn btn-danger btn-sm">
                    ğŸ—‘ï¸ Ø´Ø·Ø¨ Ù†Ù‡Ø§Ø¦ÙŠ
                  </button>
                </form>
              </div>
              <p class="admin-panel-note card-section-note">
                Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… ÙÙ‚Ø·.
              </p>
            </div>
          {% endif %}
        {% endif %}

        {# ğŸŸ¦ ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶ #}
        {% if can_offer %}
          <div class="profile-section" style="background: var(--primary-50); border-color: var(--primary-200);">
            <div class="card-row" style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
              <div class="card-text">
                ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ‚Ø¯ÙŠÙ… <strong>Ø¹Ø±Ø¶ ÙˆØ§Ø­Ø¯</strong> Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.
              </div>
              <a class="btn btn-primary btn-sm"
                 href="{% url 'marketplace:offer_create_cbv' req.pk %}">
                ğŸ“¨ ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶
              </a>
            </div>
          </div>
        {% elif my_offer %}
          <div class="profile-section" style="background: var(--dark-50);">
            <div class="card-row" style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
              <div class="card-text-main">
                <div class="card-title-small">Ø¹Ø±Ø¶Ùƒ Ø§Ù„Ù…Ù‚Ø¯Ù…</div>
                <div class="card-subtext">
                  Ø§Ù„Ø­Ø§Ù„Ø©: {{ my_offer.get_status_display|default:my_offer.status }}
                  â€” Ø§Ù„Ù…Ø¯Ø©: {{ my_offer.proposed_duration_days }} ÙŠÙˆÙ…
                  â€” ØµØ§ÙÙŠ Ø§Ù„Ù…ÙˆØ¸Ù:
                    <strong class="my-offer-net"
                            data-net="{{ my_offer.net_for_employee }}">
                      {{ my_offer.net_for_employee }}
                    </strong> Ø±.Ø³
                  â€” Ø§Ù„Ø¹Ø±Ø¶:
                    <strong class="my-offer-total"
                            data-total="{{ my_offer.client_total_amount|default_if_none:'' }}">
                      {{ my_offer.client_total_amount|default_if_none:"â€”" }}
                    </strong> Ø±.Ø³
                </div>
              </div>
              <span class="badge badge-muted">
                ğŸ“‹ Ù‚Ø¯Ù‘Ù…Øª Ø¹Ø±Ø¶Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„
              </span>
            </div>
          </div>
        {% endif %}

        {# Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø© #}
        <div class="request-summary-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
          {# Ø§Ù„Ù…Ø¯Ø©/Ø§Ù„Ù…Ø¨Ù„Øº #}
          <div class="profile-section">
            <div class="card-section-title">ğŸ“Š Ø§Ù„Ù…Ø¯Ø©/Ø§Ù„Ù…Ø¨Ù„Øº</div>
            <div class="summary-grid-inner">
              <div class="summary-box" style="background: var(--primary-50); padding: 1rem; border-radius: var(--radius-lg); margin-bottom: 1rem;">
                <div class="summary-box-label">Ù…Ù‚Ø¯Ù‘Ù…Ø© Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
                <div class="summary-box-values">
                  <div>Ø§Ù„Ù…Ø¯Ø©: <strong>{{ req.estimated_duration_days|default:"â€”" }}</strong> ÙŠÙˆÙ…</div>
                  <div>Ø§Ù„Ù…Ø¨Ù„Øº: <strong>{{ req.estimated_price|default:"â€”" }}</strong>
                    <span class="summary-unit">Ø±ÙŠØ§Ù„</span>
                  </div>
                </div>
              </div>

              {% if req.selected_offer %}
                {# â­ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ØªØ§Ø± Ø§Ù„Ù…Ø­Ø³Ù‘Ù† #}
                <div class="summary-box selected-offer-box"
                     style="background: #fffbeb; padding: 1.25rem 1.5rem; border-radius: var(--radius-xl); margin-bottom: 1rem; border: 1px solid #facc15; box-shadow: 0 6px 14px rgba(250, 204, 21, 0.12);">
                  <div class="summary-box-header"
                       style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                    <div class="summary-box-label"
                         style="display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #92400e;">
                      <span>ğŸ†</span>
                      <span>Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ØªØ§Ø±</span>
                    </div>
                    <span class="badge badge-muted"
                          style="background: rgba(250, 204, 21, 0.15); color: #92400e;">
                      Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„
                    </span>
                  </div>

                  <div class="summary-box-values">
                    <div style="margin-bottom: 0.5rem; color: #78350f; font-size: 0.95rem;">
                      Ø§Ù„Ù…Ø¯Ø©:
                      <strong>
                        {{ selected_offer.proposed_duration_days|default:"â€”" }}
                      </strong>
                      ÙŠÙˆÙ…
                    </div>

                    <div style="font-size: 1.25em; font-weight: 800; color: #166534; background: #f0fdf4; padding: 10px 14px; border-radius: 999px; display: inline-flex; align-items: baseline; gap: 0.35rem; margin-top: 0.25rem;">
                      <span>Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ø¹Ù…ÙŠÙ„:</span>
                      <span class="sel-total">
                        {{ selected_offer.client_total_amount|default_if_none:"â€”"|floatformat:2 }}
                      </span>
                      <span class="summary-unit">Ø±ÙŠØ§Ù„</span>
                    </div>
                   
                  </div>
                </div>
              {% endif %}

              {% if req.agreement %}
                <div class="summary-box"
                     style="background: #ecfdf5; padding: 1rem; border-radius: var(--radius-lg); border: 1px solid #bbf7d0;">
                  <div class="summary-box-label">Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</div>
                  <div class="summary-box-values">
                    <div>Ø§Ù„Ù…Ø¯Ø©: <strong>{{ req.agreement.duration_days }}</strong> ÙŠÙˆÙ…</div>
                    <div>
                      Ø§Ù„Ù…Ø¨Ù„Øº:
                      <strong>
                        {% if selected_offer_client_total %}
                          {{ selected_offer_client_total|floatformat:2 }}
                        {% elif req.agreement.grand_total %}
                          {{ req.agreement.grand_total|floatformat:2 }}
                        {% else %}
                          {{ req.agreement.total_amount|floatformat:2 }}
                        {% endif %}
                      </strong>
                      <span class="summary-unit">Ø±ÙŠØ§Ù„</span>
                    </div>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>

          {# Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ù†Ø¯ #}
          <div class="profile-section" style="background: var(--dark-50);">
            <div class="card-section-title">ğŸ‘¤ Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ù†Ø¯</div>
            <div class="card-text">
              {% if req.assigned_employee %}
                <div class="employee-name">{{ req.assigned_employee }}</div>
                {% if req.assigned_employee.phone %}
                  <div class="employee-location">
                    ğŸ“ {{ req.assigned_employee.phone }}
                  </div>
                {% endif %}
              {% elif req.selected_offer %}
                <div class="employee-name">{{ req.selected_offer.employee }}</div>
              {% else %}
                <div class="text-muted">â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø³Ù†Ø§Ø¯ Ø¨Ø¹Ø¯ â€”</div>
              {% endif %}
            </div>
          </div>
        </div>

        {# ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ #}
        <div class="profile-section">
          <div class="card-section-title">ğŸ“„ Ø§Ù„ØªÙØ§ØµÙŠÙ„</div>
          <div class="card-text prose-text">
            {{ req.details|default:"â€”"|urlize|linebreaksbr }}
          </div>
        </div>

        {% if req.links %}
          <div class="profile-section">
            <div class="card-section-title">ğŸ”— Ø±ÙˆØ§Ø¨Ø· Ù…Ø±ØªØ¨Ø·Ø©</div>
            <div class="card-text prose-text">
              {{ req.links|urlize|linebreaksbr }}
            </div>
          </div>
        {% endif %}

        {# ===== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ ===== #}
        {% if req.status != 'new' %}
          <div class="profile-section">
            <div class="card-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <div class="card-section-title">ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</div>
              <div class="card-section-note">ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ Ø£Ùˆ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø±Ø¶.</div>
            </div>

            <div class="request-contacts-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="profile-section" style="background: var(--dark-50);">
                <div class="card-subtitle">Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
                <div class="card-text">
                  <div>Ø§Ù„Ø§Ø³Ù…: <strong>{{ req.client }}</strong></div>

                  {% if req.client.phone %}
                    <div class="contact-row" style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;">
                      <span>ğŸ“±:</span>
                      <a class="link" dir="ltr"
                         href="tel:{{ req.client.phone }}">{{ req.client.phone }}</a>
                      <a class="btn btn-outline btn-sm" target="_blank"
                         rel="noopener noreferrer nofollow"
                         href="https://api.whatsapp.com/send?phone={{ req.client.phone|urlencode }}">
                        ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨
                      </a>
                    </div>
                  {% endif %}

                  {% if req.client.email %}
                    <div>
                      ğŸ“§:
                      <a class="link"
                         href="mailto:{{ req.client.email|urlencode }}">
                        {{ req.client.email }}
                      </a>
                    </div>
                  {% endif %}
                </div>
              </div>

              {% if req.assigned_employee or req.selected_offer %}
                <div class="profile-section" style="background: var(--dark-50);">
                  <div class="card-subtitle">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ù†Ø¯</div>
                  <div class="card-text">
                    <div>
                      Ø§Ù„Ø§Ø³Ù…:
                      <strong>
                        {% if req.assigned_employee %}
                          {{ req.assigned_employee }}
                        {% else %}
                          {{ req.selected_offer.employee }}
                        {% endif %}
                      </strong>
                    </div>

                    {% if req.assigned_employee and req.assigned_employee.phone %}
                      <div class="contact-row" style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0%;">
                        <span>ğŸ“±:</span>
                        <a class="link" dir="ltr"
                           href="tel:{{ req.assigned_employee.phone }}">{{ req.assigned_employee.phone }}</a>
                        <a class="btn btn-outline btn-sm" target="_blank"
                           rel="noopener noreferrer nofollow"
                           href="https://api.whatsapp.com/send?phone={{ req.assigned_employee.phone|urlencode }}">
                          ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨
                        </a>
                      </div>
                    {% elif req.selected_offer and req.selected_offer.employee and req.selected_offer.employee.phone %}
                      <div class="contact-row" style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;">
                        <span>ğŸ“±:</span>
                        <a class="link" dir="ltr"
                           href="tel:{{ req.selected_offer.employee.phone }}">{{ req.selected_offer.employee.phone }}</a>
                        <a class="btn btn-outline btn-sm" target="_blank"
                           rel="noopener noreferrer nofollow"
                           href="https://api.whatsapp.com/send?phone={{ req.selected_offer.employee.phone|urlencode }}">
                          ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨
                        </a>
                      </div>
                    {% endif %}

                    {% if req.assigned_employee and req.assigned_employee.email %}
                      <div>
                        ğŸ“§:
                        <a class="link"
                           href="mailto:{{ req.assigned_employee.email|urlencode }}">
                          {{ req.assigned_employee.email }}
                        </a>
                      </div>
                    {% elif req.selected_offer and req.selected_offer.employee and req.selected_offer.employee.email %}
                      <div>
                        ğŸ“§:
                        <a class="link"
                           href="mailto:{{ req.selected_offer.employee.email|urlencode }}">
                          {{ req.selected_offer.employee.email }}
                        </a>
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}

        {# Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª #}
        <div class="profile-section">
          <div class="card-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div class="card-section-title">ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
          </div>

          <div class="notes-list">
            {% for n in req.notes.all %}
              <div class="note-item profile-section" style="margin-bottom: 1rem; padding: 1rem; background: var(--dark-50);">
                <div class="note-meta" style="font-size: 0.875rem; color: var(--dark-500); margin-bottom: 0.5rem;">
                  ğŸ‘¤ {{ n.author }} â€” {{ n.created_at|date:"Y-m-d H:i" }}
                </div>
                <div class="note-text">
                  {{ n.text }}
                </div>
              </div>
            {% empty %}
              <div class="card-section-note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ø¹Ø¯.</div>
            {% endfor %}
          </div>

          <form class="note-form"
                method="post"
                action="{% url 'marketplace:request_add_note' req.pk %}"
                onsubmit="return confirm('Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨. ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŸ');">
            {% csrf_token %}
            <div class="note-form-row" style="display: flex; gap: 0.5rem; margin-top: 1rem;">
              <textarea name="text"
                        rows="2"
                        class="input"
                        placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø©..."
                        style="flex: 1;"></textarea>
              <button class="btn btn-primary btn-sm">
                ğŸ’¾ Ø­ÙØ¸
              </button>
            </div>
          </form>
        </div>

        {# Ø§Ù„Ø¹Ø±ÙˆØ¶ #}
        <div class="profile-section">
          <div class="card-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div class="card-section-title">ğŸ“¨ Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
          </div>

          <div class="offers-list">
            {% for off in req.offers.all %}
              <div class="offer-item profile-section {% if off.status == 'selected' %}offer-selected{% endif %}"
                   style="{% if off.status == 'selected' %}border-left: 4px solid var(--primary-500); background: var(--primary-50);{% endif %} margin-bottom: 1rem; padding: 1rem;">
                <div class="offer-main">
                  <div class="offer-title" style="font-weight: 600; margin-bottom: 0.5rem;">
                    ğŸ‘¤ {{ off.employee }}
                  </div>
                  <div class="offer-meta" style="color: var(--dark-500); margin-bottom: 0.5rem;">
                    Ø§Ù„Ø­Ø§Ù„Ø©: {{ off.get_status_display|default:off.status }}
                  </div>

                  {% if off.note %}
                    <div class="offer-note" style="background: var(--white); padding: 0.75rem; border-radius: var(--radius); margin-bottom: 0.75rem;">
                      {{ off.note|urlize|linebreaksbr }}
                    </div>
                  {% endif %}

                  <div class="offer-tags" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="badge badge-muted">
                      â±ï¸ Ø§Ù„Ù…Ø¯Ø©:
                      <strong>{{ off.proposed_duration_days }}</strong> ÙŠÙˆÙ…
                    </span>

                    {# Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙ‚Ø· Ù„Ù„Ø¹Ù…ÙŠÙ„ØŒ ÙŠØ´Ù…Ù„ ÙƒÙ„ Ø´ÙŠØ¡ #}
                    <span class="badge badge-primary" style="font-size: 1.1em; background: #f0fdf4; color: #166534; display: flex; flex-direction: column; align-items: flex-start;">
                      <span>
Ø§Ù„Ø¹Ø±Ø¶ :
                        <strong class="off-total"
                                data-total="{{ off.client_total_amount_cache|default_if_none:off.client_total_amount|default_if_none:'' }}">
                          {% if off.client_total_amount_cache or off.client_total_amount %}
                            {{ off.client_total_amount_cache|default_if_none:off.client_total_amount|floatformat:2 }}
                          {% else %}
                            â€”
                          {% endif %}
                        </strong>
                        Ø±ÙŠØ§Ù„
                      </span>
                      <span class="field-hint" style="font-size: 0.85em; color: #166534; margin-top: 2px;">
                      </span>
                    </span>
                  </div>

                  {# ØµØ§ÙÙŠ Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ø®ÙÙŠ Ù„Ù„Ø­Ø³Ø§Ø¨ ÙÙ‚Ø· #}
                  <span class="off-net"
                        data-net="{{ off.proposed_price }}"
                        style="display:none;"></span>
                </div>

                <div class="offer-actions" style="margin-top: 1rem;">
                  {% if req.client_id == request.user.id and req.status == 'new' and off.status != 'selected' %}
                    <form method="post"
                          action="{% url 'marketplace:offer_select' off.pk %}"
                          onsubmit="return confirm('Ø³ÙŠØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©. ØªØ£ÙƒÙŠØ¯ØŸ');">
                      {% csrf_token %}
                      <button class="btn btn-primary btn-sm">
                        âœ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø±Ø¶
                      </button>
                    </form>
                  {% elif off.status == 'selected' %}
                    <span class="badge badge-verified">
                      ğŸ† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ØªØ§Ø±
                    </span>
                  {% endif %}
                </div>
              </div>
            {% empty %}
              <div class="card-section-note">
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø¨Ø¹Ø¯.
              </div>
            {% endfor %}
          </div>
        </div>

        {# ===== Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© ===== #}
        {% if req.agreement %}
          <div class="profile-section">
            <div class="card-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <div class="card-section-title">ğŸ“ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</div>
              <div class="agreement-meta" style="display: flex; gap: 0.5rem;">
                <span class="badge badge-muted">
                  Ø±Ù‚Ù…: {{ req.agreement.pk }}
                </span>
                {% if req.agreement.status %}
                  <span class="badge
                               {% if req.agreement.status == 'accepted' %}badge-verified
                               {% elif req.agreement.status == 'rejected' %}badge-rejected
                               {% else %}badge-pending{% endif %}">
                    {{ req.agreement.get_status_display|default:req.agreement.status }}
                  </span>
                {% endif %}
              </div>
            </div>

            <div class="agreement-actions employee-actions">
              <a class="btn btn-secondary btn-sm"
                 href="{% url 'agreements:open_by_request' req.pk %}">
                ğŸ‘ï¸ Ø¹Ø±Ø¶/ØªØ­Ø±ÙŠØ± Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©
              </a>

              {% if request.user.id == req.client_id %}
                {% if req.status == 'agreement_pending' or req.agreement.status == 'pending' %}
                  <form action="{% url 'agreements:accept_by_request' req.pk %}"
                        method="post"
                        class="inline-form"
                        onsubmit="return confirm('Ø³ÙŠØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªÙ†ÙÙŠØ°. ØªØ£ÙƒÙŠØ¯ØŸ');">
                    {% csrf_token %}
                    <button class="btn btn-success btn-sm">
                      âœ… Ù…ÙˆØ§ÙÙ‚Ø©
                    </button>
                  </form>
                  <a class="btn btn-danger btn-sm"
                     href="{% url 'agreements:reject_by_request' req.pk %}"
                     onclick="return confirm('Ø³ÙŠØªÙ… Ø±ÙØ¶ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ');">
                    âŒ Ø±ÙØ¶
                  </a>
                {% endif %}
              {% endif %}

              {% if req.agreement.status == 'accepted' %}
                <span class="card-section-note">
                  âœ… Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© Ù…Ù‚Ø¨ÙˆÙ„Ø© â€” Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§.
                </span>
              {% endif %}
            </div>
          </div>

          {# ===== Ø§Ù„Ù…Ø±Ø§Ø­Ù„ + Ø§Ù„ÙÙˆØ§ØªÙŠØ± ===== #}
          {% with ag=req.agreement %}
            <div class="profile-section" style="background: var(--dark-50);">
              <div class="card-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 class="card-section-title">ğŸ“‹ Ø§Ù„Ù…Ù€Ø±Ø§Ø­Ù€Ù€Ù„</h3>
                <div class="card-section-note">
                  ØªÙØ­Ø¯Ù‘Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„ÙƒÙ„ Ù…Ø±Ø­Ù„Ø©
                </div>
              </div>

              <div class="table-wrapper">
                <table class="table table-clean" style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="border-bottom: 1px solid var(--dark-200);">
                      <th style="padding: 0.75rem; text-align: right;">#</th>
                      <th style="padding: 0.75rem; text-align: right;">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
                      <th style="padding: 0.75rem; text-align: right;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for ms in ag.milestones.all %}
                      <tr style="border-bottom: 1px solid var(--dark-100);">
                        <td style="padding: 0.75rem;">{{ forloop.counter }}</td>
                        <td style="padding: 0.75rem;">{{ ms.title|default:"â€”" }}</td>
                        <td style="padding: 0.75rem;">
                          {% if ms.approved_at %}
                            {{ ms.approved_at|date:"Y-m-d H:i" }}
                          {% else %}
                            <span class="badge badge-pending">
                              â³ ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯Ø© Ø¨Ø¹Ø¯
                            </span>
                          {% endif %}
                        </td>
                      </tr>
                    {% empty %}
                      <tr>
                        <td colspan="3" style="padding: 1rem; text-align: center; color: var(--dark-500);">
                          Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯.
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            {# Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© #}
            <div class="profile-section">
              <div class="card-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div class="card-section-title">ğŸ” ØªÙØ§ØµÙŠÙ„ ÙƒÙ„ Ù…Ø±Ø­Ù„Ø©</div>
              </div>

              <div class="milestones-list">
                {% for ms in ag.milestones.all %}
                  <div id="ms-{{ ms.id }}" class="milestone-item profile-section" style="margin-bottom: 1.5rem; padding: 1.5rem;">
                    <div class="milestone-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                      <div class="milestone-main" style="flex: 1;">
                        <div class="milestone-title-row" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                          <div class="milestone-title" style="font-weight: 600; font-size: 1.1rem;">
                            {{ ms.title }}
                          </div>
                          <span class="badge badge-muted">#{{ ms.id }}</span>
                        </div>
                        <div class="milestone-meta" style="color: var(--dark-500); margin-bottom: 0.75rem;">
                          Ø§Ù„ØªØ±ØªÙŠØ¨: {{ ms.order }} â€” Ø§Ù„Ù…Ù‡Ù„Ø©: {{ ms.due_days|default:"â€”" }} ÙŠÙˆÙ…
                        </div>

                        {% if ms.delivered_note %}
                          <div class="milestone-note" style="background: var(--primary-50); padding: 0.75rem; border-radius: var(--radius); margin-bottom: 0.75rem;">
                            <span class="label" style="font-weight: 600;">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…:</span> {{ ms.delivered_note }}
                          </div>
                        {% endif %}
                        {% if ms.rejected_reason %}
                          <div class="milestone-note milestone-note-error" style="background: #fef2f2; padding: 0.75rem; border-radius: var(--radius); margin-bottom: 0.75rem; border-left: 4px solid #ef4444;">
                            <span class="label" style="font-weight: 600;">âŒ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:</span> {{ ms.rejected_reason }}
                          </div>
                        {% endif %}

                        <div class="milestone-invoice-meta" style="display: flex; flex-wrap: wrap; gap: 1rem; font-size: 0.875rem; color: var(--dark-600);">
                          {% if ms.invoice %}
                            <span>
                              ğŸ§¾ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:
                              <a class="link"
                                 href="{% url 'finance:invoice_detail' ms.invoice.id %}">
                                #{{ ms.invoice.id }}
                              </a>
                            </span>
                            <span>
                              â° Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚:
                              {% if ms.invoice.due_at %}
                                {{ ms.invoice.due_at|date:"Y-m-d H:i" }}
                              {% else %}
                                â€”
                              {% endif %}
                            </span>
                          {% endif %}
                        </div>
                      </div>

                      <div class="milestone-status-pill">
                        {% if ms.invoice and ms.invoice.is_paid %}
                          <span class="badge badge-verified">ğŸ’° Ù…Ø¯ÙÙˆØ¹Ø©</span>
                        {% elif ms.is_approved %}
                          <span class="badge badge-verified">âœ… Ù…Ø¹ØªÙ…Ø¯Ø©</span>
                        {% elif ms.is_rejected %}
                          <span class="badge badge-rejected">âŒ Ù…Ø±ÙÙˆØ¶Ø©</span>
                        {% elif ms.is_pending_review %}
                          <span class="badge badge-pending">ğŸ‘€ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
                        {% elif ms.is_delivered %}
                          <span class="badge badge-default">ğŸ“¤ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</span>
                        {% else %}
                          <span class="badge badge-muted">ğŸ†• Ø¬Ø¯ÙŠØ¯Ø©</span>
                        {% endif %}
                      </div>
                    </div>

                    <div class="milestone-actions employee-actions">
                      {# Ø§Ù„Ù…ÙˆØ¸Ù: ØªØ³Ù„ÙŠÙ…/Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù„ÙŠÙ… #}
                      {% if request.user.is_authenticated and request.user.id == req.assigned_employee_id %}
                        {% if not ms.invoice or not ms.invoice.is_paid %}
                          {% if not ms.is_approved and not ms.is_pending_review %}
                            <form method="post"
                                  action="{% url 'agreements:milestone_deliver' ag.id ms.id %}#ms-{{ ms.id }}"
                                  class="milestone-deliver-form"
                                  onsubmit="return confirm('Ø³ÙŠØªÙ… ØªØ¹Ù„ÙŠÙ… Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ÙƒÙ€ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª. ØªØ£ÙƒÙŠØ¯ØŸ');">
                              {% csrf_token %}
                              <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                                <textarea name="note"
                                          rows="2"
                                          class="input input-sm"
                                          placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"
                                          style="flex: 1;"></textarea>
                                <button class="btn btn-secondary btn-sm">
                                  ğŸ“¤ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø±Ø­Ù„Ø©
                                </button>
                              </div>
                            </form>
                          {% else %}
                            <button class="btn btn-secondary btn-sm btn-disabled" disabled
                                    title="Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¢Ù†">
                              ğŸ“¤ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø±Ø­Ù„Ø©
                            </button>
                          {% endif %}
                        {% else %}
                          <button class="btn btn-secondary btn-sm btn-disabled" disabled
                                  title="Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø¯ÙÙˆØ¹Ø©">
                            ğŸ“¤ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø±Ø­Ù„Ø©
                          </button>
                        {% endif %}
                      {% endif %}

                      {# Ø§Ù„Ø¹Ù…ÙŠÙ„: Ø§Ø¹ØªÙ…Ø§Ø¯/Ø±ÙØ¶ â€” ÙÙ‚Ø· Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© #}
                      {% if request.user.is_authenticated and request.user.id == req.client_id %}
                        {% if ms.is_pending_review %}
                          <form method="post"
                                action="{% url 'agreements:milestone_approve' ag.id ms.id %}#ms-{{ ms.id }}"
                                onsubmit="return confirm('Ø³ÙŠØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø©. ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ØŸ');">
                            {% csrf_token %}
                            <button class="btn btn-success btn-sm">
                              âœ… Ø§Ø¹ØªÙ…Ø§Ø¯
                            </button>
                          </form>

                          <button class="btn btn-danger btn-sm"
                                  data-reject-modal="#rej-{{ ms.id }}">
                            âŒ Ø±ÙØ¶
                          </button>

                          {# Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø±ÙØ¶ #}
                          <div id="rej-{{ ms.id }}"
                               class="modal-overlay"
                               aria-hidden="true"
                               role="dialog"
                               aria-labelledby="rej-title-{{ ms.id }}"
                               style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.5);">
                            <div class="modal-backdrop" data-close-modal style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
                            <div class="modal-card profile-section" style="position: relative; background: var(--white); border-radius: var(--radius-xl); padding: 1.5rem; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                              <div class="modal-header" style="margin-bottom: 1rem;">
                                <div id="rej-title-{{ ms.id }}" class="modal-title card-section-title">
                                  âŒ Ø±ÙØ¶ Ø§Ù„Ù…Ø±Ø­Ù„Ø©: {{ ms.title }}
                                </div>
                              </div>
                              <form method="post"
                                    action="{% url 'agreements:milestone_reject' ag.id ms.id %}#ms-{{ ms.id }}"
                                    onsubmit="return confirm('Ø³ÙŠØªÙ… Ø±ÙØ¶ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ù…Ø¹ Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø¯Ø®Ù„. ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶ØŸ');">
                                {% csrf_token %}
                                <div class="modal-body">
                                  <label class="form-label" for="rej-text-{{ ms.id }}">
                                    Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶
                                  </label>
                                  <textarea id="rej-text-{{ ms.id }}"
                                            name="reason"
                                            rows="4"
                                            class="input"
                                            placeholder="ÙØ¶Ù„Ø§Ù‹ Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨Ù‹Ø§ ÙˆØ§Ø¶Ø­Ù‹Ø§..."
                                            style="width: 100%; margin-bottom: 0.5rem;"></textarea>
                                  <p class="field-hint" style="color: var(--dark-500); font-size: 0.875rem;">
                                    Ù„Ù† ÙŠØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±ÙØ¶ Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ø¨ ÙˆØ§Ø¶Ø­.
                                  </p>
                                </div>
                                <div class="modal-footer employee-actions">
                                  <button type="button"
                                          class="btn btn-outline btn-sm"
                                          data-close-modal>
                                    Ø¥Ù„ØºØ§Ø¡
                                  </button>
                                  <button class="btn btn-danger btn-sm">
                                    ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶
                                  </button>
                                </div>
                              </form>
                            </div>
                          </div>
                        {% else %}
                          <button class="btn btn-success btn-sm btn-disabled" disabled
                                  title="Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¢Ù†">
                            âœ… Ø§Ø¹ØªÙ…Ø§Ø¯
                          </button>
                          <button class="btn btn-danger btn-sm btn-disabled" disabled
                                  title="Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø±ÙØ¶ Ø§Ù„Ø¢Ù†">
                            âŒ Ø±ÙØ¶
                          </button>
                        {% endif %}
                      {% endif %}

                      {% if ms.invoice %}
                        <a href="{% url 'finance:invoice_detail' ms.invoice.id %}"
                           class="btn btn-outline btn-sm">
                          ğŸ§¾ Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                        </a>
                      {% endif %}
                    </div>
                  </div>
                {% empty %}
                  <div class="card-section-note">
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ø¨Ø¹Ø¯.
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endwith %}
        {% else %}
          {% if req.status == 'offer_selected' %}
            {% if request.user.id == req.assigned_employee_id or request.user.is_staff or request.user.role == 'admin' %}
              <div class="profile-section">
                <div class="card-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                  <div class="card-section-title">ğŸ“ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</div>
                </div>
                <a class="btn btn-primary btn-sm"
                   href="{% url 'agreements:open_by_request' req.pk %}">
                  ğŸ“ Ø¥Ù†Ø´Ø§Ø¡/ÙØªØ­ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©
                </a>
              </div>
            {% endif %}
          {% endif %}
        {% endif %}

        {# Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª #}
        {% if uploads %}
          <div class="profile-section">
            <div class="card-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <div class="card-section-title">ğŸ“ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</div>
            </div>
            <ul class="attachments-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
              {% for up in uploads %}
                <li id="up-{{ up.id }}" class="attachment-item profile-section" style="padding: 1rem; text-align: center;">
                  <div class="attachment-main">
                    <a class="btn btn-outline btn-sm"
                       href="{{ up.file.url }}"
                       target="_blank"
                       rel="noopener noreferrer">
                      ğŸ“¥ ØªØ­Ù…ÙŠÙ„/Ø¹Ø±Ø¶
                    </a>
                    {% if up.can_delete %}
                      <form method="post"
                            action="{% url 'uploads:delete' up.id %}"
                            onsubmit="return confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙÙ‚ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ');"
                            style="margin-top: 0.5rem;">
                        {% csrf_token %}
                        <button class="btn btn-danger btn-sm">
                          ğŸ—‘ï¸ Ø­Ø°Ù
                        </button>
                      </form>
                    {% endif %}
                  </div>
                  <div class="attachment-meta" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--dark-500);">
                    {{ up.created_at|date:"Y-m-d H:i" }}
                  </div>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {# Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© #}
        {% if thread_embed_url %}
          <div class="profile-section">
            <div class="card-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <div class="card-section-title">ğŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</div>
            </div>
            <iframe src="{{ thread_embed_url }}"
                    class="thread-iframe"
                    loading="lazy"
                    referrerpolicy="no-referrer"
                    style="width: 100%; height: 500px; border: 1px solid var(--dark-200); border-radius: var(--radius);"></iframe>
          </div>
        {% endif %}

      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script>
  (function () {
    // Ù†Ø³Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© ÙˆØ§Ù„Ø¶Ø±ÙŠØ¨Ø©
    var platformFeePercentRaw = "{{ platform_fee_percent|default_if_none:'' }}";
    var vatPercentRaw = "{{ vat_percent|default_if_none:'' }}";

    function normalizePercent(raw) {
      if (!raw) return 0;
      raw = String(raw).replace(',', '.');
      var num = parseFloat(raw);
      if (isNaN(num) || !isFinite(num)) return 0;
      if (num > 1) {
        return num / 100.0;
      }
      return num;
    }

    var platformFeePercent = normalizePercent(platformFeePercentRaw);
    var vatPercent = normalizePercent(vatPercentRaw);

    function computeTotal(netVal) {
      var net = +(netVal).toFixed(2);
      var fee = +(net * platformFeePercent).toFixed(2);
      var vat = +((net + fee) * vatPercent).toFixed(2);
      var total = +(net + fee + vat).toFixed(2);
      return total;
    }

    // ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„ÙƒÙ„ Ø¹Ø±Ø¶
    function updateOfferTotals() {
      var offerItems = document.querySelectorAll('.offer-item');
      if (!offerItems || offerItems.length === 0) {
        return;
      }

      offerItems.forEach(function (item) {
        var netEl = item.querySelector('.off-net');
        var totalEl = item.querySelector('.off-total');
        if (!netEl || !totalEl) {
          return;
        }

        var netRaw = netEl.getAttribute('data-net') || netEl.textContent;
        var netVal = parseFloat(netRaw);
        if (isNaN(netVal) || netVal <= 0) {
          return;
        }

        var totalRaw = totalEl.getAttribute('data-total');
        if (totalRaw && String(totalRaw).trim() !== '') {
          totalEl.textContent = totalRaw;
          return;
        }

        var total = computeTotal(netVal);
        totalEl.textContent = total.toFixed(2);
      });
    }

    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙÙŠ Ø§Ù„Ù…Ù„Ø®Øµ
    function updateSelectedOfferTotal() {
      var netEl = document.querySelector('.sel-net');
      var totalEl = document.querySelector('.sel-total');
      if (!netEl || !totalEl) {
        return;
      }

      var netRaw = netEl.getAttribute('data-net') || netEl.textContent;
      var netVal = parseFloat(netRaw);
      if (isNaN(netVal) || netVal <= 0) {
        return;
      }

      var totalRaw = totalEl.getAttribute('data-total');
      if (totalRaw && String(totalRaw).trim() !== '') {
        totalEl.textContent = parseFloat(totalRaw).toFixed(2);
        return;
      }

      var total = computeTotal(netVal);
      totalEl.textContent = total.toFixed(2);
    }

    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸Ù Ù†ÙØ³Ù‡
    function updateMyOfferTotal() {
      var netEl = document.querySelector('.my-offer-net');
      var totalEl = document.querySelector('.my-offer-total');
      if (!netEl || !totalEl) {
        return;
      }

      var netRaw = netEl.getAttribute('data-net') || netEl.textContent;
      var netVal = parseFloat(netRaw);
      if (isNaN(netVal) || netVal <= 0) {
        return;
      }

      var totalRaw = totalEl.getAttribute('data-total');
      if (totalRaw && String(totalRaw).trim() !== '') {
        totalEl.textContent = totalRaw;
        return;
      }

      var total = computeTotal(netVal);
      totalEl.textContent = total.toFixed(2);
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    updateOfferTotals();
    updateSelectedOfferTotal();
    updateMyOfferTotal();

    // Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø±ÙØ¶ (ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ ÙŠØ¯ÙˆÙŠ Ø¨Ø¯ÙˆÙ† hidden)
    document.addEventListener('click', function (e) {
      var trigger = e.target.closest('[data-reject-modal]');
      if (trigger) {
        var modalId = trigger.getAttribute('data-reject-modal');
        var modal = document.querySelector(modalId);
        if (modal) {
          modal.style.display = 'flex';   // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
          if (typeof showToast === 'function') {
            showToast('ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±ÙØ¶', 'info');
          }
        }
      }

      if (e.target.matches('[data-close-modal]') || e.target.classList.contains('modal-backdrop')) {
        var modalOverlay = e.target.closest('.modal-overlay');
        if (modalOverlay) {
          modalOverlay.style.display = 'none';  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        }
      }
    });

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§Ù„Ø²Ø± Escape
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        var openModal = document.querySelector('.modal-overlay[style*="display: flex"]');
        if (openModal) {
          openModal.style.display = 'none';
        }
      }
    });

    // ØªØ£Ø«ÙŠØ±Ø§Øª Ù„Ø·ÙŠÙØ© Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    var sections = document.querySelectorAll('.profile-section');
    sections.forEach(function (section, index) {
      section.style.animationDelay = (index * 0.05) + 's';
      section.classList.add('scroll-reveal');
    });

    if (typeof initScrollReveal === 'function') {
      initScrollReveal();
    }
  })();
  </script>
{% endblock %}
