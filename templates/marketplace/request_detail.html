{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block title %}{{ req.title }} | #{{ req.pk }}{% endblock %}

{% block content %}
<div class="project-workspace" dir="rtl">
    
    {# --- Header Section --- #}
    <div class="workspace-header">
        <div class="container">
            <div class="header-content">
                <div class="project-identity">
                    <div class="id-badge">#{{ req.pk }}</div>
                    <h1 class="project-title">{{ req.title }}</h1>
                    <div class="project-meta">
                        <span class="meta-item"><i class="fas fa-folder"></i> {{ req.category|default:"Ø¹Ø§Ù…" }}</span>
                        <span class="meta-item"><i class="far fa-clock"></i> {{ req.created_at|date:"d F Y" }}</span>
                    </div>
                </div>
                <div class="project-status-box">
                    <div class="status-label">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
                    <div class="status-badge {{ req.status }}">
                        {{ req.get_status_display }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container main-layout">
        
        {# --- Main Content Column --- #}
        <div class="content-column">
            
            {# --- Progress Stepper --- #}
            <div class="card stepper-card">
                <div class="stepper">
                    <div class="step {% if req.status != 'cancelled' %}active{% endif %}">
                        <div class="step-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="step-label">Ø§Ù„Ø·Ù„Ø¨</div>
                    </div>
                    <div class="step {% if req.status == 'offer_pending' or req.status == 'agreement_pending' or req.status == 'in_progress' or req.status == 'completed' %}active{% endif %}">
                        <div class="step-icon"><i class="fas fa-handshake"></i></div>
                        <div class="step-label">Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
                    </div>
                    <div class="step {% if req.status == 'in_progress' or req.status == 'completed' %}active{% endif %}">
                        <div class="step-icon"><i class="fas fa-cogs"></i></div>
                        <div class="step-label">Ø§Ù„ØªÙ†ÙÙŠØ°</div>
                    </div>
                    <div class="step {% if req.status == 'completed' %}active{% endif %}">
                        <div class="step-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="step-label">Ø§Ù„ØªØ³Ù„ÙŠÙ…</div>
                    </div>
                </div>
            </div>

            {# --- Alerts & Notifications Area --- #}
            {% if req.agreement and req.agreement.extension_requested_days and req.agreement.extension_requested_days > 0 and request.user.id == req.client_id %}
            <div class="alert-box warning fade-in-up">
                <div class="alert-icon">â³</div>
                <div class="alert-content">
                    <h3>Ø·Ù„Ø¨ ØªÙ…Ø¯ÙŠØ¯ Ù…Ù‡Ù„Ø©</h3>
                    <p>Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù ØªÙ…Ø¯ÙŠØ¯ Ù…Ø¯Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ <strong>{{ req.agreement.extension_requested_days }} ÙŠÙˆÙ…</strong>.</p>
                </div>
                <div class="alert-actions">
                    <form method="post" action="{% url 'agreements:approve_extension' req.agreement.pk %}">{% csrf_token %}<button class="btn-sm success">Ù…ÙˆØ§ÙÙ‚Ø©</button></form>
                    <form method="post" action="{% url 'agreements:reject_extension' req.agreement.pk %}">{% csrf_token %}<button class="btn-sm danger">Ø±ÙØ¶</button></form>
                </div>
            </div>
            {% endif %}

            {# --- Review Section (Client Only) --- #}
            {% if can_review and review_form %}
            <div class="alert-box success fade-in-up" style="background: #f0fdf4; border-color: #bbf7d0; padding: 2rem;">
                <div class="alert-icon" style="background: #dcfce7; color: #16a34a; width: 48px; height: 48px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; border-radius: 50%;">â­</div>
                <div class="alert-content" style="width: 100%;">
                    <h3 style="color: #166534; font-size: 1.25rem; margin-bottom: 0.5rem;">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙˆØ¸Ù</h3>
                    <p style="color: #15803d; margin-bottom: 1.5rem;">Ù„Ù‚Ø¯ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹! ÙŠØ±Ø¬Ù‰ ØªÙ‚ÙŠÙŠÙ… Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ù„Ù.</p>
                    
                    <form method="post" class="review-form">
                        {% csrf_token %}
                        <input type="hidden" name="submit_review" value="1">
                        
                        <div class="mb-4">
                            <label class="form-label d-block mb-2" style="font-weight: 600; color: #166534;">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…</label>
                            <div class="numeric-rating">
                                <input type="radio" id="rate0" name="rating" value="0" required />
                                <label for="rate0">0</label>
                                
                                <input type="radio" id="rate1" name="rating" value="1" />
                                <label for="rate1">1</label>
                                
                                <input type="radio" id="rate2" name="rating" value="2" />
                                <label for="rate2">2</label>
                                
                                <input type="radio" id="rate3" name="rating" value="3" />
                                <label for="rate3">3</label>
                                
                                <input type="radio" id="rate4" name="rating" value="4" />
                                <label for="rate4">4</label>
                                
                                <input type="radio" id="rate5" name="rating" value="5" />
                                <label for="rate5">5</label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label" style="font-weight: 600; color: #166534;">ØªØ¹Ù„ÙŠÙ‚Ùƒ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¬Ø±Ø¨Ø©</label>
                            <textarea name="comment" rows="4" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø±Ø£ÙŠÙƒ Ù‡Ù†Ø§..." style="border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem; width: 100%; resize: vertical; background: #fff;"></textarea>
                        </div>

                        <button type="submit" class="btn-primary" style="background: #16a34a; border-color: #16a34a; padding: 0.75rem 2rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
                        </button>
                    </form>
                </div>
            </div>

            <style>
                .numeric-rating {
                    display: flex;
                    gap: 0.5rem;
                    flex-wrap: wrap;
                }
                .numeric-rating input {
                    display: none;
                }
                .numeric-rating label {
                    cursor: pointer;
                    width: 40px;
                    height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: #fff;
                    border: 2px solid #cbd5e1;
                    border-radius: 8px;
                    font-weight: 700;
                    color: #64748b;
                    transition: all 0.2s ease;
                }
                .numeric-rating label:hover {
                    border-color: #16a34a;
                    color: #16a34a;
                    transform: translateY(-2px);
                }
                .numeric-rating input:checked + label {
                    background: #16a34a;
                    border-color: #16a34a;
                    color: #fff;
                    box-shadow: 0 4px 6px -1px rgba(22, 163, 74, 0.3);
                }
            </style>
            {% endif %}

            {# --- Tabs Navigation --- #}
            <div class="tabs-nav">
                <button class="tab-btn active" onclick="switchTab('overview')">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</button>
                <button class="tab-btn" onclick="switchTab('workspace')">Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„</button>
                <button class="tab-btn" onclick="switchTab('financials')">Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø¹Ù‚ÙˆØ¯</button>
                {% if req.agreement %}
                <button class="tab-btn" onclick="switchTab('milestones')">Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ÙˆØ§Ù„Ø¥Ù†Ø¬Ø§Ø²</button>
                {% endif %}
                {% if req.offers.exists or req.status == 'new' or req.status == 'offer_pending' %}
                <button class="tab-btn" onclick="switchTab('offers')">Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</button>
                {% endif %}
            </div>

            {# --- Tab: Overview --- #}
            <div id="tab-overview" class="tab-content active fade-in-up">
                <div class="card">
                    <h3 class="card-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
                    <div class="project-description">
                        {{ req.details|linebreaks }}
                    </div>

                    {# --- Client Estimates & Links Section --- #}
                    <div class="client-estimates" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                        <h4 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: #1e293b;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <div style="color: #64748b; font-size: 0.875rem; margin-bottom: 0.5rem;">Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©</div>
                                <div style="font-weight: 600; color: #0f172a; font-size: 1.1rem;">
                                    {{ req.estimated_duration_days }} ÙŠÙˆÙ…
                                </div>
                            </div>
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <div style="color: #64748b; font-size: 0.875rem; margin-bottom: 0.5rem;">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©</div>
                                <div style="font-weight: 600; color: #0f172a; font-size: 1.1rem;">
                                    {{ req.estimated_price|intcomma }} Ø±ÙŠØ§Ù„
                                </div>
                            </div>
                        </div>

                        {% if req.links %}
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="color: #64748b; font-size: 0.875rem; margin-bottom: 0.5rem;">Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª</div>
                            <div style="color: #334155; line-height: 1.6; word-break: break-all;">
                                {{ req.links|urlize|linebreaks }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if req.files.all %}
                    <div class="attachments-section">
                        <h4>Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø© Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨</h4>
                        <div class="files-grid">
                            {% for f in req.files.all %}
                            <a href="{{ f.file.url }}" class="file-item" target="_blank">
                                <span class="file-icon">ğŸ“</span>
                                <span class="file-name">{{ f.filename|default:"Ù…Ù„Ù Ù…Ø±ÙÙ‚" }}</span>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# --- Tab: Workspace (Chat & Files) --- #}
            <div id="tab-workspace" class="tab-content fade-in-up">
                <div class="card chat-card">
                    <div class="chat-header">
                        <h3>Ù†Ù‚Ø§Ø´ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
                        <span class="badge-pill">Ù…Ø³Ø§Ø­Ø© Ù…Ø´ØªØ±ÙƒØ©</span>
                    </div>
                    
                    <div class="chat-messages" id="chatBox">
                        {% for comment in req.comments.all %}
                        <div class="message {% if comment.author == request.user %}outgoing{% else %}incoming{% endif %}">
                            <div class="msg-avatar">{{ comment.author.first_name|first }}</div>
                            <div class="msg-bubble">
                                <div class="msg-author">{{ comment.author.get_full_name|default:comment.author.email }}</div>
                                <div class="msg-text">{{ comment.content|linebreaksbr }}</div>
                                {% if comment.file %}
                                <a href="{{ comment.file.url }}" class="msg-file" target="_blank">
                                    ğŸ“ {{ comment.filename|default:"Ù…Ù„Ù Ù…Ø±ÙÙ‚" }}
                                </a>
                                {% endif %}
                                <div class="msg-time">{{ comment.created_at|date:"H:i | d/m" }}</div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="empty-chat">
                            <div class="empty-icon">ğŸ’¬</div>
                            <p>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù†Ù‚Ø§Ø´ Ø­ÙˆÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù‡Ù†Ø§...</p>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="chat-input-area">
                        <form method="post" action="{% url 'marketplace:add_comment' req.pk %}" enctype="multipart/form-data" class="chat-form">
                            {% csrf_token %}
                            <div class="input-wrapper">
                                <textarea name="content" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." required></textarea>
                                <div class="file-upload-wrapper">
                                    <input type="file" name="file" id="chatFile" class="hidden-input">
                                    <label for="chatFile" class="file-btn" title="Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù">ğŸ“</label>
                                </div>
                            </div>
                            <button type="submit" class="send-btn">
                                <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            {# --- Tab: Financials & Agreement --- #}
            <div id="tab-financials" class="tab-content fade-in-up">
                {% if req.agreement %}
                <div class="card mb-4">
                    <div class="card-header-row">
                        <div class="flex-col">
                            <h3 class="card-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</h3>
                            <span class="status-pill {{ req.agreement.status }}">{{ req.agreement.get_status_display }}</span>
                        </div>
                        <a href="{% url 'agreements:detail' req.agreement.pk %}" class="btn-link">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„ÙƒØ§Ù…Ù„ â†—</a>
                    </div>

                    {% if req.agreement.status == 'rejected' and req.agreement.rejection_reason %}
                    <div class="alert alert-danger mt-2">
                        <strong>Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:</strong> {{ req.agreement.rejection_reason }}
                    </div>
                    {% endif %}

                    <div class="info-grid mt-4">
                        <div class="info-item">
                            <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</label>
                            <span class="value">{{ req.agreement.grand_total|floatformat:2|intcomma }} Ø±.Ø³</span>
                            <span style="font-size: 0.75rem; color: #64748b;">(Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</span>
                        </div>
                        <div class="info-item">
                            <label>Ù…Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ°</label>
                            <span class="value">{{ req.agreement.duration_days }} ÙŠÙˆÙ…</span>
                        </div>
                        <div class="info-item">
                            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label>
                            {% if req.agreement.started_at %}
                                <span class="value">{{ req.agreement.started_at|date:"Y-m-d" }}</span>
                            {% else %}
                                <span class="value text-muted" style="font-size: 0.9rem;">Ù…Ù† ØªØ§Ø±ÙŠØ® Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</span>
                            {% endif %}
                        </div>
                        <div class="info-item">
                            {% if req.agreement.started_at %}
                                <span class="value">{{ req.agreement.end_date|date:"Y-m-d"|default:"-" }}</span>
                            {% else %}
                                <span class="value text-muted" style="font-size: 0.9rem;">Ø¨Ø¹Ø¯ {{ req.agreement.duration_days }} ÙŠÙˆÙ… Ù…Ù† Ø§Ù„Ø¨Ø¯Ø¡</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª</h3>
                    <div class="table-responsive">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Ø§Ù„ÙˆØµÙ</th>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for inv in req.agreement.invoices.all %}
                                <tr>
                                    <td>{{ inv.id }}</td>
                                    <td>{{ inv.title }}</td>
                                    <td class="font-bold">{{ inv.amount|floatformat:2 }} Ø±.Ø³</td>
                                    <td>
                                        {% if inv.is_paid %}
                                        <span class="status-pill success">Ù…Ø¯ÙÙˆØ¹Ø©</span>
                                        {% else %}
                                        <span class="status-pill warning">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø¯Ø§Ø¯</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if not inv.is_paid and request.user.id == req.client_id %}
                                        {# <a href="{% url 'finance:invoice_detail' inv.id %}" class="btn-sm primary">Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¢Ù†</a> #}
                                        <button type="button" class="btn-sm primary" disabled style="opacity: 0.5; cursor: not-allowed;">Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¢Ù† (Ù‚Ø±ÙŠØ¨Ø§Ù‹)</button>
                                        {% elif inv.is_paid %}
                                        <a href="{% url 'finance:invoice_detail' inv.id %}" class="btn-sm outline">Ø§Ù„ÙØ§ØªÙˆØ±Ø©</a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="5" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…ØµØ¯Ø±Ø© Ø¨Ø¹Ø¯</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                {% if req.is_offer_selected or req.status == 'offer_selected' %}
                <div class="empty-state-card">
                    <div class="icon">ğŸ“</div>
                    <h3>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</h3>
                    
                    {% if can_create_agreement or request.user.id == req.assigned_employee_id %}
                        <p>Ù„Ù‚Ø¯ ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø¹Ø±Ø¶Ùƒ! ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ÙˆØ¯Ø© Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„Ø¹Ù…ÙŠÙ„.</p>
                        <a href="{% url 'agreements:open_by_request' req.pk %}" class="btn primary mt-3">
                            <i class="fas fa-file-signature"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©
                        </a>
                    {% else %}
                        <p>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚ÙŠØ§Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„ÙŠÙ‡Ø§.</p>
                    {% endif %}
                </div>
                {% else %}
                <div class="empty-state-card">
                    <div class="icon">ğŸ“„</div>
                    <h3>Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªÙØ§Ù‚ÙŠØ© Ø¨Ø¹Ø¯</h3>
                    <p>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø±Ø¶ ÙˆØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.</p>
                </div>
                {% endif %}
                {% endif %}
            </div>

            {# --- Tab: Milestones --- #}
            {% if req.agreement %}
            <div id="tab-milestones" class="tab-content fade-in-up">
                <div class="card">
                    <div class="card-header-row">
                        <h3 class="card-title">Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
                        <span class="badge-pill info">{{ req.agreement.milestones.count }} Ù…Ø±Ø§Ø­Ù„</span>
                    </div>

                    <div class="milestones-list" style="margin-top: 1.5rem;">
                        {% for milestone in req.agreement.milestones.all %}
                        <div class="milestone-item" style="border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; background: #fff;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                                <div>
                                    <h4 style="margin: 0; font-size: 1.1rem; font-weight: 700; color: #0f172a;">
                                        {{ milestone.order }}. {{ milestone.title }}
                                    </h4>
                                    <div style="margin-top: 0.5rem; color: #64748b; font-size: 0.9rem;">
                                        <span>â±ï¸ {{ milestone.due_days|default:"-" }} ÙŠÙˆÙ…</span>
                                    </div>
                                </div>
                                <div class="status-badge {{ milestone.status }}">
                                    {{ milestone.get_status_display }}
                                </div>
                            </div>

                            {# --- Delivery Note (if delivered) --- #}
                            {% if milestone.delivered_note %}
                            <div style="margin-top: 1rem; background: #f8fafc; padding: 1rem; border-radius: 8px; border-right: 3px solid #3b82f6;">
                                <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.25rem;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…:</div>
                                <div style="color: #334155;">{{ milestone.delivered_note|linebreaksbr }}</div>
                                <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.5rem;">
                                    {{ milestone.delivered_at|date:"Y-m-d H:i" }}
                                </div>
                            </div>
                            {% endif %}

                            {# --- Rejection Reason (if rejected) --- #}
                            {% if milestone.rejected_reason %}
                            <div style="margin-top: 1rem; background: #fef2f2; padding: 1rem; border-radius: 8px; border-right: 3px solid #ef4444;">
                                <div style="font-size: 0.8rem; color: #991b1b; margin-bottom: 0.25rem;">Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:</div>
                                <div style="color: #7f1d1d;">{{ milestone.rejected_reason|linebreaksbr }}</div>
                            </div>
                            {% endif %}

                            {# --- Actions --- #}
                            <div style="margin-top: 1.5rem; display: flex; gap: 0.75rem; justify-content: flex-end;">
                                {% if request.user.id == req.assigned_employee_id %}
                                    {# Employee Actions #}
                                    {% if milestone.status == 'pending' or milestone.status == 'rejected' %}
                                        <button type="button" class="btn-sm primary" onclick="openDeliverModal('{{ milestone.id }}', '{{ milestone.title|escapejs }}')">
                                            ğŸ“¤ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø±Ø­Ù„Ø©
                                        </button>
                                    {% endif %}
                                {% elif request.user.id == req.client_id %}
                                    {# Client Actions #}
                                    {% if milestone.status == 'delivered' %}
                                        <form method="post" action="{% url 'agreements:milestone_review' req.agreement.pk milestone.id %}" style="display:inline;">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="approve">
                                            <button type="submit" class="btn-sm success">âœ… Ø§Ø¹ØªÙ…Ø§Ø¯</button>
                                        </form>
                                        <button type="button" class="btn-sm danger" onclick="openRejectMilestoneModal('{{ milestone.id }}', '{{ milestone.title|escapejs }}')">
                                            âŒ Ø±ÙØ¶
                                        </button>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø­Ù„ Ù…Ø­Ø¯Ø¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            {# --- Tab: Offers (Only for Client/Admin) --- #}
            {% if req.status == 'new' or req.status == 'offer_pending' or req.offers.exists %}
            <div id="tab-offers" class="tab-content fade-in-up">
                {% if req.offers.all %}
                    {% for offer in req.offers.all %}
                    <div class="card offer-card">
                        <div class="offer-header">
                            <div class="offer-user">
                                <div class="avatar">{{ offer.employee.first_name|first }}</div>
                                <div>
                                    <h4>{{ offer.employee.get_full_name }}</h4>
                                    <span class="role">Ù…ÙˆØ¸Ù Ù…Ø®ØªØµ</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="offer-highlights">
                            <div class="highlight-item price">
                                <span class="label">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                                {% with breakdown=offer.breakdown %}
                                <span class="value">{{ breakdown.client_total|floatformat:2|intcomma }} <small>Ø±.Ø³</small></span>
                                <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
                                    (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)
                                </div>
                                {% endwith %}
                            </div>
                            <div class="highlight-item duration">
                                <span class="label">Ù…Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ°</span>
                                <span class="value">{{ offer.proposed_duration_days }} <small>ÙŠÙˆÙ…</small></span>
                            </div>
                        </div>

                        <div class="offer-body">
                            <p>{{ offer.note|truncatewords:30 }}</p>
                            <a href="{% url 'marketplace:offer_detail' offer.id %}" class="read-more-link">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙƒØ§Ù…Ù„Ø© &larr;</a>
                        </div>

                        {% if request.user.id == req.client_id %}
                        <div class="offer-actions">
                            {% if offer.status == 'selected' or req.selected_offer == offer %}
                                <div class="selected-badge" style="background: #dcfce7; color: #166534; padding: 0.75rem; border-radius: 8px; text-align: center; font-weight: 600; border: 1px solid #bbf7d0;">
                                    <i class="fas fa-check-circle"></i> ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶
                                </div>
                            {% elif req.status == 'offer_selected' or req.status == 'agreement_pending' or req.status == 'in_progress' or req.status == 'completed' %}
                                {# If ANY offer is selected, hide actions for others #}
                                <div class="text-center text-muted" style="padding: 0.5rem; font-size: 0.9rem;">
                                    ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø±Ø¶ Ø¢Ø®Ø±
                                </div>
                            {% else %}
                                <form method="post" action="{% url 'marketplace:offer_select' offer.id %}">
                                    {% csrf_token %}
                                    <button class="btn-block primary">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</button>
                                </form>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                <div class="empty-state-card">
                    <div class="icon">ğŸ·ï¸</div>
                    <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</h3>
                    <p>Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† Ø§Ù„Ù…Ø®ØªØµÙˆÙ† Ø¨ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±ÙˆØ¶Ù‡Ù… Ù‚Ø±ÙŠØ¨Ø§Ù‹.</p>
                </div>
                {% endif %}
            </div>
            {% endif %}

        </div>

        {# --- Sidebar Column --- #}
        <div class="sidebar-column">
            
            {# --- Employee Actions (Submit Offer) --- #}
            {% if can_offer %}
            <div class="card action-card-highlight">
                <div class="action-icon-wrapper">
                    <div class="action-icon">ğŸš€</div>
                </div>
                <h3>ÙØ±ØµØ© Ù…ØªØ§Ø­Ø©!</h3>
                <p>Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø®ØªØµÙŠÙ†. Ù‚Ø¯Ù‘Ù… Ø¹Ø±Ø¶Ùƒ Ø§Ù„Ø¢Ù†.</p>
                <a href="{% url 'marketplace:offer_create' req.pk %}" class="btn-block primary pulse-btn" style="display: flex; align-items: center; justify-content: center; text-decoration: none;">
                    <i class="fas fa-plus-circle" style="margin-left: 0.5rem;"></i> ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶
                </a>
            </div>
            {% endif %}

            {# --- Counterparty Card --- #}
            <div class="card profile-card">
                {% if request.user.id == req.client_id %}
                    {# Client viewing Employee #}
                    <div class="card-header-sm">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</div>
                    {% if req.assigned_employee %}
                    <div class="profile-info">
                        <div class="avatar lg">{{ req.assigned_employee.first_name|first }}</div>
                        <h3>{{ req.assigned_employee.get_full_name }}</h3>
                        <p class="role">Ù…ÙˆØ¸Ù Ù…Ø¹ØªÙ…Ø¯</p>
                        <div class="contact-details">
                            <div class="contact-item"><i class="fas fa-envelope"></i> {{ req.assigned_employee.email }}</div>
                            {% if req.assigned_employee.phone %}<div class="contact-item"><i class="fas fa-phone"></i> {{ req.assigned_employee.phone }}</div>{% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-profile">
                        <div class="icon">â³</div>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ¹ÙŠÙŠÙ† Ù…ÙˆØ¸Ù...</p>
                    </div>
                    {% endif %}
                {% else %}
                    {# Employee viewing Client #}
                    <div class="card-header-sm">ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
                    <div class="profile-info">
                        <div class="avatar lg">{{ client_name_safe|first }}</div>
                        <h3>{{ client_name_safe }}</h3>
                        <p class="role">Ø§Ù„Ø¹Ù…ÙŠÙ„</p>
                        <div class="contact-details">
                            <div class="contact-item"><i class="fas fa-envelope"></i> {{ client_email_safe }}</div>
                            <div class="contact-item"><i class="fas fa-phone"></i> {{ client_phone_safe }}</div>
                        </div>
                    </div>
                {% endif %}
            </div>

            {# --- Countdown Timer --- #}
            {% if req.status == 'in_progress' and req.agreement %}
            <div class="card timer-card">
                <div class="timer-icon">â°</div>
                <div class="timer-content">
                    <span class="label">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span>
                    <span class="value {% if req.agreement.days_remaining < 3 %}danger{% endif %}">
                        {{ req.agreement.days_remaining }} ÙŠÙˆÙ…
                    </span>
                </div>
            </div>
            {% endif %}

            {# --- Admin Actions --- #}
            {% if request.user.is_staff or request.user.role == 'admin' %}
            <div class="card actions-card" style="border-color: #f59e0b;">
                <div class="card-header-sm" style="color: #b45309;">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
                <div class="actions-list">
                    
                    {# 1. Move to In Progress #}
                    {% if req.status != 'in_progress' and req.status != 'completed' and req.status != 'cancelled' %}
                    <form method="post" action="{% url 'marketplace:request_change_status' req.pk %}">
                        {% csrf_token %}
                        <input type="hidden" name="status" value="in_progress">
                        <button type="submit" class="action-btn" style="width:100%; text-align:right; justify-content:flex-start; border:none; cursor:pointer;">
                            <span>â–¶ï¸</span> ØªØ­ÙˆÙŠÙ„ Ù„Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
                        </button>
                    </form>
                    {% endif %}

                    {# 2. Reassign #}
                    <a href="{% url 'marketplace:admin_request_reassign' req.pk %}" class="action-btn">
                        <span>ğŸ”„</span> Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø³Ù†Ø§Ø¯
                    </a>

                    {# 3. Cancel #}
                    {% if req.status != 'cancelled' %}
                    <a href="{% url 'marketplace:request_cancel' req.pk %}" class="action-btn danger" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')">
                        <span>ğŸš«</span> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨
                    </a>
                    {% endif %}

                    {# 4. Delete #}
                    <a href="{% url 'marketplace:admin_request_delete' req.pk %}" class="action-btn danger" onclick="return confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')">
                        <span>ğŸ—‘ï¸</span> Ø´Ø·Ø¨ Ù†Ù‡Ø§Ø¦ÙŠ
                    </a>

                </div>
            </div>
            {% endif %}

            {# --- Quick Actions --- #}
            <div class="card actions-card">
                <div class="card-header-sm">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</div>
                <div class="actions-list">
                    {% if can_create_agreement and not req.agreement %}
                        <a href="{% url 'agreements:open_by_request' req.pk %}" class="action-btn primary">
                            <span>ğŸ“</span> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©
                        </a>
                    {% endif %}

                    {% if req.agreement %}
                        <a href="{% url 'agreements:detail' req.agreement.pk %}" class="action-btn">
                            <span>ğŸ“œ</span> Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø¯
                        </a>
                    {% endif %}
                    
                    {% if req.status == 'in_progress' %}
                        {% if request.user.id == req.client_id or request.user.id == req.assigned_employee_id %}
                        <a href="{% url 'disputes:open_by_request' req.pk %}" class="action-btn danger">
                            <span>âš–ï¸</span> ÙØªØ­ Ù†Ø²Ø§Ø¹
                        </a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

        </div>

    </div>
</div>

<style>
    /* --- Workspace Variables --- */
    :root {
        --ws-bg: var(--surface-alt, #f8fafc);
        --ws-card: var(--surface, #ffffff);
        --ws-primary: var(--primary-600, #16a34a);
        --ws-primary-soft: var(--primary-100, #dcfce7);
        --ws-text: var(--dark-900, #0f172a);
        --ws-text-light: var(--dark-500, #64748b);
        --ws-border: var(--dark-200, #e2e8f0);
        --ws-radius: var(--radius-md, 0.75rem);
        --ws-shadow: var(--shadow-sm, 0 1px 2px 0 rgb(0 0 0 / 0.05));
    }

    /* --- Layout --- */
    .project-workspace {
        background: var(--ws-bg);
        min-height: 100vh;
        padding-bottom: 3rem;
        font-family: 'Tajawal', sans-serif;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1.5rem;
    }

    .main-layout {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 1.5rem;
        margin-top: -2rem; /* Overlap header */
    }

    /* --- Header --- */
    .workspace-header {
        background: #16a34a;
        background: linear-gradient(135deg, var(--ws-primary), #064e3b);
        color: white;
        padding: 3rem 0 5rem;
    }

    .workspace-header .project-title {
        color: #ffffff !important;
    }

    .workspace-header .project-meta, 
    .workspace-header .status-label,
    .workspace-header .id-badge {
        color: #ffffff !important;
    }
    
    .workspace-header .project-meta i {
        color: rgba(255, 255, 255, 0.8) !important;
    }

    .workspace-header .meta-item {
        color: #ffffff !important;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .project-identity .id-badge {
        background: rgba(255,255,255,0.1);
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        margin-bottom: 0.75rem;
    }

    .project-title {
        font-size: 1.75rem;
        font-weight: 800;
        margin: 0 0 1rem;
        line-height: 1.3;
    }

    .project-meta {
        display: flex;
        gap: 1.5rem;
        font-size: 0.9rem;
        color: #ffffff !important;
    }

    .status-box {
        text-align: center;
    }
    .status-label { font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.5rem; }
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.9rem;
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(4px);
    }
    .status-badge.in_progress { background: #3b82f6; color: white; }
    .status-badge.completed { background: var(--primary-500, #22c55e); color: white; }
    .status-badge.new { background: var(--secondary-500, #f59e0b); color: white; }

    /* --- Cards --- */
    .card {
        background: var(--ws-card);
        border-radius: var(--ws-radius);
        box-shadow: var(--ws-shadow);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--ws-border);
    }

    .card-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin: 0 0 1rem;
        color: var(--ws-text);
        border-bottom: 1px solid var(--ws-border);
        padding-bottom: 0.75rem;
    }

    /* --- Stepper --- */
    .stepper {
        display: flex;
        justify-content: space-between;
        position: relative;
    }
    .stepper::before {
        content: ''; position: absolute; top: 20px; left: 0; right: 0; height: 2px; background: #e5e7eb; z-index: 0;
    }
    .step {
        position: relative; z-index: 1; background: var(--ws-card); padding: 0 1rem; text-align: center;
        opacity: 0.5; transition: all 0.3s;
    }
    .step.active { opacity: 1; }
    .step-icon {
        width: 40px; height: 40px; background: #f3f4f6; border-radius: 50%;
        display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem;
        border: 2px solid #e5e7eb; color: #6b7280;
    }
    .step.active .step-icon {
        background: var(--ws-primary); border-color: var(--ws-primary); color: white;
    }
    .step-label { font-size: 0.85rem; font-weight: 600; color: var(--ws-text-light); }
    .step.active .step-label { color: var(--ws-primary); font-weight: 700; }

    /* --- Tabs --- */
    .tabs-nav {
        display: flex; gap: 0.5rem; margin-bottom: 1.5rem; overflow-x: auto; padding-bottom: 0.5rem;
    }
    .tab-btn {
        background: transparent; border: none; padding: 0.75rem 1.25rem;
        font-family: inherit; font-weight: 600; color: var(--ws-text-light);
        cursor: pointer; border-radius: 8px; transition: all 0.2s; white-space: nowrap;
    }
    .tab-btn.active {
        background: var(--ws-card); color: var(--ws-primary); box-shadow: var(--ws-shadow);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* --- Chat --- */
    .chat-card { padding: 0; overflow: hidden; display: flex; flex-direction: column; height: 600px; }
    .chat-header {
        padding: 1rem 1.5rem; border-bottom: 1px solid var(--ws-border); background: #f9fafb;
        display: flex; justify-content: space-between; align-items: center;
    }
    .chat-header h3 { margin: 0; font-size: 1rem; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 1.5rem; background: #f9fafb; }
    
    .message { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
    .message.outgoing { flex-direction: row-reverse; }
    .msg-avatar {
        width: 36px; height: 36px; background: #e5e7eb; border-radius: 50%;
        display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem;
    }
    .message.outgoing .msg-avatar { background: var(--ws-primary-soft); color: var(--ws-primary); }
    
    .msg-bubble {
        max-width: 70%; background: white; padding: 1rem; border-radius: 12px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative;
    }
    .message.outgoing .msg-bubble { background: var(--ws-primary); color: white; }
    .message.outgoing .msg-author { color: rgba(255,255,255,0.9); }
    .message.outgoing .msg-time { color: rgba(255,255,255,0.7); }
    .message.outgoing .msg-file { color: white; background: rgba(255,255,255,0.2); }

    .msg-author { font-size: 0.75rem; font-weight: 700; margin-bottom: 0.25rem; color: var(--ws-text-light); }
    .msg-text { font-size: 0.95rem; line-height: 1.5; }
    .msg-time { font-size: 0.7rem; color: #9ca3af; margin-top: 0.5rem; text-align: left; }
    .msg-file {
        display: block; margin-top: 0.5rem; padding: 0.5rem; background: #f3f4f6;
        border-radius: 6px; text-decoration: none; font-size: 0.85rem; color: var(--ws-text);
    }

    .chat-input-area { padding: 1rem; background: white; border-top: 1px solid var(--ws-border); }
    .chat-form { display: flex; gap: 0.75rem; }
    .input-wrapper {
        flex: 1; position: relative; border: 1px solid var(--ws-border); border-radius: 24px;
        padding: 0.5rem 1rem; display: flex; align-items: center; background: #f9fafb;
    }
    .input-wrapper textarea {
        flex: 1; border: none; background: transparent; resize: none; height: 24px;
        font-family: inherit; outline: none; padding: 0;
    }
    .file-btn { cursor: pointer; font-size: 1.2rem; color: #6b7280; padding: 0 0.5rem; }
    .hidden-input { display: none; }
    .send-btn {
        background: var(--ws-primary); color: white; border: none; width: 44px; height: 44px;
        border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
        transition: transform 0.2s;
    }
    .send-btn:hover { transform: scale(1.05); }

    /* --- Sidebar --- */
    .profile-card { text-align: center; }
    .card-header-sm {
        font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px;
        color: var(--ws-text-light); margin-bottom: 1rem; font-weight: 700;
    }
    .avatar.lg {
        width: 80px; height: 80px; background: #f3f4f6; border-radius: 50%;
        margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center;
        font-size: 2rem; color: #9ca3af;
    }
    .profile-info h3 { margin: 0 0 0.25rem; font-size: 1.1rem; }
    .profile-info .role { color: var(--ws-text-light); font-size: 0.9rem; margin: 0; }
    
    .contact-details { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--ws-border); text-align: right; }
    .contact-item { font-size: 0.85rem; color: var(--ws-text); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; justify-content: center; }
    .contact-item i { color: var(--ws-text-light); width: 16px; }

    .timer-card {
        background: #1e293b; color: white; display: flex; align-items: center; gap: 1rem;
    }
    .timer-icon { font-size: 2rem; }
    .timer-content { display: flex; flex-direction: column; }
    .timer-content .label { font-size: 0.8rem; opacity: 0.7; }
    .timer-content .value { font-size: 1.2rem; font-weight: 700; color: #38bdf8; }
    .timer-content .value.danger { color: #f87171; }

    .action-btn {
        display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem;
        background: #f9fafb; border-radius: 8px; text-decoration: none;
        color: var(--ws-text); font-weight: 600; margin-bottom: 0.5rem;
        transition: all 0.2s;
    }
    .action-btn:hover { background: #e5e7eb; }
    .action-btn.danger { color: #dc2626; background: #fef2f2; }
    .action-btn.danger:hover { background: #fee2e2; }

    /* --- Responsive --- */
    @media (max-width: 900px) {
        .main-layout { grid-template-columns: 1fr; }
        .sidebar-column { order: -1; }
    }
    
    /* --- Utilities --- */
    .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .btn-sm { padding: 0.4rem 0.8rem; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 0.85rem; text-decoration: none; display: inline-block; }
    .btn-sm.primary { background: var(--ws-primary); color: white; }
    .btn-sm.outline { border: 1px solid var(--ws-border); background: white; color: var(--ws-text); }
    .btn-block { width: 100%; padding: 0.75rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }
    .btn-block.primary { background: var(--ws-primary); color: white; }

    .modern-table { width: 100%; border-collapse: collapse; }
    .modern-table th { text-align: right; padding: 0.75rem; background: #f9fafb; font-size: 0.85rem; color: var(--ws-text-light); }
    .modern-table td { padding: 0.75rem; border-bottom: 1px solid var(--ws-border); }
    .status-pill { padding: 0.25rem 0.6rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
    .status-pill.success { background: #dcfce7; color: #166534; }
    .status-pill.warning { background: #fef3c7; color: #92400e; }

    /* --- Highlight Card --- */
    .action-card-highlight {
        background: linear-gradient(135deg, var(--ws-primary) 0%, #15803d 100%);
        color: white;
        text-align: center;
        border: none;
        position: relative;
        overflow: hidden;
    }
    .action-card-highlight h3 { color: white; margin-bottom: 0.5rem; font-size: 1.25rem; }
    .action-card-highlight p { color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-bottom: 1.5rem; }
    .action-icon-wrapper {
        width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%;
        display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;
        backdrop-filter: blur(4px);
    }
    .action-icon { font-size: 1.75rem; }
    .pulse-btn {
        background: white; color: var(--ws-primary); animation: pulse 2s infinite;
        box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7);
    }
    @keyframes pulse {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
    }

    /* --- Modal --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
        backdrop-filter: blur(4px);
    }
    .modal-content {
        background: white; width: 90%; max-width: 500px; border-radius: 16px;
        padding: 2rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .modal-header h3 { margin: 0; font-size: 1.25rem; font-weight: 700; }
    .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; }
    
    .form-group { margin-bottom: 1.25rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; color: var(--ws-text); }
    .form-group input, .form-group textarea {
        width: 100%; padding: 0.75rem; border: 1px solid var(--ws-border); border-radius: 8px;
        font-family: inherit; font-size: 0.95rem; transition: border-color 0.2s;
    }
    .form-group input:focus, .form-group textarea:focus {
        outline: none; border-color: var(--ws-primary); box-shadow: 0 0 0 3px var(--ws-primary-soft);
    }

    /* --- Offer Highlights --- */
    .offer-highlights {
        display: flex; gap: 1rem; margin: 1rem 0;
        background: #f8fafc; padding: 0.75rem; border-radius: 8px;
    }
    .highlight-item { flex: 1; text-align: center; }
    .highlight-item .label { display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem; }
    .highlight-item .value { font-weight: 700; color: #0f172a; font-size: 1.1rem; }
    .highlight-item.price .value { color: var(--ws-primary); }
    
    .read-more-link {
        display: inline-block; margin-top: 0.5rem; font-size: 0.85rem;
        color: var(--ws-primary); font-weight: 600; text-decoration: none;
    }
    .read-more-link:hover { text-decoration: underline; }
</style>

<script>
    function switchTab(tabId) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        // Show selected
        document.getElementById('tab-' + tabId).classList.add('active');
        event.target.classList.add('active');
    }
    
    // Auto-scroll chat to bottom
    window.onload = function() {
        var chatBox = document.getElementById('chatBox');
        if(chatBox) chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

{# --- Deliver Milestone Modal --- #}
<div id="deliverMilestoneModal" class="modal-overlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;">
  <div class="modal-content" style="background:white;padding:2rem;border-radius:16px;width:90%;max-width:500px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);">
    <h3 style="margin-top:0;margin-bottom:1rem;color:#0f172a;">ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø±Ø­Ù„Ø©: <span id="deliverMilestoneTitle"></span></h3>
    <form id="deliverMilestoneForm" method="post" action="">
      {% csrf_token %}
      <div style="margin-bottom:1.5rem;">
        <label style="display:block;margin-bottom:0.5rem;font-weight:600;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
        <textarea name="note" style="width:100%;padding:0.75rem;border:1px solid #e2e8f0;border-radius:8px;min-height:100px;" placeholder="Ø£Ø¶Ù Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ù…Ù„ Ø£Ùˆ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù‡Ù†Ø§..."></textarea>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:1rem;">
        <button type="button" class="btn-sm outline" onclick="document.getElementById('deliverMilestoneModal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="submit" class="btn-sm primary">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
      </div>
    </form>
  </div>
</div>

{# --- Reject Milestone Modal --- #}
<div id="rejectMilestoneModal" class="modal-overlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;">
  <div class="modal-content" style="background:white;padding:2rem;border-radius:16px;width:90%;max-width:500px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);">
    <h3 style="margin-top:0;margin-bottom:1rem;color:#991b1b;">Ø±ÙØ¶ Ø§Ù„Ù…Ø±Ø­Ù„Ø©: <span id="rejectMilestoneTitle"></span></h3>
    <form id="rejectMilestoneForm" method="post" action="">
      {% csrf_token %}
      <input type="hidden" name="action" value="reject">
      <div style="margin-bottom:1.5rem;">
        <label style="display:block;margin-bottom:0.5rem;font-weight:600;">Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ù…Ø·Ù„ÙˆØ¨):</label>
        <textarea name="reason" required style="width:100%;padding:0.75rem;border:1px solid #e2e8f0;border-radius:8px;min-height:100px;" placeholder="ÙŠØ±Ø¬Ù‰ ØªÙˆØ¶ÙŠØ­ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©..."></textarea>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:1rem;">
        <button type="button" class="btn-sm outline" onclick="document.getElementById('rejectMilestoneModal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="submit" class="btn-sm danger">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶</button>
      </div>
    </form>
  </div>
</div>

<script>
function openDeliverModal(pk, title) {
  {% if req.agreement %}
  document.getElementById('deliverMilestoneTitle').textContent = title;
  var url = "{% url 'agreements:milestone_deliver' req.agreement.pk 999999 %}".replace('999999', pk);
  document.getElementById('deliverMilestoneForm').action = url;
  document.getElementById('deliverMilestoneModal').style.display = 'flex';
  {% endif %}
}

function openRejectMilestoneModal(pk, title) {
  {% if req.agreement %}
  document.getElementById('rejectMilestoneTitle').textContent = title;
  var url = "{% url 'agreements:milestone_review' req.agreement.pk 999999 %}".replace('999999', pk);
  document.getElementById('rejectMilestoneForm').action = url;
  document.getElementById('rejectMilestoneModal').style.display = 'flex';
  {% endif %}
}
</script>
{% endblock %}
