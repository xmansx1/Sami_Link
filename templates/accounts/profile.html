{% extends "base.html" %}
{% if request.user.role == "client" %}
  <section class="profile-section">
    <h2 class="section-title">إحصائيات العميل</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-number">{{ client_requests_count }}</span>
        <span class="stat-label">عدد الطلبات</span>
      </div>
      <div class="stat-card">
        <span class="stat-number">{{ client_paid_total|floatformat:2 }}</span>
        <span class="stat-label">إجمالي المدفوع</span>
      </div>
    </div>
    <h3 class="section-title" style="margin-top:2rem;">آخر 3 طلبات</h3>
      {% if client_last_requests and client_last_requests|length > 0 %}
        <div class="last-request-box" style="margin-top:2rem;padding:1rem;background:#f8f9fa;border-radius:8px;box-shadow:0 1px 4px #eee;">
          <h3 style="margin-bottom:1rem;">آخر طلب</h3>
          {% with req=client_last_requests.0 %}
            <ul style="list-style:none;padding:0;">
              <li><strong>العنوان:</strong> {{ req.title }}</li>
              <li><strong>الحالة:</strong> {{ req.get_status_display }}</li>
              <li><strong>تاريخ الإنشاء:</strong> {{ req.created_at|date:"Y-m-d H:i" }}</li>
            </ul>
          {% endwith %}
        </div>
      {% else %}
        <div class="alert alert-info" style="margin-top:2rem;">لا توجد طلبات لهذا العميل.</div>
      {% endif %}
    <table class="table table-clean">
      <thead>
        <tr>
          <th>#</th>
          <th>العنوان</th>
          <th>الحالة</th>
          <th>تاريخ الإنشاء</th>
        </tr>
      </thead>
      <tbody>
        {% for req in client_last_requests %}
          <tr>
            <td>{{ req.id }}</td>
            <td>{{ req.title }}</td>
            <td>{{ req.get_status_display }}</td>
            <td>{{ req.created_at|date:"Y-m-d" }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4" class="text-center text-muted">لا توجد طلبات</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
{% endif %}
{% block title %}ملفي الشخصي{% endblock %}

{% block content %}
<div class="employee-profile">
  {% include "accounts/_messages.html" %}

  <!-- هيدر الملف الشخصي -->
  <div class="profile-header">
    <!-- الصورة / الأفاتار -->
    <div class="profile-avatar">
      {% if request.user.profile_picture %}
        <img src="{{ request.user.profile_picture.url }}" alt="صورة الملف الشخصي">
      {% else %}
        <div class="profile-avatar-placeholder" style="display:flex;align-items:center;justify-content:center;font-size:2rem;background:var(--primary-100);color:var(--primary-700);width:100%;height:100%;">
          <span style="font-size:2.2rem;">{{ request.user.name|default:request.user.email|slice:':1'|upper }}</span>
        </div>
      {% endif %}
    </div>

    <!-- معلومات أساسية -->
    <div class="profile-info">
      <h1 class="profile-name">
        {{ request.user.name|default:request.user.email }}
      </h1>

      <div class="profile-title">
        {{ request.user.get_role_display|default:request.user.role|title }}
      </div>

      <div class="profile-location">
        <span class="meta-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M4 4h16v16H4z" stroke="currentColor" stroke-width="2" />
            <path d="M4 7l8 5 8-5" stroke="currentColor" stroke-width="2" />
          </svg>
          <span>{{ request.user.email }}</span>
        </span>
        {% if request.user.phone %}
        <span class="meta-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M3 5a2 2 0 012-2h3.3a1 1 0 01.95.68l1.5 4.5a1 1 0 01-.5 1.2l-2.3 1.1a11 11 0 005.5 5.5l1.1-2.3a1 1 0 011.2-.5l4.5 1.5a1 1 0 01.7.95V19a2 2 0 01-2 2h-1C9.7 21 3 14.3 3 6V5z"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <span>{{ request.user.phone }}</span>
        </span>
        {% endif %}
      </div>

      <div class="profile-stats">
        <div class="profile-stat">
          <span class="stat-number">
            {{ request.user.date_joined|date:"Y-m-d" }}
          </span>
          <span class="stat-label">تاريخ الانضمام</span>
        </div>
        <div class="profile-stat">
          <span class="stat-number">
            {% if request.user.is_active %}مفعّل{% else %}غير مفعّل{% endif %}
          </span>
          <span class="stat-label">حالة الحساب</span>
        </div>
      </div>
    </div>

    <!-- أزرار الإجراءات -->
    <div class="profile-actions">
      <a href="{% url 'accounts:profile_edit' %}" class="btn btn-primary btn-sm">
        تعديل البيانات
      </a>
      <a href="{% url 'accounts:password_change' %}" class="btn btn-outline btn-sm">
        تغيير كلمة المرور
      </a>

      {% if request.user.phone and request.user.whatsapp_link %}
 
      {% endif %}
    </div>
  </div>

  <!-- قسم بيانات الحساب -->
  <section class="profile-section">
    <h2 class="section-title">بيانات الحساب</h2>

    <div class="project-meta">
      <div class="meta-item">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" />
          <path d="M5 21c0-3.3 3.1-6 7-6s7 2.7 7 6" stroke="currentColor" stroke-width="2" />
        </svg>
        <span>الاسم: {{ request.user.name|default:request.user.email }}</span>
      </div>
      <div class="meta-item">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M4 4h16v16H4z" stroke="currentColor" stroke-width="2" />
          <path d="M4 7l8 5 8-5" stroke="currentColor" stroke-width="2" />
        </svg>
        <span>البريد الإلكتروني: {{ request.user.email }}</span>
      </div>
      {% if request.user.phone %}
      <div class="meta-item">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M3 5a2 2 0 012-2h3.3a1 1 0 01.95.68l1.5 4.5a1 1 0 01-.5 1.2l-2.3 1.1a11 11 0 005.5 5.5l1.1-2.3a1 1 0 011.2-.5l4.5 1.5a1 1 0 01.7.95V19a2 2 0 01-2 2h-1C9.7 21 3 14.3 3 6V5z"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        <span>الجوال: {{ request.user.phone }}</span>
      </div>
      {% endif %}
      <div class="meta-item">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M5 4h14v2H5zM5 11h14v2H5zM5 18h14v2H5z"
                stroke="currentColor" stroke-width="2" />
        </svg>
        <span>الدور: {{ request.user.get_role_display|default:request.user.role|title }}</span>
      </div>
    </div>
  </section>

  <!-- قسم نظرة عامة / إحصائيات -->
  <section class="profile-section">
    <h2 class="section-title">نظرة عامة</h2>
    {% if request.user.role == "client" %}
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-number">{{ client_requests_count }}</span>
          <span class="stat-label">عدد الطلبات</span>
        </div>
        <div class="stat-card">
          <span class="stat-number">{{ client_paid_total|floatformat:2 }}</span>
          <span class="stat-label">إجمالي المدفوع</span>
        </div>
      </div>
      {% if client_last_requests and client_last_requests|length > 0 %}
        <div class="last-request-box" style="margin-top:2rem;padding:1rem;background:#f8f9fa;border-radius:8px;box-shadow:0 1px 4px #eee;">
          <h3 style="margin-bottom:1rem;">آخر طلب</h3>
          {% with req=client_last_requests.0 %}
            <ul style="list-style:none;padding:0;">
              <li><strong>العنوان:</strong> {{ req.title }}</li>
              <li><strong>الحالة:</strong> {{ req.get_status_display }}</li>
              <li><strong>تاريخ الإنشاء:</strong> {{ req.created_at|date:"Y-m-d H:i" }}</li>
            </ul>
          {% endwith %}
        </div>
      {% else %}
        <div class="alert alert-info" style="margin-top:2rem;">لا توجد طلبات لهذا العميل.</div>
      {% endif %}
    {% else %}
      <div class="text-slate-500 text-center py-4">لا توجد إحصائيات متاحة حاليًا لهذا الحساب.</div>
    {% endif %}
  </section>
</div>
{% endblock %}
