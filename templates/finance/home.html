{# finance/templates/finance/home.html #}
{% extends "base.html" %}
{% load humanize %}

{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©{% endblock %}

{% block content %}
<section class="page-section finance-dashboard" dir="rtl">
  <div class="container">

    {# ===== Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© ===== #}
    <div class="section-header" style="text-align:right; margin-bottom: 2rem;">
      <div class="section-badge">ğŸ’° Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>
      <h1 class="section-title">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h1>
      <p class="section-description">
        Ù†Ø¸Ø±Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„ØªØ­ØµÙŠÙ„ØŒ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨ØŒ Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµÙ‘Ø©ØŒ Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†ØŒ ÙˆØ§Ù„Ù†Ø²Ø§Ø¹Ø§Øª â€” Ù…Ø¹ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø®Ø²ÙŠÙ†Ø© Ù„Ø­Ø¸ÙŠÙ‹Ø§.
      </p>
    </div>

    {# ===== Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙØ­Ø§Øª (Ø¢Ù…Ù†Ø©) ===== #}
    {% url 'finance:invoice_list' as invoices_url %}
    {% url 'finance:confirm_transfers' as confirm_transfers_url %}
    {% url 'finance:collections_report' as collections_url %}
    {% url 'finance:client_payments' as client_payments_url %}
    {% url 'finance:employee_dues' as employee_dues_url %}
    {% url 'finance:employee_dues_admin' as employee_dues_admin_url %}
    {% url 'finance:tax_dashboard' as tax_url %}
    {% url 'finance:inprogress_requests' as inprogress_url %}
    {% url 'finance:payouts_list' as payouts_url %}
    {% url 'finance:refunds_dashboard' as refunds_url %}
    {% url 'finance:disputes_dashboard' as disputes_url %}
    {% url 'finance:settings' as settings_fallback_url %}

    {% with settings_link=settings_url|default:settings_fallback_url %}

    {# ===== Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© ===== #}
    <div class="profile-section" style="margin-bottom: 2rem;">
      <div class="card-section-title">âš¡ Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©</div>

      <div class="quick-actions-grid"
           style="display:grid; grid-template-columns:repeat(auto-fit,minmax(190px,1fr)); gap:1rem; margin-top:1rem;">

        <a href="{{ invoices_url }}" class="quick-action profile-section">
          <div class="quick-icon">ğŸ“„</div>
          <div class="quick-text">ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div>
        </a>

        <a href="{{ invoices_url }}?status=paid" class="quick-action profile-section">
          <div class="quick-icon">âœ…</div>
          <div class="quick-text">ÙÙˆØ§ØªÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©</div>
        </a>

        <a href="{{ invoices_url }}?status=unpaid" class="quick-action profile-section">
          <div class="quick-icon">â³</div>
          <div class="quick-text">ÙÙˆØ§ØªÙŠØ± ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©</div>
        </a>

        <a href="{{ inprogress_url }}" class="quick-action profile-section">
          <div class="quick-icon">ğŸ”„</div>
          <div class="quick-text">Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
        </a>

        <a href="{{ confirm_transfers_url }}" class="quick-action profile-section">
          <div class="quick-icon">ğŸ“¤</div>
          <div class="quick-text">ØªØ£ÙƒÙŠØ¯ ØªØ­ÙˆÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        </a>

        <a href="{{ employee_dues_admin_url }}" class="quick-action profile-section">
          <div class="quick-icon">ğŸ’¸</div>
          <div class="quick-text">Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
        </a>

        <a href="{{ refunds_url }}" class="quick-action profile-section">
          <div class="quick-icon">â†©ï¸</div>
          <div class="quick-text">Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        </a>

        <a href="{{ tax_url }}" class="quick-action profile-section">
          <div class="quick-icon">ğŸ§¾</div>
          <div class="quick-text">Ù„ÙˆØ­Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© VAT</div>
        </a>

        <a href="{{ disputes_url }}" class="quick-action profile-section">
          <div class="quick-icon">âš–ï¸</div>
          <div class="quick-text">Ø§Ù„Ù†Ø²Ø§Ø¹Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div>
        </a>

        <a href="{{ collections_url }}" class="quick-action profile-section">
          <div class="quick-icon">ğŸ“Š</div>
          <div class="quick-text">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­ØµÙŠÙ„</div>
        </a>

        <a href="{{ client_payments_url }}" class="quick-action profile-section">
          <div class="quick-icon">ğŸ‘¥</div>
          <div class="quick-text">Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        </a>

        <a href="{{ settings_link }}" class="quick-action profile-section"
           style="background:linear-gradient(135deg,var(--primary-50) 0%,var(--white) 100%);">
          <div class="quick-icon">âš™ï¸</div>
          <div class="quick-text">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ù‘ÙØ³ÙØ¨</div>
        </a>

      </div>
    </div>

    {# ===== Ø¨Ø·Ø§Ù‚Ø§Øª KPIs ===== #}
    <div class="kpi-grid"
         style="display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:1.25rem; margin-bottom:2rem;">

      {# Ø±ØµÙŠØ¯ Ø§Ù„Ø®Ø²ÙŠÙ†Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù…Ù† Ø§Ù„Ù€view) #}
      <div class="profile-section kpi-card"
           style="background:linear-gradient(135deg,#ecfeff 0%,var(--white) 100%);">
        <div class="kpi-header">
          <div class="kpi-icon" style="background:#cffafe;color:#0e7490;">ğŸ¦</div>
          <div class="kpi-info">
            <div class="kpi-title">Ø±ØµÙŠØ¯ Ø§Ù„Ø®Ø²ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
            <div class="kpi-subtitle">ØµØ§ÙÙŠ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© = ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ âˆ’ ØµØ±Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† âˆ’ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª âˆ’ ØªÙˆØ±ÙŠØ¯ VAT</div>
          </div>
        </div>
        <div class="kpi-value" style="color:#0e7490;">
          {{ treasury_balance|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„
        </div>
      </div>


      {# Ø¶Ø±ÙŠØ¨Ø© ØºÙŠØ± Ù…ÙˆØ±Ù‘Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù…Ù† Ø§Ù„Ù€view) #}
      <div class="profile-section kpi-card"
           style="background:linear-gradient(135deg,#fff7ed 0%,var(--white) 100%);">
        <div class="kpi-header">
          <div class="kpi-icon" style="background:#ffedd5;color:#9a3412;">ğŸ§¾</div>
          <div class="kpi-info">
            <div class="kpi-title">VAT ØºÙŠØ± Ù…ÙˆØ±Ù‘Ø¯Ø©</div>
            <div class="kpi-subtitle">VAT Ù…Ø­ØµÙ‘Ù„Ø© Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆÙ„Ù… ØªÙÙˆØ±Ù‘ÙØ¯ Ø¨Ø¹Ø¯</div>
          </div>
        </div>
        <div class="kpi-value" style="color:#9a3412;">
          {{ vat_payable|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„
        </div>
      </div>

      {# Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° #}
      <div class="profile-section kpi-card">
        <div class="kpi-header">
          <div class="kpi-icon">ğŸ”„</div>
          <div class="kpi-info">
            <div class="kpi-title">Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
            <div class="kpi-subtitle">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹</div>
          </div>
        </div>
        <div class="kpi-value">{{ inprogress_count|default:"0" }}</div>
      </div>

      {# Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§ØªÙØ§Ù‚ÙŠØ§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° #}
      <div class="profile-section kpi-card">
        <div class="kpi-header">
          <div class="kpi-icon">ğŸ“Œ</div>
          <div class="kpi-info">
            <div class="kpi-title">Ø§ØªÙØ§Ù‚ÙŠØ§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
            <div class="kpi-subtitle">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ©</div>
          </div>
        </div>
        <div class="kpi-value">
          {{ total_agreements_amount|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„
        </div>
      </div>

      {# Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ #}
      <div class="profile-section kpi-card"
           style="background:linear-gradient(135deg,var(--primary-50) 0%,var(--white) 100%);">
        <div class="kpi-header">
          <div class="kpi-icon">âœ…</div>
          <div class="kpi-info">
            <div class="kpi-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø§ Ø¯ÙØ¹Ù‡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
            <div class="kpi-subtitle">ÙÙˆØ§ØªÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø© (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ = P + VAT)</div>
          </div>
        </div>
        <div class="kpi-value" style="color:var(--primary-600);">
          {{ paid_sum|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„
        </div>
      </div>

      {# ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ #}
      <div class="profile-section kpi-card"
           style="background:linear-gradient(135deg,var(--secondary-50) 0%,var(--white) 100%);">
        <div class="kpi-header">
          <div class="kpi-icon">â³</div>
          <div class="kpi-info">
            <div class="kpi-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</div>
            <div class="kpi-subtitle">ÙÙˆØ§ØªÙŠØ± Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø¯Ø§Ø¯</div>
          </div>
        </div>
        <div class="kpi-value" style="color:var(--secondary-600);">
          {{ unpaid_sum|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„
        </div>
      </div>

      {# Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ© #}
      <div class="profile-section kpi-card">
        <div class="kpi-header">
          <div class="kpi-icon">ğŸ·ï¸</div>
          <div class="kpi-info">
            <div class="kpi-title">Ø¯Ø®Ù„ Ø§Ù„Ù…Ù†ØµÙ‘Ø© (Ø¹Ù…ÙˆÙ„Ø©)</div>
            <div class="kpi-subtitle">ØªÙØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…ÙˆØ¸Ù ÙÙ‚Ø· â€” Ù„Ø§ ÙŠØªØ­Ù…Ù„Ù‡Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
          </div>
        </div>
        <div class="kpi-value">
          {{ platform_fee_total|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„
        </div>
      </div>

      {# VAT Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© #}
      <div class="profile-section kpi-card">
        <div class="kpi-header">
          <div class="kpi-icon">ğŸ§¾</div>
          <div class="kpi-info">
            <div class="kpi-title">VAT Ù…Ø­ØµÙ‘Ù„Ø©</div>
            <div class="kpi-subtitle">VAT Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø¯Ù…Ø© P ÙÙ‚Ø·</div>
          </div>
        </div>
        <div class="kpi-value">
          {{ vat_total|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„
        </div>
      </div>

      {# âœ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© (ØµØ§ÙÙŠ) Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ø­Ø§Ù„Ø© #}
      <div class="profile-section kpi-card"
           style="background:linear-gradient(135deg,#f8fafc 0%,var(--white) 100%);">
        <div class="kpi-header">
          <div class="kpi-icon" style="background:#e2e8f0;color:#0f172a;">ğŸ‘·</div>
          <div class="kpi-info">
            <div class="kpi-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© (ØµØ§ÙÙŠ)</div>
            <div class="kpi-subtitle">ÙŠØ´Ù…Ù„ Ø§Ù„Ù…Ø¤Ù‡Ù„ + Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± + Ø§Ù„Ù…Ø¬Ù…Ù‘Ø¯ Ø·Ø§Ù„Ù…Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµØ±Ù</div>
          </div>
        </div>
        <div class="kpi-value">
          {{ employee_unpaid_net_all|default:employee_unpaid_net|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„
        </div>
      </div>

      {# Ù…Ø³ØªØ­Ù‚Ø§Øª Ù…Ø¬Ù…Ù‘Ø¯Ø© Ø¨Ø³Ø¨Ø¨ Ù†Ø²Ø§Ø¹ #}
      <div class="profile-section kpi-card"
           style="background:linear-gradient(135deg,#fef2f2 0%,var(--white) 100%);">
        <div class="kpi-header">
          <div class="kpi-icon" style="background:#fee2e2;color:#b91c1c;">ğŸš«</div>
          <div class="kpi-info">
            <div class="kpi-title">Ù…Ø³ØªØ­Ù‚Ø§Øª Ù…Ø¬Ù…Ù‘Ø¯Ø© (Ù†Ø²Ø§Ø¹)</div>
            <div class="kpi-subtitle">ØµØ§ÙÙŠ Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø¬Ù…Ø¯ = P âˆ’ Fee</div>
          </div>
        </div>
        <div class="kpi-value" style="color:#ef4444;">
          {{ disputed_total|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„
        </div>
      </div>

      {# Ø£ÙˆØ§Ù…Ø± ØµØ±Ù Ù…Ø¯ÙÙˆØ¹Ø© #}
      <div class="profile-section kpi-card">
        <div class="kpi-header">
          <div class="kpi-icon">ğŸ’¸</div>
          <div class="kpi-info">
            <div class="kpi-title">Ù…Ø³ØªØ­Ù‚Ø§Øª Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø¯ÙÙˆØ¹Ø©</div>
            <div class="kpi-subtitle">Ù…Ø¬Ù…ÙˆØ¹ Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</div>
          </div>
        </div>
        <div class="kpi-value">
          {{ employee_dues_total|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„
        </div>
      </div>

      {# Ø£ÙˆØ§Ù…Ø± ØµØ±Ù Ù…Ø¹Ù„Ù‘Ù‚Ø© #}
      <div class="profile-section kpi-card">
        <div class="kpi-header">
          <div class="kpi-icon">ğŸ“</div>
          <div class="kpi-info">
            <div class="kpi-title">Ø£ÙˆØ§Ù…Ø± ØµØ±Ù Ù…Ø¹Ù„Ù‘Ù‚Ø©</div>
            <div class="kpi-subtitle">Ù‚ÙŠÙ…Ø© Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØµØ±Ù Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø¯Ø§Ø¯</div>
          </div>
        </div>
        <div class="kpi-value">
          {{ employee_unpaid_total|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„
        </div>
      </div>

    </div>

    {# ===== Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ===== #}
    <div class="tables-grid"
         style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; margin-bottom:2rem;">

      {# Ø£ÙˆØ§Ù…Ø± ØµØ±Ù ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø© #}
      <div class="profile-section data-card">
        <div class="data-card-header"
             style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
          <h3 class="card-section-title">ğŸ“ Ø£ÙˆØ§Ù…Ø± ØµØ±Ù Ù…Ø¹Ù„Ù‘Ù‚Ø©</h3>
          <a href="{{ payouts_url }}" class="btn btn-outline btn-sm">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
        </div>

        <div class="table-wrapper">
          <table class="table table-clean">
            <thead>
              <tr>
                <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              </tr>
            </thead>
            <tbody>
              {% for payout in payouts_unpaid %}
                <tr class="scroll-reveal">
                  <td>{{ payout.employee }}</td>
                  <td class="value-strong">{{ payout.amount|floatformat:2 }} Ø±ÙŠØ§Ù„</td>
                  <td class="text-muted">{{ payout.issued_at|date:"Y-m-d" }}</td>
                  <td><span class="badge badge-pending">{{ payout.get_status_display }}</span></td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted" style="padding:2rem;">
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ§Ù…Ø± ØµØ±Ù Ù…Ø¹Ù„Ù‘Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      {# Ø§Ù„Ù†Ø²Ø§Ø¹Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© #}
      <div class="profile-section data-card">
        <div class="data-card-header"
             style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
          <h3 class="card-section-title">âš–ï¸ Ø§Ù„Ù†Ø²Ø§Ø¹Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h3>
          <a href="{{ disputes_url }}" class="btn btn-outline btn-sm">Ù„ÙˆØ­Ø© Ø§Ù„Ù†Ø²Ø§Ø¹Ø§Øª</a>
        </div>

        <div class="table-wrapper">
          <table class="table table-clean">
            <thead>
              <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                <th>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ø²Ø§Ø¹</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
              </tr>
            </thead>
            <tbody>
              {% for dispute in disputes_active %}
                <tr class="scroll-reveal">
                  <td>
                    <a class="link" href="{% url 'marketplace:request_detail' dispute.request.pk %}">
                      #{{ dispute.request.pk }}
                    </a>
                  </td>
                  <td>{{ dispute.title|default:"Ù†Ø²Ø§Ø¹" }}</td>
                  <td><span class="badge badge-default">{{ dispute.get_status_display }}</span></td>
                  <td>
                    {% if dispute.invoice %}
                      <a class="link" href="{% url 'finance:invoice_detail' dispute.invoice.pk %}">
                        ÙØ§ØªÙˆØ±Ø© #{{ dispute.invoice.pk }}
                      </a>
                    {% else %}
                      <span class="text-muted">â€”</span>
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted" style="padding:2rem;">
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø²Ø§Ø¹Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>

    {# ===== Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ ===== #}
    <div class="profile-section data-card" style="margin-bottom:2rem;">
      <div class="data-card-header"
           style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
        <h3 class="card-section-title">ğŸ“¤ ØªØ­ÙˆÙŠÙ„Ø§Øª Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÙƒÙŠØ¯ Ù…Ø§Ù„ÙŠ</h3>
        <a href="{{ confirm_transfers_url }}" class="btn btn-outline btn-sm">ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯</a>
      </div>

      <div class="table-wrapper">
        <table class="table table-clean">
          <thead>
            <tr>
              <th>ÙØ§ØªÙˆØ±Ø©</th>
              <th>Ø·Ù„Ø¨</th>
              <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
              <th>Ù…Ø±Ø¬Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody>
            {% for inv in pending_bank_confirms %}
              <tr class="scroll-reveal">
                <td class="text-muted">#{{ inv.id }}</td>
                <td>R{{ inv.agreement.request_id }}</td>
                <td class="value-strong">
                  {% if inv.client_total_amount %}
                    {{ inv.client_total_amount|floatformat:2 }}
                  {% else %}
                    {{ inv.amount|default:"0"|floatformat:2 }}
                  {% endif %}
                  Ø±ÙŠØ§Ù„
                </td>
                <td><span class="badge badge-default">{{ inv.paid_ref|default:"â€”" }}</span></td>
                <td>
                  <a href="{% url 'finance:invoice_detail' inv.id %}" class="btn btn-outline btn-sm">ØªÙØ§ØµÙŠÙ„</a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted" style="padding:2rem;">
                  <div class="text-4xl mb-2 opacity-40">ğŸ’¸</div>
                  Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­ÙˆÙŠÙ„Ø§Øª Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {# ===== Ù…ÙˆØ¬Ø² Ø³Ø±ÙŠØ¹ ===== #}
    <div class="profile-section" style="background:var(--dark-50);">
      <div class="card-section-title">ğŸ“Š Ù…ÙˆØ¬Ø² Ø³Ø±ÙŠØ¹</div>

      <div class="summary-grid"
           style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:1rem; margin-top:1rem;">

        <div class="summary-item profile-section">
          <div class="summary-label">Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
          <div class="summary-value" style="color:var(--primary-600);">
            {{ paid_sum|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„
          </div>
        </div>

        <div class="summary-item profile-section">
          <div class="summary-label">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</div>
          <div class="summary-value" style="color:var(--secondary-600);">
            {{ unpaid_sum|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„
          </div>
        </div>

        <div class="summary-item profile-section">
          <div class="summary-label">Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµÙ‘Ø©</div>
          <div class="summary-value">{{ platform_fee_total|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„</div>
        </div>

        <div class="summary-item profile-section">
          <div class="summary-label">VAT Ù…Ø­ØµÙ‘Ù„Ø©</div>
          <div class="summary-value">{{ vat_total|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„</div>
        </div>

        <div class="summary-item profile-section">
          <div class="summary-label">VAT ØºÙŠØ± Ù…ÙˆØ±Ù‘Ø¯Ø©</div>
          <div class="summary-value">{{ vat_payable|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„</div>
        </div>

        {# âœ… Ù†ÙØ³ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ù…ÙˆØ¬Ø² #}
        <div class="summary-item profile-section">
          <div class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³ØªØ­Ù‚Ø§Øª ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø© (ØµØ§ÙÙŠ)</div>
          <div class="summary-value">
            {{ employee_unpaid_net_all|default:employee_unpaid_net|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„
          </div>
        </div>

        <div class="summary-item profile-section">
          <div class="summary-label">Ù…Ø³ØªØ­Ù‚Ø§Øª Ù…Ø¯ÙÙˆØ¹Ø©</div>
          <div class="summary-value">{{ employee_dues_total|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„</div>
        </div>

        <div class="summary-item profile-section">
          <div class="summary-label">Ù…Ø¬Ù…Ù‘Ø¯ Ù†Ø²Ø§Ø¹</div>
          <div class="summary-value" style="color:#ef4444;">
            {{ disputed_total|default:"0"|floatformat:2 }} Ø±ÙŠØ§Ù„
          </div>
        </div>

      </div>

      <div class="card-section-note" style="margin-top:1rem; text-align:center;">
        âœ… Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© ØªÙØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…ÙˆØ¸Ù â€” VAT ØªÙØ­Ø³Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± P ÙÙ‚Ø· â€” Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ¯ÙØ¹ P + VAT ÙÙ‚Ø·.
      </div>
    </div>

    {% endwith %}
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script>
  (function () {
    if (typeof initScrollReveal === 'function') {
      initScrollReveal();
    }

    document.querySelectorAll('.profile-section').forEach((card, index) => {
      card.style.animationDelay = `${index * 0.06}s`;

      if (card.classList.contains('kpi-card') ||
          card.classList.contains('quick-action') ||
          card.classList.contains('summary-item')) {

        card.addEventListener('mouseenter', function() {
          this.style.transform = 'translateY(-4px)';
          this.style.boxShadow = 'var(--shadow-lg)';
        });

        card.addEventListener('mouseleave', function() {
          this.style.transform = 'translateY(0)';
          this.style.boxShadow = '';
        });
      }
    });

    document.querySelectorAll('.table-clean tbody tr').forEach(row => {
      row.addEventListener('mouseenter', function() {
        this.style.background = 'var(--primary-50)';
      });
      row.addEventListener('mouseleave', function() {
        this.style.background = '';
      });
    });

  })();
  </script>

  <style>
  .finance-dashboard .quick-action {
    text-decoration: none;
    text-align: center;
    padding: 1.25rem 1rem;
    border-radius: var(--radius-xl);
    transition: all 0.25s ease;
  }
  .finance-dashboard .quick-icon { font-size: 1.8rem; margin-bottom: .4rem; }
  .finance-dashboard .quick-text { font-weight: 700; color: var(--dark-700); font-size: .95rem; }

  .finance-dashboard .kpi-card {
    min-height: 140px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: all 0.25s ease;
  }
  .finance-dashboard .kpi-header {
    display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
  }
  .finance-dashboard .kpi-icon {
    width: 3rem; height: 3rem;
    background: var(--primary-100);
    color: var(--primary-600);
    border-radius: var(--radius-lg);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.45rem; flex-shrink: 0;
  }
  .finance-dashboard .kpi-title {
    font-weight: 700; color: var(--dark-800);
    margin-bottom: .25rem; font-size: .98rem;
  }
  .finance-dashboard .kpi-subtitle {
    color: var(--dark-500); font-size: .8rem; line-height: 1.45;
  }
  .finance-dashboard .kpi-value {
    font-size: 1.7rem; font-weight: 800; color: var(--dark-900);
    line-height: 1.2;
  }

  .finance-dashboard .data-card {
    min-height: 300px; display: flex; flex-direction: column;
  }
  .finance-dashboard .table-wrapper {
    overflow-x: auto; border-radius: var(--radius-lg);
    border: 1px solid var(--dark-200); flex: 1;
  }
  .finance-dashboard .table-clean {
    width: 100%; border-collapse: collapse;
  }
  .finance-dashboard .table-clean th {
    background: var(--dark-50);
    color: var(--dark-700);
    font-weight: 700;
    padding: 1rem; text-align: right;
    border-bottom: 1px solid var(--dark-200);
  }
  .finance-dashboard .table-clean td {
    padding: 1rem; border-bottom: 1px solid var(--dark-100); vertical-align: top;
  }
  .finance-dashboard .table-clean tr:last-child td { border-bottom: none; }

  .finance-dashboard .value-strong { font-weight: 800; color: var(--dark-900); }
  .finance-dashboard .text-muted { color: var(--dark-500); }

  .finance-dashboard .link {
    color: var(--primary-600); text-decoration: none; transition: var(--transition);
  }
  .finance-dashboard .link:hover { color: var(--primary-700); text-decoration: underline; }

  .finance-dashboard .summary-item {
    text-align: center; padding: 1.2rem .8rem;
  }
  .finance-dashboard .summary-label {
    font-size: .875rem; color: var(--dark-600); margin-bottom: .35rem;
  }
  .finance-dashboard .summary-value {
    font-size: 1.15rem; font-weight: 800;
  }

  @media (max-width: 1024px) {
    .finance-dashboard .tables-grid { grid-template-columns: 1fr; }
    .finance-dashboard .kpi-grid { grid-template-columns: 1fr; }
  }
  @media (max-width: 768px) {
    .finance-dashboard .quick-actions-grid { grid-template-columns: repeat(2, 1fr); }
    .finance-dashboard .summary-grid { grid-template-columns: repeat(2, 1fr); }
    .finance-dashboard .data-card-header { flex-direction: column; align-items: stretch; gap: 1rem; }
    .finance-dashboard .data-card-header .btn { align-self: flex-end; }
  }
  @media (max-width: 480px) {
    .finance-dashboard .quick-actions-grid { grid-template-columns: 1fr; }
    .finance-dashboard .summary-grid { grid-template-columns: 1fr; }
    .finance-dashboard .kpi-value { font-size: 1.45rem; }
  }

  @keyframes slideInUp {
    from { opacity: 0; transform: translateY(24px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .finance-dashboard .scroll-reveal { animation: slideInUp 0.55s ease-out; }
  </style>
{% endblock %}
