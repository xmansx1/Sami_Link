{# finance/templates/finance/invoice_detail.html #}
{% extends "base.html" %}
{% load humanize %}

{% block title %}ÙØ§ØªÙˆØ±Ø© #{{ inv.id }}{% endblock %}

{% block content %}
<section class="page-section invoice-detail-page">
  <div class="container">
    
    {# ===== Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© ===== #}
    <div class="section-header" style="text-align: right; margin-bottom: 2rem;">
      <div class="section-badge">
        ğŸ§¾ ÙØ§ØªÙˆØ±Ø© #{{ inv.id }}
      </div>
      <h1 class="section-title">
        ÙØ§ØªÙˆØ±Ø© #{{ inv.id }}
      </h1>
      <p class="section-description">
        A{{ inv.agreement_id }}{% if inv.agreement and inv.agreement.request_id %} / R{{ inv.agreement.request_id }}{% endif %}
      </p>
    </div>

    <div class="invoice-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
      
      {# ===== ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº ===== #}
      <div class="profile-section">
        <div class="card-section-title">ğŸ’° ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</div>
        <div class="amount-breakdown">
          <div class="amount-row">
            <span class="amount-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (P)</span>
            <span class="amount-value">{{ breakdown.net_for_employee|floatformat:2 }} Ø±.Ø³</span>
          </div>
          <div class="amount-row">
            <span class="amount-label">Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ©</span>
            <span class="amount-value">
              {{ breakdown.platform_fee|floatformat:2 }} Ø±.Ø³
            </span>
          </div>
          <div class="amount-row">
            <span class="amount-label">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (VAT)</span>
            <span class="amount-value">
              {{ breakdown.vat_amount|floatformat:2 }} Ø±.Ø³
            </span>
          </div>
          <div class="amount-row total-row">
            <span class="amount-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚</span>
            <span class="amount-value">{{ breakdown.client_total|floatformat:2 }} Ø±.Ø³</span>
          </div>
        </div>

        <div class="quick-summary profile-section" style="background: var(--primary-50); border-color: var(--primary-200); margin-top: 1.5rem;">
          <div class="card-section-title" style="color: var(--primary-700);">ğŸ“Š Ù…ÙˆØ¬Ø² Ø³Ø±ÙŠØ¹</div>
          <div class="summary-items">
            <div class="summary-item">
              <span class="summary-label">ØµØ§ÙÙŠ Ø§Ù„Ù…ÙˆØ¸Ù=</span>
              <span class="summary-value">
                {{ breakdown.net_for_employee|floatformat:2 }} Ø±.Ø³
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ©:</span>
              <span class="summary-value">{{ breakdown.platform_fee|floatformat:2 }} Ø±.Ø³</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙÙ‚Ø·):</span>
              <span class="summary-value">{{ breakdown.vat_amount|floatformat:2 }} Ø±.Ø³</span>
            </div>
          </div>
        </div>
      </div>

      {# ===== Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø³Ø¯Ø§Ø¯ ===== #}
      <div class="profile-section">
        <div class="card-section-title">ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø³Ø¯Ø§Ø¯</div>
        
        <div class="status-grid">
          <div class="status-item">
            <span class="status-label">Ø§Ù„Ø­Ø§Ù„Ø©</span>
            <span class="status-value">
              <span class="badge {% if inv.is_paid %}badge-verified{% else %}badge-pending{% endif %}">
                {{ inv.get_status_display }}
              </span>
            </span>
          </div>
          
          <div class="status-item">
            <span class="status-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</span>
            <span class="status-value">{% if inv.issued_at %}{{ inv.issued_at|date:"Y-m-d H:i" }}{% else %}â€”{% endif %}</span>
          </div>
          
          <div class="status-item">
            <span class="status-label">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø³Ø¯Ø§Ø¯</span>
            <span class="status-value">{% if inv.due_at %}{{ inv.due_at|date:"Y-m-d H:i" }}{% else %}â€”{% endif %}</span>
          </div>
          
          <div class="status-item">
            <span class="status-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¯Ø§Ø¯</span>
            <span class="status-value">{% if inv.paid_at %}{{ inv.paid_at|date:"Y-m-d H:i" }}{% else %}â€”{% endif %}</span>
          </div>
          
          <div class="status-item">
            <span class="status-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯</span>
            <span class="status-value">{% if inv.method %}{{ inv.method }}{% else %}â€”{% endif %}</span>
          </div>
          
          <div class="status-item">
            <span class="status-label">Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</span>
            <span class="status-value">{% if inv.ref_code %}<code>{{ inv.ref_code }}</code>{% else %}â€”{% endif %}</span>
          </div>
          
          <div class="status-item">
            <span class="status-label">Ù…Ø±Ø¬Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ</span>
            <span class="status-value">{% if inv.paid_ref %}<code>{{ inv.paid_ref }}</code>{% else %}â€”{% endif %}</span>
          </div>
        </div>

        {% if inv.is_paid %}
          <div class="payment-status profile-section" style="background: var(--primary-50); border-color: var(--primary-200); margin-top: 1.5rem;">
            <div class="payment-success" style="text-align: center; padding: 1.5rem;">
              <div class="success-icon" style="font-size: 3rem; margin-bottom: 1rem;">âœ…</div>
              <h3 class="card-section-title" style="color: var(--primary-700); margin-bottom: 0.5rem;">
                Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø¯ÙÙˆØ¹Ø©
              </h3>
              <p class="card-section-note">
                ØªÙ… Ø³Ø¯Ø§Ø¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ {{ inv.paid_at|date:"Y-m-d H:i" }}
              </p>
              {% if inv.method %}
                <p class="card-section-note" style="margin-top: 0.5rem;">
                  Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯: <strong>{{ inv.method }}</strong>
                </p>
              {% endif %}
            </div>
          </div>
        {% else %}
          <div class="payment-form profile-section" style="background: var(--secondary-50); border-color: var(--secondary-200); margin-top: 1.5rem;">
            <div class="card-section-title" style="color: var(--secondary-700);">ğŸ’³ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø¯Ø§Ø¯</div>
            
            <form method="post" action="{% url 'finance:mark_invoice_paid' inv.id %}" class="payment-form-inner">
              {% csrf_token %}
              
              <div class="form-grid-3" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                <div class="form-field">
                  <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯</label>
                  <input type="text" 
                         name="method" 
                         class="input" 
                         placeholder="Ø­ÙˆØ§Ù„Ø© / Ù…Ø¯Ù‰ / ÙÙŠØ²Ø§"
                         required>
                </div>
                
                <div class="form-field">
                  <label class="form-label">Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
                  <input type="text" 
                         name="ref_code" 
                         class="input" 
                         placeholder="REF-123456">
                </div>
                
                <div class="form-field">
                  <label class="form-label">Ù…Ø±Ø¬Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„</label>
                  <input type="text" 
                         name="paid_ref" 
                         class="input" 
                         placeholder="IBAN Ref">
                </div>
              </div>
              
              <div class="form-actions">
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                  âœ… ÙˆØ³Ù… ÙƒÙ…Ø¯ÙÙˆØ¹Ø©
                </button>
              </div>
            </form>
          </div>
        {% endif %}
      </div>
    </div>

    {# ===== Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ===== #}
    <div class="additional-info" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
      
      {% if inv.agreement %}
      <div class="profile-section">
        <div class="card-section-title">ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</div>
        <div class="agreement-info">
          <div class="info-row">
            <span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©:</span>
            <span class="info-value">A{{ inv.agreement_id }}</span>
          </div>
          {% if inv.agreement.request_id %}
          <div class="info-row">
            <span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</span>
            <span class="info-value">R{{ inv.agreement.request_id }}</span>
          </div>
          {% endif %}
          {% if inv.agreement.employee %}
          <div class="info-row">
            <span class="info-label">Ø§Ù„Ù…ÙˆØ¸Ù:</span>
            <span class="info-value">{{ inv.agreement.employee }}</span>
          </div>
          {% endif %}
          {% if inv.agreement.client %}
          <div class="info-row">
            <span class="info-label">Ø§Ù„Ø¹Ù…ÙŠÙ„:</span>
            <span class="info-value">{{ inv.agreement.client }}</span>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <div class="profile-section">
        <div class="card-section-title">âš¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</div>
        <div class="quick-actions employee-actions">
          <a href="{% url 'finance:invoice_list' %}" class="btn btn-outline btn-sm">
            ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
          </a>
          {% if not inv.is_paid %}
            <a href="{% url 'finance:checkout_agreement' inv.agreement_id %}" class="btn btn-outline btn-sm">
              ğŸ’³ ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹
            </a>
          {% endif %}
          {% if inv.agreement %}
            <a href="{% url 'marketplace:request_detail' inv.agreement.request_id %}" class="btn btn-outline btn-sm">
              ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨
            </a>
          {% endif %}
        </div>
        
        <div class="due-status profile-section" style="background: var(--dark-50); margin-top: 1.5rem;">
          <div class="card-section-title">â° Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</div>
          <div class="due-info">
            {% if inv.is_paid %}
              <div class="due-item paid">
                <span class="due-icon">âœ…</span>
                <span class="due-text">ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯ ÙÙŠ {{ inv.paid_at|date:"Y-m-d" }}</span>
              </div>
            {% elif inv.due_at and inv.due_at < now %}
              <div class="due-item overdue">
                <span class="due-icon">âš ï¸</span>
                <span class="due-text">Ù…ØªØ£Ø®Ø±Ø© Ù…Ù†Ø° {{ inv.due_at|timesince }}</span>
              </div>
            {% elif inv.due_at %}
              <div class="due-item pending">
                <span class="due-icon">â³</span>
                <span class="due-text">Ù…Ø³ØªØ­Ù‚Ø© Ø®Ù„Ø§Ù„ {{ inv.due_at|timeuntil }}</span>
              </div>
            {% else %}
              <div class="due-item unknown">
                <span class="due-icon">ğŸ“…</span>
                <span class="due-text">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø§Ø³ØªØ­Ù‚Ø§Ù‚</span>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

  </div>
</section>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script>
  (function () {
    if (typeof initScrollReveal === 'function') {
      initScrollReveal();
    }

    document.querySelectorAll('.btn').forEach(button => {
      button.addEventListener('click', function() {
        if (typeof animateButtonClick === 'function') {
          animateButtonClick(this);
        }
      });
    });

    const paymentForm = document.querySelector('.payment-form-inner');
    if (paymentForm) {
      const inputs = paymentForm.querySelectorAll('input');
      const submitBtn = paymentForm.querySelector('button[type="submit"]');
      
      inputs.forEach(input => {
        input.addEventListener('focus', function() {
          this.style.borderColor = 'var(--primary-500)';
          this.style.boxShadow = '0 0 0 3px rgba(34, 197, 94, 0.1)';
        });
        
        input.addEventListener('blur', function() {
          this.style.borderColor = '';
          this.style.boxShadow = '';
        });
        
        input.addEventListener('input', function() {
          if (this.value.trim().length > 0) {
            this.style.background = 'var(--primary-50)';
          } else {
            this.style.background = '';
          }
        });
      });

      paymentForm.addEventListener('submit', function(e) {
        const methodInput = this.querySelector('input[name="method"]');
        
        if (!methodInput.value.trim()) {
          e.preventDefault();
          if (typeof showToast === 'function') {
            showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯', 'error');
          } else {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯');
          }
          methodInput.focus();
          return false;
        }

        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';
        }

        if (typeof showToast === 'function') {
          showToast('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø¯Ø§Ø¯...', 'info');
        }
      });
    }

    document.querySelectorAll('.amount-row').forEach((row, index) => {
      row.style.animationDelay = `${index * 0.1}s`;
      row.classList.add('scroll-reveal');
    });

    document.querySelectorAll('code').forEach(codeElement => {
      codeElement.style.cursor = 'pointer';
      codeElement.title = 'Ø§Ù†Ù‚Ø± Ù„Ù„Ù†Ø³Ø®';
      codeElement.addEventListener('click', function() {
        const textToCopy = this.textContent;
        navigator.clipboard.writeText(textToCopy).then(() => {
          if (typeof showToast === 'function') {
            showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø±Ø¬Ø¹', 'success');
          }
        });
      });
    });

  })();
  </script>

  <style>
  .invoice-detail-page .invoice-grid {
    grid-template-columns: 1fr 1fr;
  }

  .invoice-detail-page .amount-breakdown {
    margin-top: 1rem;
  }

  .invoice-detail-page .amount-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--dark-100);
  }

  .invoice-detail-page .amount-row:last-child {
    border-bottom: none;
  }

  .invoice-detail-page .amount-label {
    color: var(--dark-600);
    font-size: 0.95rem;
  }

  .invoice-detail-page .amount-value {
    color: var(--dark-900);
    font-weight: 600;
    font-size: 0.95rem;
  }

  .invoice-detail-page .amount-percent {
    color: var(--dark-500);
    font-size: 0.8rem;
    font-weight: normal;
  }

  .invoice-detail-page .subtotal-row {
    border-top: 2px solid var(--dark-200);
    margin-top: 0.5rem;
    padding-top: 1rem;
  }

  .invoice-detail-page .total-row {
    background: var(--primary-50);
    margin: 0 -1rem;
    padding: 1rem;
    border-radius: var(--radius);
    border: none;
    margin-top: 0.5rem;
  }

  .invoice-detail-page .total-row .amount-label {
    color: var(--primary-700);
    font-weight: 700;
    font-size: 1rem;
  }

  .invoice-detail-page .total-row .amount-value {
    color: var(--primary-700);
    font-weight: 800;
    font-size: 1.1rem;
  }

  .invoice-detail-page .summary-items {
    margin-top: 1rem;
  }

  .invoice-detail-page .summary-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--primary-200);
  }

  .invoice-detail-page .summary-item:last-child {
    border-bottom: none;
  }

  .invoice-detail-page .summary-label {
    color: var(--primary-600);
    font-size: 0.9rem;
  }

  .invoice-detail-page .summary-value {
    color: var(--primary-700);
    font-weight: 600;
    font-size: 0.9rem;
  }

  .invoice-detail-page .status-grid {
    margin-top: 1rem;
  }

  .invoice-detail-page .status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--dark-100);
  }

  .invoice-detail-page .status-item:last-child {
    border-bottom: none;
  }

  .invoice-detail-page .status-label {
    color: var(--dark-600);
    font-size: 0.95rem;
  }

  .invoice-detail-page .status-value {
    color: var(--dark-900);
    font-weight: 600;
    font-size: 0.95rem;
  }

  .invoice-detail-page .status-value code {
    background: var(--dark-100);
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius);
    font-family: monospace;
    font-size: 0.85rem;
    transition: var(--transition);
  }

  .invoice-detail-page .status-value code:hover {
    background: var(--primary-100);
    color: var(--primary-700);
  }

  .invoice-detail-page .form-grid-3 {
    grid-template-columns: repeat(3, 1fr);
  }

  .invoice-detail-page .form-field {
    margin-bottom: 0;
  }

  .invoice-detail-page .form-label {
    display: block;
    font-weight: 600;
    color: var(--dark-700);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }

  .invoice-detail-page .input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid var(--dark-300);
    border-radius: var(--radius-lg);
    background: var(--white);
    font-family: inherit;
    font-size: 1rem;
    transition: var(--transition);
  }

  .invoice-detail-page .input:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
  }

  .invoice-detail-page .agreement-info {
    margin-top: 1rem;
  }

  .invoice-detail-page .info-row {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--dark-100);
  }

  .invoice-detail-page .info-row:last-child {
    border-bottom: none;
  }

  .invoice-detail-page .info-label {
    color: var(--dark-600);
    font-size: 0.9rem;
  }

  .invoice-detail-page .info-value {
    color: var(--dark-900);
    font-weight: 600;
    font-size: 0.9rem;
  }

  .invoice-detail-page .quick-actions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .invoice-detail-page .due-info {
    margin-top: 1rem;
  }

  .invoice-detail-page .due-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    border-radius: var(--radius-lg);
    font-weight: 600;
  }

  .invoice-detail-page .due-item.paid {
    background: var(--primary-100);
    color: var(--primary-700);
    border: 1px solid var(--primary-200);
  }

  .invoice-detail-page .due-item.overdue {
    background: #fef2f2;
    color: #dc2626;
    border: 1px solid #fecaca;
  }

  .invoice-detail-page .due-item.pending {
    background: var(--secondary-100);
    color: var(--secondary-700);
    border: 1px solid var(--secondary-200);
  }

  .invoice-detail-page .due-item.unknown {
    background: var(--dark-100);
    color: var(--dark-700);
    border: 1px solid var(--dark-200);
  }

  @media (max-width: 1024px) {
    .invoice-detail-page .invoice-grid {
      grid-template-columns: 1fr;
    }
    
    .invoice-detail-page .form-grid-3 {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .invoice-detail-page .additional-info {
      grid-template-columns: 1fr;
    }
    
    .invoice-detail-page .quick-actions {
      flex-direction: row;
      flex-wrap: wrap;
    }
    
    .invoice-detail-page .amount-row,
    .invoice-detail-page .status-item,
    .invoice-detail-page .info-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
    }
  }

  @keyframes pulseSuccess {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  .invoice-detail-page .payment-success .success-icon {
    animation: pulseSuccess 2s infinite;
  }
  </style>
{% endblock %}
