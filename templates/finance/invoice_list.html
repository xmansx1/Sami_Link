{# finance/templates/finance/invoice_list.html #}
{% extends "base.html" %}
{% load humanize %}

{% block title %}Ø§Ù„ÙÙˆØ§ØªÙŠØ±{% endblock %}

{% block content %}
<section class="page-section invoice-list-page">
  <div class="container">
    
    {# ===== Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© ===== #}
    <div class="section-header" style="text-align: right; margin-bottom: 2rem;">
      <div class="section-badge">
        ğŸ§¾ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±
      </div>
      <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 1rem;">
        <div>
          <h1 class="section-title" style="margin: 0;">
            Ø§Ù„ÙÙˆØ§ØªÙŠØ±
          </h1>
          <p class="section-description">
            ØªØµÙÙŠØ© Ø³Ø±ÙŠØ¹Ø© Ø¨Ø§Ù„Ø­Ø§Ù„Ø©
          </p>
        </div>
        <div class="filter-buttons employee-actions">
          <a href="{% url 'finance:invoice_list' %}" class="btn btn-outline btn-sm {% if not request.GET.status %}active{% endif %}">
            Ø§Ù„ÙƒÙ„
          </a>
          <a href="{% url 'finance:invoice_list' %}?status=paid" class="btn btn-outline btn-sm {% if request.GET.status == 'paid' %}active{% endif %}">
            âœ… Ù…Ø¯ÙÙˆØ¹Ø©
          </a>
          <a href="{% url 'finance:invoice_list' %}?status=unpaid" class="btn btn-outline btn-sm {% if request.GET.status == 'unpaid' %}active{% endif %}">
            â³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©
          </a>
          <a href="{% url 'finance:invoice_list' %}?status=cancelled" class="btn btn-outline btn-sm {% if request.GET.status == 'cancelled' %}active{% endif %}">
            ğŸš« Ù…Ù„ØºØ§Ø©
          </a>
        </div>
      </div>
    </div>

    {# ===== Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ===== #}
    <div class="profile-section">
      <div class="table-wrapper">
        <table class="table table-clean">
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</th>
              <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
              <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„Ø¥ØµØ¯Ø§Ø±</th>
              <th>Ø§Ù„Ø³Ø¯Ø§Ø¯</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody>
            {% if invoices %}
              {% for item in invoices %}
                  <tr class="scroll-reveal invoice-row">
                    <td class="invoice-number">
                      <span class="badge badge-default">#{{ item.inv.id }}</span>
                    </td>
                  
                    <td class="agreement-info">
                      <div class="agreement-main">
                        <div class="agreement-id">A{{ item.inv.agreement_id }}</div>
                        {% if item.inv.agreement and item.inv.agreement.request_id %}
                          <div class="request-id">Ø·Ù„Ø¨ #{{ item.inv.agreement.request_id }}</div>
                        {% endif %}
                      </div>
                    </td>
                  
                    <td class="milestone-info">
                      {% if item.inv.milestone %}
                        <div class="milestone-title">{{ item.inv.milestone.title|truncatewords:3 }}</div>
                      {% else %}
                        <span class="text-muted">â€”</span>
                      {% endif %}
                    </td>
                  
                    <td class="amount-info">
                      <div class="amount-value">{{ item.breakdown.client_total|floatformat:2 }}</div>
                      <div class="amount-currency">Ø±.Ø³</div>
                    </td>
                  
                    <td class="status-info">
                      <span class="badge 
                                 {% if item.inv.status == 'paid' %}badge-verified
                                 {% elif item.inv.status == 'unpaid' %}badge-pending
                                 {% elif item.inv.status == 'cancelled' %}badge-rejected
                                 {% else %}badge-default{% endif %}">
                        {% if item.inv.status == 'paid' %}âœ… 
                        {% elif item.inv.status == 'unpaid' %}â³
                        {% elif item.inv.status == 'cancelled' %}ğŸš«
                        {% endif %}
                        {{ item.inv.get_status_display }}
                      </span>
                    </td>
                  
                    <td class="date-info">
                      {% if item.inv.issued_at %}
                        <div class="date-main">{{ item.inv.issued_at|date:"Y-m-d" }}</div>
                        <div class="date-time">{{ item.inv.issued_at|date:"H:i" }}</div>
                      {% else %}
                        <span class="text-muted">â€”</span>
                      {% endif %}
                    </td>
                  
                    <td class="date-info">
                      {% if item.inv.paid_at %}
                        <div class="date-main">{{ item.inv.paid_at|date:"Y-m-d" }}</div>
                        <div class="date-time">{{ item.inv.paid_at|date:"H:i" }}</div>
                      {% else %}
                        <span class="text-muted">â€”</span>
                      {% endif %}
                    </td>
                  
                    <td class="actions-info">
                      <a href="{% url 'finance:invoice_detail' item.inv.id %}" 
                         class="btn btn-outline btn-sm"
                         title="Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
                        ğŸ‘ï¸ ØªÙØ§ØµÙŠÙ„
                      </a>
                    </td>
                  </tr>
                {% endfor %}
            {% else %}
              {# ===== Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ÙÙˆØ§ØªÙŠØ± ===== #}
              <tr>
                <td colspan="8" class="empty-state">
                  <div class="empty-content" style="text-align: center; padding: 3rem;">
                    <div class="empty-icon" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.4;">ğŸ§¾</div>
                    <h3 class="card-section-title" style="margin-bottom: 0.5rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±</h3>
                    <p class="card-section-note">
                      {% if request.GET.status %}
                        Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ø¨Ø­Ø§Ù„Ø© "{{ request.GET.status }}"
                      {% else %}
                        Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ ÙÙˆØ§ØªÙŠØ± Ø¨Ø¹Ø¯
                      {% endif %}
                    </p>
                  </div>
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>


  </div>
</section>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script>
  (function () {
    // ØªÙ‡ÙŠØ¦Ø© ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØªÙ…Ø±ÙŠØ±
    if (typeof initScrollReveal === 'function') {
      initScrollReveal();
    }

    // ØªØ£Ø«ÙŠØ±Ø§Øª Ø¹Ù„Ù‰ ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    document.querySelectorAll('.invoice-row').forEach(row => {
      row.addEventListener('mouseenter', function() {
        this.style.background = 'var(--primary-50)';
        this.style.transform = 'translateX(-5px)';
        this.style.boxShadow = 'var(--shadow-sm)';
      });
      
      row.addEventListener('mouseleave', function() {
        this.style.background = '';
        this.style.transform = 'translateX(0)';
        this.style.boxShadow = '';
      });
    });

    // ØªØ£Ø«ÙŠØ±Ø§Øª Ø¹Ù„Ù‰ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµÙÙŠØ©
    document.querySelectorAll('.filter-buttons .btn').forEach(button => {
      button.addEventListener('click', function() {
        if (typeof animateButtonClick === 'function') {
          animateButtonClick(this);
        }
        
        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø·
        document.querySelectorAll('.filter-buttons .btn').forEach(btn => {
          btn.classList.remove('active');
        });
        this.classList.add('active');
      });
    });

    // ØªØ£Ø«ÙŠØ±Ø§Øª Ø¹Ù„Ù‰ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„
    document.querySelectorAll('.actions-info .btn').forEach(button => {
      button.addEventListener('mouseenter', function() {
        this.style.transform = 'scale(1.05)';
        this.style.background = 'var(--primary-500)';
        this.style.color = 'white';
      });
      
      button.addEventListener('mouseleave', function() {
        this.style.transform = 'scale(1)';
        this.style.background = '';
        this.style.color = '';
      });
      
      button.addEventListener('click', function() {
        if (typeof animateButtonClick === 'function') {
          animateButtonClick(this);
        }
      });
    });

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ (ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§)
    function updateStats() {
      const paidCount = document.querySelectorAll('.badge-verified').length;
      const unpaidCount = document.querySelectorAll('.badge-pending').length;
      const cancelledCount = document.querySelectorAll('.badge-rejected').length;
      
      // ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§
      console.log('Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', { paidCount, unpaidCount, cancelledCount });
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    updateStats();

  })();
  </script>

  <style>
  .invoice-list-page .filter-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .invoice-list-page .filter-buttons .btn.active {
    background: var(--primary-500);
    color: white;
    border-color: var(--primary-500);
  }

  .invoice-list-page .table-wrapper {
    overflow-x: auto;
    border-radius: var(--radius-xl);
    border: 1px solid var(--dark-200);
  }

  .invoice-list-page .table-clean {
    width: 100%;
    border-collapse: collapse;
  }

  .invoice-list-page .table-clean th {
    background: var(--dark-50);
    color: var(--dark-700);
    font-weight: 600;
    padding: 1rem;
    text-align: right;
    border-bottom: 1px solid var(--dark-200);
    white-space: nowrap;
  }

  .invoice-list-page .table-clean td {
    padding: 1rem;
    border-bottom: 1px solid var(--dark-100);
    vertical-align: middle;
    transition: all 0.3s ease;
  }

  .invoice-list-page .table-clean tr:last-child td {
    border-bottom: none;
  }

  .invoice-list-page .invoice-number {
    text-align: center;
  }

  .invoice-list-page .agreement-info {
    min-width: 120px;
  }

  .invoice-list-page .agreement-main {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .invoice-list-page .agreement-id {
    font-weight: 600;
    color: var(--dark-900);
  }

  .invoice-list-page .request-id {
    font-size: 0.875rem;
    color: var(--dark-500);
  }

  .invoice-list-page .milestone-info {
    min-width: 150px;
    max-width: 200px;
  }

  .invoice-list-page .milestone-title {
    color: var(--dark-700);
    line-height: 1.4;
  }

  .invoice-list-page .amount-info {
    text-align: left;
    direction: ltr;
  }

  .invoice-list-page .amount-value {
    font-weight: 700;
    color: var(--dark-900);
    font-size: 1.1rem;
  }

  .invoice-list-page .amount-currency {
    font-size: 0.875rem;
    color: var(--dark-500);
  }

  .invoice-list-page .status-info {
    text-align: center;
  }

  .invoice-list-page .date-info {
    text-align: center;
    min-width: 100px;
  }

  .invoice-list-page .date-main {
    font-weight: 600;
    color: var(--dark-700);
  }

  .invoice-list-page .date-time {
    font-size: 0.875rem;
    color: var(--dark-500);
  }

  .invoice-list-page .actions-info {
    text-align: center;
  }

  .invoice-list-page .empty-state {
    padding: 0;
  }

  .invoice-list-page .empty-content {
    padding: 3rem;
  }

  .invoice-list-page .empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.4;
  }

  .invoice-list-page .stats-summary {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }

  .invoice-list-page .stat-item {
    text-align: center;
    padding: 1rem;
    background: var(--white);
    border-radius: var(--radius-lg);
    border: 1px solid var(--dark-200);
  }

  .invoice-list-page .stat-label {
    font-size: 0.875rem;
    color: var(--dark-600);
    margin-bottom: 0.5rem;
  }

  .invoice-list-page .stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-600);
  }

  .invoice-list-page .text-muted {
    color: var(--dark-500);
    font-style: italic;
  }

  @media (max-width: 1024px) {
    .invoice-list-page .section-header > div {
      flex-direction: column;
      align-items: stretch;
      gap: 1rem;
    }
    
    .invoice-list-page .filter-buttons {
      justify-content: center;
    }
  }

  @media (max-width: 768px) {
    .invoice-list-page .table-wrapper {
      font-size: 0.875rem;
    }
    
    .invoice-list-page .table-clean th,
    .invoice-list-page .table-clean td {
      padding: 0.75rem 0.5rem;
    }
    
    .invoice-list-page .stats-summary {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .invoice-list-page .filter-buttons {
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .invoice-list-page .filter-buttons .btn {
      flex: 1;
      min-width: 80px;
      text-align: center;
    }
  }

  @media (max-width: 480px) {
    .invoice-list-page .stats-summary {
      grid-template-columns: 1fr;
    }
    
    .invoice-list-page .table-clean {
      min-width: 700px;
    }
    
    .invoice-list-page .amount-value {
      font-size: 1rem;
    }
  }

  /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø­Ø±ÙƒØ© */
  @keyframes fadeInRow {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .invoice-list-page .invoice-row {
    animation: fadeInRow 0.5s ease-out;
  }
  </style>
{% endblock %}