{% extends "base.html" %}
{# agreements/templates/agreements/agreement_form.html #}
{% load static %}
{% block title %}Ø§ØªÙØ§Ù‚ÙŠØ© â€” Ø·Ù„Ø¨ #{{ req.id }}{% endblock %}

{% block content %}



<section class="page-section agreement-form-page">
  <div class="container">

    {# ===== Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© ===== #}
    <div class="profile-section" style="background: linear-gradient(135deg, var(--primary-50) 0%, var(--white) 100%); margin-bottom: 2rem;">
      <div class="card-row" style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem;">
        <div class="agreement-icon" style="width: 4rem; height: 4rem; background: var(--primary-100); color: var(--primary-600); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
          ğŸ“
        </div>
        <div style="flex: 1;">
          <h1 class="section-title" style="margin-bottom: 0.5rem;">
            Ø§ØªÙØ§Ù‚ÙŠØ© Ø§Ù„Ø®Ø¯Ù…Ø©
          </h1>
          <p class="section-description">
            Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø·Ù„Ø¨
            <a class="link" href="{% url 'marketplace:request_detail' req.id %}">#{{ req.id }}</a>
          </p>
        </div>
      </div>


      <div class="agreement-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">

        <div class="stat-item profile-section" style="padding: 1rem; text-align: center;">
          <div class="stat-label">ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡</div>
          <div class="stat-value" style="color: var(--primary-600); background: #e6fff6; border-radius: 12px; padding: 0.5rem 1.5rem; display: inline-block; font-size: 1.35rem; font-weight: bold;">
            {% if breakdown %}
              Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„: {{ breakdown.client_total|floatformat:2 }} Ø±.Ø³
            {% else %}
              Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„: â€”
            {% endif %}
          </div>
        </div>

        <div class="stat-item profile-section" style="padding: 1rem; text-align: center;">
          <div class="stat-label">â±ï¸ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§</div>
          <div id="agreed-duration"
               class="stat-value"
               data-duration-days="{{ agreement.duration_days }}"
               style="color: var(--secondary-600);">
            {{ agreement.duration_days }} ÙŠÙˆÙ…
          </div>
        </div>

        <div class="stat-item profile-section" style="padding: 1rem; text-align: center;">
          <div class="stat-label">ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</div>
          <div class="stat-value">
            {{ form.instance.get_status_display|default:"â€”" }}
          </div>
        </div>

        <div class="stat-item profile-section" style="padding: 1rem; text-align: center;">
          <div class="stat-label">ğŸ”¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</div>
          <div id="live-sum" class="stat-value">
            {{ form.instance.milestones.count|default:0 }}
          </div>
        </div>

      </div>

    </div>

    <form method="post" novalidate class="agreement-form">
      {% csrf_token %}

      {# Ø£Ø®Ø·Ø§Ø¡ Ø¹Ø§Ù…Ø© Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ§Ù„ÙÙˆØ±Ù… Ø³ÙØª ÙˆØ£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ #}
      {% if form.non_field_errors or formset.non_form_errors or form.errors %}
        <div class="error-alert profile-section" style="background: #fef2f2; border-color: #fecaca; margin-bottom: 1.5rem;">
          <div class="card-row" style="display: flex; align-items: flex-start; gap: 1rem;">
            <span class="error-icon" style="color: #ef4444;">âŒ</span>
            <div class="error-content">
              {% for e in form.non_field_errors %}
                <div>{{ e }}</div>
              {% endfor %}
              {% for e in formset.non_form_errors %}
                <div>{{ e }}</div>
              {% endfor %}
              {% for field in form %}
                {% for err in field.errors %}
                  <div>{{ field.label }}: {{ err }}</div>
                {% endfor %}
              {% endfor %}
            </div>
          </div>
        </div>
      {% endif %}

      {# ===== ØªØ®Ø·ÙŠØ· Ø¹Ø§Ù…: Ø¹Ù…ÙˆØ¯ Ø±Ø¦ÙŠØ³ÙŠ + Ø¬Ø§Ù†Ø¨ÙŠ ===== #}
      <div class="form-layout" style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; align-items: flex-start;">

        {# ===== Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ===== #}
        <div class="main-column">

          {# ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© #}
          <div class="profile-section scroll-reveal">
            <div class="card-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <div class="card-section-title">ğŸ§¾ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</div>
              <div class="card-section-note">
                ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙƒØ£Ø³Ø§Ø³ Ù„Ù„Ø§ØªÙØ§Ù‚ÙŠØ©.
              </div>
            </div>


            <div class="form-grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">

              <div class="form-field">
                <label class="form-label">Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§ (Ø£ÙŠØ§Ù…)</label>
                <div class="input" style="background: var(--dark-50); border-color: var(--dark-200); cursor: not-allowed;">
                  {{ agreement.duration_days }} ÙŠÙˆÙ…
                </div>
                <input type="hidden" name="duration_days" value="{{ agreement.duration_days }}">
              </div>

              <div class="form-field">
                <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº (P) â€” Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·</label>
                <div class="input" style="background: var(--dark-50); border-color: var(--dark-200); cursor: not-allowed;">
                    {{ agreement.total_amount|floatformat:2 }} Ø±.Ø³
                </div>
              </div>

            </div>


            {# breakdown Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙØµÙ„ #}
            {% if breakdown %}
              {% with fee_value=breakdown.platform_fee_value|default:breakdown.platform_fee vat_value=breakdown.vat_amount net_value=breakdown.tech_payout|default:breakdown.net_for_employee client_total_value=breakdown.client_total %}
              <div class="profile-section" style="background: var(--primary-50); border-color: var(--primary-200); margin-top: 1.5rem;">
                <div class="card-section-title" style="color: var(--primary-700);">ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</div>
                <div class="summary-items">
                  <div class="summary-item">
                    <span class="summary-label">ØµØ§ÙÙŠ Ø§Ù„Ù…ÙˆØ¸Ù (P - Fee):</span>
                    <span class="summary-value">{{ net_value|floatformat:2 }} Ø±.Ø³</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ© (ØªÙØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…ÙˆØ¸Ù):</span>
                    <span class="summary-value">{{ fee_value|floatformat:2 }} Ø±.Ø³</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (VAT Ø¹Ù„Ù‰ P):</span>
                    <span class="summary-value">{{ vat_value|floatformat:2 }} Ø±.Ø³</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„ (P + VAT):</span>
                    <span class="summary-value">{{ client_total_value|floatformat:2 }} Ø±.Ø³</span>
                  </div>
                </div>
              </div>
              {% endwith %}
            {% endif %}

            <div class="form-field">
              <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</label>
              <input type="hidden" name="title" value="{{ req.title }}">
              <div class="input" style="background: var(--dark-50); border-color: var(--dark-200); cursor: not-allowed;">{{ req.title }}</div>
              {% for e in form.title.errors %}
                <div class="field-error">{{ e }}</div>
              {% endfor %}
            </div>

            <div class="form-field">
              <label class="form-label">Ù†Øµ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</label>
              {{ form.text }}
              {% for e in form.text.errors %}
                <div class="field-error">{{ e }}</div>
              {% endfor %}
            </div>
          </div>

          {# ØªÙ†Ø¨ÙŠÙ‡ Ø®Ø§Øµ Ø¨Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§ #}
          <div id="duration-warning" class="profile-section" style="display:none; background:#fef2f2; border:1px solid #fecaca; border-radius:12px; padding:1rem; margin:1rem 0; color:#b91c1c; font-weight:bold; text-align:center;">
          </div>

          {# ===== Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ===== #}
          <div class="profile-section scroll-reveal">
            <div class="card-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <div class="card-section-title">ğŸ“‹ Ù…Ø±Ø§Ø­Ù„ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
              <button type="button" id="add-row" class="btn btn-primary btn-sm">
                â• Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø©
              </button>
            </div>

            {{ formset.management_form }}
            {% if formset.non_form_errors %}
              <div class="error-alert profile-section" style="background: #fef2f2; border-color: #fecaca; margin-bottom: 1.5rem;">
                <div class="card-row" style="display: flex; align-items: flex-start; gap: 1rem;">
                  <span class="error-icon" style="color: #ef4444;">âŒ</span>
                  <div class="error-content">
                    {% for e in formset.non_form_errors %}
                      <div>{{ e }}</div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% endif %}

            <div id="rows" class="milestones-container">
              {% for f in formset.forms %}
                <div class="milestone-row profile-section" data-row-index="{{ forloop.counter0 }}">
                  {{ f.id }}

                  <div class="milestone-header" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <div class="milestone-number" style="width: 2.5rem; height: 2.5rem; background: var(--primary-100); color: var(--primary-600); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem;">
                      {{ forloop.counter }}
                    </div>
                    <input type="hidden"
                           class="milestone-order-value"
                           name="{{ f.order.html_name }}"
                           value="{{ f.order.value|default:forloop.counter }}">
                    <input type="hidden" name="{{ f.prefix }}-amount" value="0">
                  </div>

                  <div class="form-grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-field">
                      <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
                      {{ f.title }}
                    </div>
                    <div class="form-field">
                      <label class="form-label">Ø§Ù„Ù…Ø¯Ø© (Ø£ÙŠØ§Ù…)</label>
                      {{ f.due_days }}
                    </div>
                  </div>

                  {% if formset.can_delete %}
                    <div class="milestone-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--dark-200);">
                      <span class="delete-label" style="color: var(--dark-500); font-size: 0.875rem;">
                        âš ï¸ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
                      </span>
                      <button type="button" class="btn btn-danger btn-sm delete-row">
                        ğŸ—‘ï¸ Ø­Ø°Ù
                      </button>
                    </div>
                    {{ f.DELETE }}
                  {% endif %}

                  {% for e in f.title.errors %}
                    <div class="field-error">{{ e }}</div>
                  {% endfor %}
                  {% for e in f.due_days.errors %}
                    <div class="field-error">{{ e }}</div>
                  {% endfor %}
                </div>
              {% endfor %}
            </div>

            <div class="info-box profile-section" style="background: var(--primary-50); border-color: var(--primary-200); margin-top: 1.5rem;">
              <div class="card-row" style="display: flex; align-items: flex-start; gap: 1rem;">
                <span class="info-icon" style="color: var(--primary-600);">ğŸ’¡</span>
                <div class="info-content">
                  <div class="card-section-title" style="color: var(--primary-700); margin-bottom: 0.25rem;">
                    Ø¥Ø¶Ø§ÙØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
                  </div>
                  <p class="card-section-note" style="color: var(--primary-600);">
                    Ø­Ø¯Ù‘ÙØ¯ Ù…Ø±Ø§Ø­Ù„ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¹ Ù…Ø¯Ø© ÙƒÙ„ Ù…Ø±Ø­Ù„Ø©. ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
                  </p>
                </div>
              </div>
            </div>
          </div>

        </div>

        {# ===== Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ ===== #}
        <div class="sidebar-column">

          {# Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø«Ø¨ØªØ© #}
          <div class="profile-section scroll-reveal sticky-sidebar">
            <div class="card-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <div class="card-section-title">ğŸ“Œ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø«Ø¨Ù‘ØªØ©</div>
              <span class="badge badge-default">
                {{ form.instance.clause_items.count }} Ø¨Ù†Ø¯
              </span>
            </div>

            {% if form.instance.clause_items.count == 0 %}
              <div class="empty-state profile-section" style="background: var(--secondary-50); border-color: var(--secondary-200); text-align: center; padding: 2rem;">
                <div class="empty-icon" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;">ğŸ“„</div>
                <p class="card-section-note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ù…Ø«Ø¨ØªØ© Ø¨Ø¹Ø¯.</p>
              </div>
            {% endif %}

            <div class="clauses-list" style="max-height: 300px; overflow-y: auto;">
              <ol class="clauses-ol" style="list-style-type: decimal; padding-right: 1.5rem; space-y: 0.75rem;">
                {% for item in form.instance.clause_items.all %}
                  <li class="clause-item profile-section" style="padding: 1rem; background: var(--dark-50); border-radius: var(--radius-lg); margin-bottom: 0.75rem;">
                    {% if item.clause %}
                      <strong style="color: var(--dark-700);">{{ item.clause.title }}:</strong>
                      <span style="color: var(--dark-600); display: block; margin-top: 0.25rem;">{{ item.clause.body }}</span>
                    {% else %}
                      <span style="color: var(--dark-600);">{{ item.custom_text }}</span>
                    {% endif %}
                  </li>
                {% endfor %}
              </ol>
            </div>

            <div class="clause-actions employee-actions" style="margin-top: 1.5rem;">
              {% if user.is_authenticated %}
                {% if user.is_staff or user.is_superuser or user.id == form.instance.employee_id %}
                  <a href="{% url 'agreements:finalize_clauses' form.instance.pk %}" class="btn btn-primary btn-sm" style="width: 100%;">
                    âš™ï¸ ØªØ«Ø¨ÙŠØª/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯
                  </a>
                {% endif %}
              {% endif %}
            </div>
          </div>

          {# ØªÙ„Ù…ÙŠØ­Ø§Øª Ø³Ø±ÙŠØ¹Ø© #}
          <div class="profile-section scroll-reveal" style="background: var(--dark-50);">
            <div class="card-section-title">ğŸ’¡ ØªÙ„Ù…ÙŠØ­Ø§Øª Ø³Ø±ÙŠØ¹Ø©</div>
            <div class="tips-list" style="margin-top: 1rem;">
              <div class="tip-item" style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem;">
                <span class="tip-icon">âœ¨</span>
                <span class="tip-text" style="font-size: 0.875rem; color: var(--dark-600);">
                  <strong>ØªØ±ØªÙŠØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ:</strong> ÙŠÙØ­Ø¯Ù‘Ø« ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø§Ù„Ø­Ø°Ù.
                </span>
              </div>
              <div class="tip-item" style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem;">
                <span class="tip-icon">â•</span>
                <span class="tip-text" style="font-size: 0.875rem; color: var(--dark-600);">
                  <strong>Ø¥Ø¶Ø§ÙØ© Ø³Ù‡Ù„Ø©:</strong> Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø©" Ù„Ø¥Ø¯Ø±Ø§Ø¬ ØµÙ Ø¬Ø¯ÙŠØ¯ Ø¨Ø³Ø±Ø¹Ø©.
                </span>
              </div>
              <div class="tip-item" style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem;">
                <span class="tip-icon">ğŸ—‘ï¸</span>
                <span class="tip-text" style="font-size: 0.875rem; color: var(--dark-600);">
                  <strong>Ø­Ø°Ù ÙØ¹Ù„ÙŠ:</strong> Ø§Ù„Ø­Ø°Ù ÙŠÙˆØ³Ù‘ÙÙ… Ø§Ù„ØµÙ Ù„Ù„Ø¥Ø²Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ ÙˆÙ„Ø§ ÙŠÙØ­Ø°Ù Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
                </span>
              </div>
              <div class="tip-item" style="display: flex; align-items: flex-start; gap: 0.75rem;">
                <span class="tip-icon">ğŸ“</span>
                <span class="tip-text" style="font-size: 0.875rem; color: var(--dark-600);">
                  <strong>Ù†Øµ Ø¢Ù…Ù†:</strong> ØªØªÙ… Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„ÙˆØ³ÙˆÙ… Ø§Ù„Ø¶Ø§Ø±Ø© Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©.
                </span>
              </div>
            </div>
          </div>

        </div>
      </div>

      {# ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ===== #}
      {% if agreement.status != 'accepted' %}
      <div class="form-actions employee-actions" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--dark-200); justify-content: center; flex-wrap: wrap; gap: 1rem;">
        <button id="btn-save" name="action" value="save" class="btn btn-primary">
          ğŸ’¾ Ø­ÙØ¸ (Ù…Ø³ÙˆØ¯Ø©)
        </button>
        <button id="btn-send" name="action" value="send" class="btn btn-success">
          ğŸ“¨ Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„
        </button>
        <a href="{% url 'marketplace:request_detail' req.id %}" class="btn btn-outline">
          â†©ï¸ Ø¹ÙˆØ¯Ø© Ù„Ù„Ø·Ù„Ø¨
        </a>
        {# Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ù…ÙˆØ¸Ù ØµØ§Ø­Ø¨ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø­Ø§Ù„Ø© new #}
        {% if user.is_authenticated and user.id == agreement.employee_id and req.status != 'new' %}
          <form method="post" action="{% url 'marketplace:offer_cancel' agreement.offer_id %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯.');">
              âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ø±Ø¶
            </button>
          </form>
        {% endif %}
      </div>
      {% endif %}

    </form>

    {# ===== Ù‚Ø§Ù„Ø¨ ØµÙ Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙÙˆØ±Ù… Ø³ÙØª ===== #}
    <template id="empty-form">
      <div class="milestone-row profile-section" data-row-index="__new__">
        {{ formset.empty_form.id }}
        <div class="milestone-header" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
          <div class="milestone-number" style="width: 2.5rem; height: 2.5rem; background: var(--primary-100); color: var(--primary-600); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem;">
            1
          </div>
          <input type="hidden" class="milestone-order-value" name="{{ formset.prefix }}-__prefix__-order" value="1">
          <input type="hidden" name="{{ formset.prefix }}-__prefix__-amount" value="0">
        </div>
        <div class="form-grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-field">
            <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
            {{ formset.empty_form.title }}
          </div>
          <div class="form-field">
            <label class="form-label">Ø§Ù„Ù…Ø¯Ø© (Ø£ÙŠØ§Ù…)</label>
            {{ formset.empty_form.due_days }}
          </div>
        </div>
        {% if formset.can_delete %}
          <div class="milestone-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--dark-200);">
            <span class="delete-label" style="color: var(--dark-500); font-size: 0.875rem;">
              âš ï¸ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
            </span>
            <button type="button" class="btn btn-danger btn-sm delete-row">
              ğŸ—‘ï¸ Ø­Ø°Ù
            </button>
          </div>
          {{ formset.empty_form.DELETE }}
        {% endif %}
      </div>
    </template>

  </div>
</section>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}

  <script>
  (function () {
    var rowsContainer = document.getElementById('rows');
    var addBtn = document.getElementById('add-row');
    var emptyTemplate = document.getElementById('empty-form');
    var totalFormsInput = document.querySelector('input[name="{{ formset.prefix }}-TOTAL_FORMS"]');
    var btnSave = document.getElementById('btn-save');
    var btnSend = document.getElementById('btn-send');
    var agreedDurationEl = document.getElementById('agreed-duration');
    var warningBox = document.getElementById('duration-warning');
    var agreedDuration = 0;

    if (agreedDurationEl) {
      var raw = agreedDurationEl.getAttribute('data-duration-days');
      agreedDuration = parseInt(raw, 10) || 0;
    }

    function toggleActionButtons(hasError) {
      if (btnSave) btnSave.disabled = hasError;
      if (btnSend) btnSend.disabled = hasError;
    }

    function updateMilestoneOrders() {
      if (!rowsContainer) return;
      var items = rowsContainer.querySelectorAll('.milestone-row:not([data-deleted="1"])');
      items.forEach(function (el, idx) {
        var orderInput = el.querySelector('.milestone-order-value');
        var orderDisp = el.querySelector('.milestone-number');
        var n = idx + 1;
        if (orderInput) orderInput.value = n;
        if (orderDisp) {
          orderDisp.textContent = n;
          orderDisp.style.animation = 'pulse 0.5s ease';
          setTimeout(function () { orderDisp.style.animation = ''; }, 500);
        }
      });
      var live = document.getElementById('live-sum');
      if (live) {
        live.textContent = String(items.length);
        live.style.animation = 'pulse 0.5s ease';
        setTimeout(function () { live.style.animation = ''; }, 500);
      }
    }

    function bindDeleteButtons(row) {
      var delBtn = row.querySelector('.delete-row');
      var delInput = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (!delBtn) return;
      delBtn.addEventListener('click', function () {
        if (!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø¹Ù†Ø¯ Ø­ÙØ¸ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;
        if (delInput) delInput.checked = true;
        row.setAttribute('data-deleted', '1');
        row.style.display = 'none';
        updateMilestoneOrders();
        checkMilestonesDuration();
      });
    }

    function addRow() {
      if (!rowsContainer || !emptyTemplate || !totalFormsInput) return;
      var currentCount = parseInt(totalFormsInput.value, 10) || 0;
      var html = emptyTemplate.innerHTML.replace(/__prefix__/g, String(currentCount));
      var wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      var newRow = wrapper.firstElementChild;
      rowsContainer.appendChild(newRow);
      totalFormsInput.value = String(currentCount + 1);
      bindDeleteButtons(newRow);
      updateMilestoneOrders();
      checkMilestonesDuration();
    }

    if (rowsContainer) {
      var existingRows = rowsContainer.querySelectorAll('.milestone-row');
      existingRows.forEach(function (row) { bindDeleteButtons(row); });
    }

    if (addBtn) addBtn.addEventListener('click', addRow);

    function showDurationWarning(hasError, msg) {
      if (!warningBox) return;
      if (hasError) {
        warningBox.textContent = msg || '';
        warningBox.style.display = 'block';
      } else {
        warningBox.textContent = '';
        warningBox.style.display = 'none';
      }
    }

    function checkMilestonesDuration() {
      if (!rowsContainer) { toggleActionButtons(false); return; }

      var rows = rowsContainer.querySelectorAll('.milestone-row:not([data-deleted="1"])');
      var sum = 0;
      rows.forEach(function (row) {
        var input = row.querySelector('input[name$="-due_days"]');
        if (input && input.value) sum += parseInt(input.value, 10) || 0;
      });

      if (!agreedDuration || agreedDuration <= 0) {
        showDurationWarning(false, '');
        toggleActionButtons(false);
        return;
      }

      if (sum > agreedDuration) {
        var msg = 'âš ï¸ Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ (' + String(sum) +
                  ' ÙŠÙˆÙ…Ù‹Ø§) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§ (' +
                  String(agreedDuration) + ' ÙŠÙˆÙ…Ù‹Ø§). Ø¹Ø¯Ù‘Ù„ Ù…Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø£Ùˆ Ù‚Ù„Ù‘Ù„ Ø¹Ø¯Ø¯Ù‡Ø§.';
        showDurationWarning(true, msg);
        toggleActionButtons(true);
      } else {
        showDurationWarning(false, '');
        toggleActionButtons(false);
      }
    }

    document.addEventListener('input', function (e) {
      if (!e.target || !e.target.name) return;
      var name = e.target.name;
      var isDueField = name.slice(-9) === '-due_days';
      if (isDueField) checkMilestonesDuration();
    });

    updateMilestoneOrders();
    checkMilestonesDuration();
  })();
  </script>

  <style>
  .agreement-form-page .agreement-stats { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
  .agreement-form-page .stat-item { border-radius: var(--radius-lg); border: 1px solid var(--dark-200); transition: all 0.3s ease; }
  .agreement-form-page .stat-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
  .agreement-form-page .stat-label { font-size: 0.875rem; color: var(--dark-600); margin-bottom: 0.5rem; }
  .agreement-form-page .stat-value { font-size: 1.25rem; font-weight: 700; }

  .agreement-form-page .form-layout { grid-template-columns: 2fr 1fr; }
  .agreement-form-page .sticky-sidebar { position: sticky; top: 100px; }

  .agreement-form-page .form-field { margin-bottom: 1rem; }
  .agreement-form-page .form-label { display: block; font-weight: 600; color: var(--dark-700); margin-bottom: 0.5rem; font-size: 0.95rem; }

  .agreement-form-page input,
  .agreement-form-page textarea,
  .agreement-form-page select {
    width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--dark-300);
    border-radius: var(--radius-lg); background: var(--white); font-family: inherit;
    font-size: 1rem; transition: var(--transition);
  }
  .agreement-form-page input:focus,
  .agreement-form-page textarea:focus,
  .agreement-form-page select:focus {
    outline: none; border-color: var(--primary-500); box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
  }
  .agreement-form-page textarea { min-height: 120px; resize: vertical; }

  .agreement-form-page .field-error { color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem; }
  .agreement-form-page .milestones-container { gap: 1rem; }

  .agreement-form-page .milestone-row { border-radius: var(--radius-xl); border: 1px solid var(--dark-200); transition: all 0.3s ease; }
  .agreement-form-page .milestone-row:hover { border-color: var(--primary-300); box-shadow: var(--shadow-sm); }

  .agreement-form-page .clauses-list { max-height: 300px; overflow-y: auto; }
  .agreement-form-page .clause-item { border-radius: var(--radius); border: 1px solid var(--dark-200); transition: all 0.3s ease; }
  .agreement-form-page .clause-item:hover { background: var(--primary-50); border-color: var(--primary-200); }

  .agreement-form-page .form-actions { display: flex; gap: 1rem; justify-content: center; }

  @keyframes pulse { 0% { transform: scale(1);} 50% { transform: scale(1.1);} 100% { transform: scale(1);} }

  @media (max-width: 1024px) {
    .agreement-form-page .form-layout { grid-template-columns: 1fr; }
    .agreement-form-page .sticky-sidebar { position: static; }
  }
  @media (max-width: 768px) {
    .agreement-form-page .form-grid-2 { grid-template-columns: 1fr; }
    .agreement-form-page .agreement-stats { grid-template-columns: repeat(2, 1fr); }
    .agreement-form-page .form-actions { flex-direction: column; }
    .agreement-form-page .form-actions .btn { width: 100%; }
  }
  @media (max-width: 480px) {
    .agreement-form-page .agreement-stats { grid-template-columns: 1fr; }
    .agreement-form-page .stat-item { padding: 0.75rem; }
  }
  </style>
{% endblock %}
