{# agreements/templates/agreements/reject_reason.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Ø³Ø¨Ø¨ Ø±ÙØ¶ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© #{{ agreement.id }}{% endblock %}

{% block extra_css %}
<style>
  .reject-counter {
    font-size: 0.8rem;
    color: var(--dark-400);
  }
  .reject-counter-ok {
    color: #16a34a;
  }
  .reject-counter-bad {
    color: #f43f5e;
  }
  .reject-error-box {
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: var(--radius-lg);
  }
  .reject-info-box {
    background: var(--dark-50);
    border-radius: var(--radius-lg);
  }
</style>
{% endblock %}

{% block content %}
<section class="page-section request-detail-page">
  <div class="container">
    <div class="request-detail-card profile-section">

      {# Ù‡ÙŠØ¯Ø± Ø¨Ø³ÙŠØ· + Ù…Ø³Ø§Ø± ØªÙ†Ù‚Ù„ #}
      <div class="card-header request-header-section">
        <div class="request-header">
          <div class="request-header-main">
            <div class="request-title-row">
              <h1 class="request-title profile-name">
                Ø±ÙØ¶ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© #{{ agreement.id }}
              </h1>
              <div class="request-badges">
                <span class="badge badge-default">
                  Ø§Ù„Ø·Ù„Ø¨ #{{ agreement.request.id }}
                </span>
                <span class="badge badge-rejected">
                  âŒ Ø±ÙØ¶ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©
                </span>
              </div>
            </div>
            <div class="request-meta">
              <div class="employee-location">
                <a href="{% url 'marketplace:request_detail' agreement.request.id %}"
                   class="link">
                  Ø±Ø¬ÙˆØ¹ Ù„ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨
                </a>
                <span> / </span>
                <a href="{% url 'agreements:detail' agreement.id %}"
                   class="link">
                  ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©
                </a>
              </div>
            </div>
          </div>
          <div class="request-updated-at">
            <span class="text-muted">
              Ø±Ù‚Ù… Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©: {{ agreement.id }}
            </span>
          </div>
        </div>
      </div>

      <div class="card-body request-detail-body">

        {# Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø®ØªØµØ±Ø© Ø¹Ù† Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© #}
        <div class="profile-section">
          <div class="card-section-title">ğŸ“„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</div>
          <div class="summary-grid-inner" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:1rem;">
            <div class="profile-section" style="background:var(--dark-50);">
              <div class="card-subtitle">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</div>
              <div class="card-text">{{ agreement.title }}</div>
            </div>
            <div class="profile-section" style="background:var(--dark-50);">
              <div class="card-subtitle">Ø§Ù„Ù…Ø¨Ù„Øº</div>
              <div class="card-text">
                {{ agreement.grand_total|floatformat:2 }} <span>Ø±ÙŠØ§Ù„</span>
              </div>
            </div>
            <div class="profile-section" style="background:var(--dark-50);">
              <div class="card-subtitle">Ø§Ù„Ù…Ø¯Ø©</div>
              <div class="card-text">
                {{ agreement.duration_days }} ÙŠÙˆÙ…
              </div>
            </div>
            <div class="profile-section" style="background:var(--dark-50);">
              <div class="card-subtitle">Ø§Ù„Ù…ÙˆØ¸Ù</div>
              <div class="card-text">
                {{ agreement.employee_display }}
              </div>
            </div>
          </div>
        </div>

        {# Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… (Django messages) Ø¥Ù† ÙˆÙØ¬Ø¯Øª #}
        {% if messages %}
          <div class="profile-section">
            {% for m in messages %}
              <div class="card-text {% if m.tags == 'error' %}reject-error-box{% else %}profile-section{% endif %}"
                   style="margin-bottom:0.75rem;padding:0.75rem 1rem;">
                {{ m }}
              </div>
            {% endfor %}
          </div>
        {% endif %}

        {# Ù†Ù…ÙˆØ°Ø¬ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ #}
        <div class="profile-section">
          <div class="card-header-row" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <div class="card-section-title">ğŸ“ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶</div>
            <div class="card-section-note">
              Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨Ù‹Ø§ ÙˆØ§Ø¶Ø­Ù‹Ø§ Ù„ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…ÙˆØ¸Ù Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§.
            </div>
          </div>

          {% if form and form.errors %}
            <div class="reject-error-box" style="padding:1rem;margin-bottom:1rem;">
              <ul class="list-disc" style="padding-right:1.25rem;font-size:0.9rem;">
                {% for field, errs in form.errors.items %}
                  {% for e in errs %}
                    <li>{{ e }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          <form method="post" id="reject-form" action="{% url 'agreements:reject' agreement.id %}">
            {% csrf_token %}
            <div class="form-group" style="margin-bottom:1rem;">
              <label for="id_reason" class="form-label" style="font-weight:600;margin-bottom:0.5rem;display:block;">
                Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶
              </label>

              <div class="relative" style="position:relative;">
                <textarea
                  id="id_reason"
                  name="reason"
                  rows="6"
                  minlength="5"
                  maxlength="1000"
                  required
                  class="input"
                  style="width:100%;min-height:140px;resize:vertical;"
                  placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø£Ùˆ Ø§Ù„Ù…Ø¨Ù„Øº Ø£Ùˆ Ø§Ù„Ù…Ø¯Ø©...&#10;&#10;Ù…Ø«Ø§Ù„:&#10;- ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª Ø¥Ù„Ù‰ 10&#10;- ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø¥Ù„Ù‰ 3 Ù…Ø±Ø§Ø­Ù„&#10;- ØªÙ…Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¯Ø© Ø¥Ù„Ù‰ 14 ÙŠÙˆÙ…Ù‹Ø§">{{ reason|default_if_none:'' }}</textarea>

                <div style="position:absolute;bottom:8px;left:10px;display:flex;gap:0.75rem;align-items:center;">
                  <span id="char-counter" class="reject-counter">0 / 1000</span>
                  <span class="card-section-note" style="font-size:0.8rem;">
                    Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¨Ø¨ Ù„Ù„Ù…ÙˆØ¸Ù Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                  </span>
                </div>
              </div>
            </div>

            <div class="reject-info-box" style="padding:0.75rem 1rem;margin-bottom:1rem;">
              <div class="card-text" style="font-size:0.85rem;">
                â€¢ Ø§Ø°ÙƒØ± Ù…Ø§ ØªØ±ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø¨Ø¯Ù‚Ø©. â€¢ Ø§Ù‚ØªØ±Ø­ Ø¨Ø¯ÙŠÙ„Ø§Ù‹ ÙˆØ§Ø¶Ø­Ù‹Ø§ Ø¥Ù† Ø£Ù…ÙƒÙ†. â€¢ ØªØ¬Ù†Ù‘Ø¨ Ø§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©.
              </div>
            </div>

            <div class="employee-actions" style="display:flex;gap:0.75rem;flex-wrap:wrap;margin-top:0.5rem;">
              <button type="submit"
                      class="btn btn-danger btn-sm"
                      id="submit-btn">
                âŒ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¨Ø¨
              </button>

              <a href="{% url 'agreements:detail' agreement.id %}"
                 class="btn btn-outline btn-sm">
                Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©
              </a>
            </div>
          </form>
        </div>

        {# Ù…Ø§Ø°Ø§ ÙŠØ­Ø¯Ø« Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¶ØŸ #}
        <div class="profile-section">
          <div class="card-section-title">â„¹ï¸ Ù…Ø§Ø°Ø§ ÙŠØ­Ø¯Ø« Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¶ØŸ</div>
          <div class="card-text">
            <ul style="padding-right:1.25rem;margin:0;font-size:0.9rem;list-style:disc;">
              <li>ÙŠØ³ØªÙ„Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ ÙˆÙŠØ¬Ø±ÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.</li>
              <li>ØªØ¹Ø§Ø¯ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© Ø¥Ù„ÙŠÙƒ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯.</li>
              <li>ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© Ù…Ù† ØµÙØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„.</li>
            </ul>
          </div>
        </div>

      </div> {# /card-body #}
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var textarea = document.getElementById('id_reason');
    var counter = document.getElementById('char-counter');
    var submitBtn = document.getElementById('submit-btn');
    var form = document.getElementById('reject-form');

    function updateCounter() {
      if (!textarea || !counter) {
        return;
      }
      var max = parseInt(textarea.getAttribute('maxlength')) || 1000;
      var min = parseInt(textarea.getAttribute('minlength')) || 5;
      var len = textarea.value.length;

      counter.textContent = len + ' / ' + max;
      counter.classList.remove('reject-counter-ok', 'reject-counter-bad');

      if (len >= min) {
        counter.classList.add('reject-counter-ok');
      } else {
        counter.classList.add('reject-counter-bad');
      }
    }

    if (textarea) {
      textarea.addEventListener('input', updateCounter);
      updateCounter();
    }

    if (form) {
      form.addEventListener('submit', function () {
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.classList.add('btn-disabled');
        }
      });
    }
  });
</script>
{% endblock %}
