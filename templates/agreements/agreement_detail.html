{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}ุงุชูุงููุฉ ุฎุฏูุฉ โ {{ agreement.title }}{% endblock %}

{% block content %}
<section class="page-section agreement-detail-page" dir="rtl">
  <div class="container">

    {# ุชูุจูู ุทูุจ ุชูุฏูุฏ ุงููููุฉ ููุนููู #}
    {% if agreement.extension_requested_days and agreement.extension_requested_days > 0 and user.is_authenticated and user.id == agreement.request.client.id %}
    <div class="alert alert-warning" style="background:#fffbe6;border:1.5px solid #facc15;color:#b45309;padding:1.5rem 1.2rem;border-radius:14px;margin-bottom:1.5rem;box-shadow:0 2px 8px #facc1533;display:flex;align-items:center;justify-content:space-between;gap:1.5rem;">
      <div style="display:flex;align-items:center;gap:.9rem;">
        <span style="font-size:2.1rem;">โณ</span>
        <div>
          <div style="font-weight:800;font-size:1.1rem;">ุทูุจ ุชูุฏูุฏ ูููุฉ ุงูุชูููุฐ</div>
          <div style="font-size:.98rem;margin-top:.2rem;">ุงูููุธู ุทูุจ ุชูุฏูุฏ ูุฏุฉ ุงูุงุชูุงููุฉ ุจููุฏุงุฑ <b>{{ agreement.extension_requested_days }}</b> ููู. ููููู ุงูููุงููุฉ ุฃู ุงูุฑูุถ.</div>
        </div>
      </div>
      <div style="display:flex;gap:.7rem;">
        <form method="post" action="{% url 'agreements:approve_extension' agreement.pk %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-success" style="font-weight:700;min-width:110px;">โ๏ธ ููุงููุฉ</button>
        </form>
        <form method="post" action="{% url 'agreements:reject_extension' agreement.pk %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger" style="font-weight:700;min-width:110px;">โ ุฑูุถ</button>
        </form>
      </div>
    </div>
    {% endif %}

    {# --- Client Approval / Rejection Actions --- #}
    {% if agreement.status == 'pending' and user.id == agreement.request.client.id %}
    <div class="profile-section scroll-reveal no-print" style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:16px;padding:1.5rem;margin-bottom:1.5rem;">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;">
        <div>
          <h3 style="color:#166534;font-weight:800;margin-bottom:0.5rem;">ูุทููุจ ููุงููุชู</h3>
          <p style="color:#15803d;margin:0;">ูุฑุฌู ูุฑุงุฌุนุฉ ุจููุฏ ุงูุงุชูุงููุฉ ุฃุฏูุงู ูุงูููุงููุฉ ุนูููุง ููุจุฏุก ูู ุงููุดุฑูุนุ ุฃู ุฑูุถูุง ูุน ุฐูุฑ ุงูุณุจุจ.</p>
        </div>
        <div style="display:flex;gap:1rem;">
          <form method="post" action="{% url 'agreements:accept' agreement.pk %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-success" style="font-weight:700;padding:0.75rem 1.5rem;">
              <i class="fas fa-check-circle"></i> ููุงููุฉ ูุงุนุชูุงุฏ
            </button>
          </form>
          <button type="button" class="btn btn-danger" onclick="document.getElementById('rejectModal').style.display='flex'" style="font-weight:700;padding:0.75rem 1.5rem;">
            <i class="fas fa-times-circle"></i> ุฑูุถ ุงูุงุชูุงููุฉ
          </button>
        </div>
      </div>
    </div>
    {% endif %}

    {# --- Rejection Reason Display (For Employee) --- #}
    {% if agreement.status == 'rejected' and agreement.rejection_reason %}
    <div class="profile-section scroll-reveal no-print" style="background:#fef2f2;border:1px solid #fecaca;border-radius:16px;padding:1.5rem;margin-bottom:1.5rem;">
      <div style="display:flex;align-items:flex-start;gap:1rem;">
        <div style="font-size:2rem;">โ๏ธ</div>
        <div style="flex:1;">
          <h3 style="color:#991b1b;font-weight:800;margin-bottom:0.5rem;">ุชู ุฑูุถ ุงูุงุชูุงููุฉ ูู ูุจู ุงูุนููู</h3>
          <div style="background:white;padding:1rem;border-radius:8px;border:1px solid #fee2e2;margin-bottom:1rem;">
            <strong style="color:#7f1d1d;">ุณุจุจ ุงูุฑูุถ:</strong>
            <p style="color:#991b1b;margin-top:0.25rem;">{{ agreement.rejection_reason }}</p>
          </div>
          {% if user.id == agreement.employee.id %}
          <a href="{% url 'agreements:edit' agreement.pk %}" class="btn btn-primary">
            <i class="fas fa-edit"></i> ุชุนุฏูู ุงูุงุชูุงููุฉ ูุฅุนุงุฏุฉ ุงูุฅุฑุณุงู
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <div id="agreementPrintArea">

      <div class="profile-section scroll-reveal" style="border:2px solid #0f172a;border-radius:16px;padding:1.5rem;background:#fff;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
          <div style="display:flex;align-items:center;gap:1rem;">
            <div style="width:64px;height:64px;border-radius:12px;background:#0f172a;color:#fff;display:flex;align-items:center;justify-content:center;font-size:28px;">๐</div>
            <div>
              <div style="font-weight:800;font-size:1.35rem;color:#0f172a;">
                {{ SITE_NAME|default:"SamiLink" }} โ ุงุชูุงููุฉ ุชูุฏูู ุฎุฏูุฉ
              </div>
              <div style="color:#64748b;font-size:.95rem;margin-top:.1rem;">
                ูุซููุฉ ุฅููุชุฑูููุฉ ููุฒูุฉ ููุทุฑููู ููู ุฃูุธูุฉ ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ
              </div>
            </div>
          </div>

          <div style="text-align:left;min-width:220px;">
            <div style="font-size:.95rem;color:#0f172a;">
              ุฑูู ุงูุงุชูุงููุฉ: <b>#{{ agreement.pk }}</b>
            </div>
            <div style="font-size:.95rem;color:#0f172a;">
              ุชุงุฑูุฎ ุงูุฅูุดุงุก: <b>{{ agreement.created_at|date:"Y-m-d" }}</b>
            </div>
            <div style="font-size:.9rem;color:#64748b;margin-top:.1rem;">
              ููุช ุงููุธุงู: {{ now|date:"Y-m-d H:i" }}
            </div>
          </div>
        </div>

        <hr style="margin:1rem 0;border-color:#e2e8f0;">

        <div style="font-size:.98rem;line-height:1.9;color:#0f172a;">
          ุชู ุฅุจุฑุงู ูุฐู ุงูุงุชูุงููุฉ ุฅููุชุฑููููุง ุนุจุฑ ููุตุฉ <b>{{ SITE_NAME|default:"SamiLink" }}</b>ุ ูููุนุฏู ูุฐุง ุงููุณุชูุฏ
          ุณุฌููุง ุฅููุชุฑููููุง ูู ุญุฌูุฉ ุงูุฅุซุจุงุชุ ููุง ููููุฑ ุฃุซุฑู ููุฌุฑุฏ ูููู ุฅููุชุฑููููุงุ ููู ูุธุงู ุงูุชุนุงููุงุช ุงูุฅููุชุฑูููุฉ ุจุงูููููุฉ.
        </div>
      </div>

      <div class="profile-section scroll-reveal" style="margin-top:1.25rem;">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;">

          <div class="stat-item text-center" style="background:#f1f5f9;padding:1.25rem;border-radius:14px;border:1px solid #e2e8f0;">
            <div style="color:#0f172a;font-weight:700;margin-bottom:.4rem;">ุงูุฅุฌูุงูู ุงููุทููุจ ูู ุงูุนููู</div>
            <div style="font-size:1.7rem;font-weight:900;color:#2563eb;">
              {{ breakdown.client_total|floatformat:2 }} ุฑ.ุณ
            </div>
            <div style="font-size:.8rem;color:#64748b;margin-top:.25rem;">ูุดูู ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ</div>
          </div>

          <div class="stat-item text-center" style="background:#f8fafc;padding:1.25rem;border-radius:14px;border:1px solid #e2e8f0;">
            <div style="color:#0f172a;font-weight:700;margin-bottom:.4rem;">ูุฏุฉ ุงูุชูููุฐ</div>
            <div style="font-size:1.35rem;font-weight:800;color:#0f172a;">
              {{ agreement.duration_days }} ููู
            </div>
          </div>

          <div class="stat-item text-center" style="background:#f8fafc;padding:1.25rem;border-radius:14px;border:1px solid #e2e8f0;">
            <div style="color:#0f172a;font-weight:700;margin-bottom:.4rem;">ุญุงูุฉ ุงูุงุชูุงููุฉ</div>
            <div style="font-size:1.15rem;font-weight:800;color:#0f172a;">
              {{ agreement.get_status_display }}
            </div>
          </div>

          <div class="stat-item text-center" style="background:#f8fafc;padding:1.25rem;border-radius:14px;border:1px solid #e2e8f0;">
            <div style="color:#0f172a;font-weight:700;margin-bottom:.4rem;">ุฑูู ุงูุทูุจ ุงููุฑุชุจุท</div>
            <div style="font-size:1.2rem;font-weight:800;">
              <a href="{% url 'marketplace:request_detail' agreement.request.id %}" class="link">#{{ agreement.request.id }}</a>
            </div>
          </div>
        </div>
      </div>

      {% if can_view_financials %}
        <div class="profile-section scroll-reveal" style="margin-top:1.25rem;">
          <h2 class="section-title" style="margin-bottom:.75rem;">ุชูุงุตูู ูุงููุฉ (ููุงุณุชุฎุฏุงู ุงูุฏุงุฎูู)</h2>

          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;">
            <div class="stat-item text-center" style="background:#fff;padding:1rem;border-radius:12px;border:1px solid #e2e8f0;">
              <div style="font-size:.9rem;color:#64748b;">ุงูุณุนุฑ ูุจู ุงูุถุฑูุจุฉ (P)</div>
              <div style="font-size:1.1rem;font-weight:800;color:#0f172a;">{{ breakdown.project_price|floatformat:2 }} ุฑ.ุณ</div>
            </div>

            <div class="stat-item text-center" style="background:#fff;padding:1rem;border-radius:12px;border:1px solid #e2e8f0;">
              <div style="font-size:.9rem;color:#64748b;">ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ (VAT)</div>
              <div style="font-size:1.1rem;font-weight:800;color:#0f172a;">{{ breakdown.vat_amount|floatformat:2 }} ุฑ.ุณ</div>
              <div style="font-size:.8rem;color:#94a3b8;">{{ breakdown.vat_rate|floatformat:4 }}</div>
            </div>

            <div class="stat-item text-center" style="background:#fff;padding:1rem;border-radius:12px;border:1px solid #e2e8f0;">
              <div style="font-size:.9rem;color:#64748b;">ุนูููุฉ ุงูููุตูุฉ (ุชูุฎุตู ูู ุงูููุธู)</div>
              <div style="font-size:1.1rem;font-weight:800;color:#0f172a;">{{ breakdown.platform_fee_value|floatformat:2 }} ุฑ.ุณ</div>
              <div style="font-size:.8rem;color:#94a3b8;">{{ breakdown.fee_percent|floatformat:4 }}</div>
            </div>

            <div class="stat-item text-center" style="background:#fff;padding:1rem;border-radius:12px;border:1px solid #e2e8f0;">
              <div style="font-size:.9rem;color:#64748b;">ุตุงูู ุงูููุธู</div>
              <div style="font-size:1.1rem;font-weight:900;color:#16a34a;">{{ breakdown.tech_payout|floatformat:2 }} ุฑ.ุณ</div>
            </div>
          </div>
        </div>
      {% endif %}

      <div class="profile-section scroll-reveal" style="margin-top:1.25rem;">
        <h2 class="section-title">ุฃูููุง: ุฃุทุฑุงู ุงูุงุชูุงููุฉ</h2>

        <div style="background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:1.25rem;line-height:2;margin-top:.75rem;">
          <p>
            1) <b>ุงูุทุฑู ุงูุฃูู (ุงูุนููู):</b>
            {{ agreement.client_display }}
            {% if agreement.client_phone %} โ ุฌูุงู: {{ agreement.client_phone }}{% endif %}
            {% if agreement.client_email %} โ ุจุฑูุฏ: {{ agreement.client_email }}{% endif %}
            {% if agreement.client_national_id %} โ ูููุฉ/ุณุฌู: {{ agreement.client_national_id }}{% endif %}
          </p>

          <p>
            2) <b>ุงูุทุฑู ุงูุซุงูู (ุงูููุธู/ููุฏู ุงูุฎุฏูุฉ):</b>
            {{ agreement.employee_display }}
            {% if agreement.employee_phone %} โ ุฌูุงู: {{ agreement.employee_phone }}{% endif %}
            {% if agreement.employee_email %} โ ุจุฑูุฏ: {{ agreement.employee_email }}{% endif %}
            {% if agreement.employee_national_id %} โ ูููุฉ/ุณุฌู: {{ agreement.employee_national_id }}{% endif %}
          </p>

          <p>
            3) <b>ุงูุทุฑู ุงูุซุงูุซ (ุงูููุตูุฉ):</b>
            {{ PLATFORM_OFFICIAL_NAME|default:"ููุตุฉ ุณุงูู ูููู" }}
            {% if PLATFORM_CR_NUMBER %} โ ุณ.ุช: {{ PLATFORM_CR_NUMBER }}{% endif %}
            ูููุชุตุฑ ุฏูุฑูุง ุนูู ุงููุณุงุทุฉ ุงูุชูููุฉ ูุชูุธูู ุงููุฏููุนุงุช ูุงูุชูุซูู ุงูุฅููุชุฑููู ุฏูู ุฃู ุชููู ุทุฑููุง ูู ุชูููุฐ ุงูุฎุฏูุฉ.
          </p>
        </div>
      </div>

      <div class="profile-section scroll-reveal" style="margin-top:1.25rem;">
        <h2 class="section-title">ุซุงูููุง: ููุถูุน ุงูุงุชูุงููุฉ ููุทุงู ุงูุฎุฏูุฉ</h2>

        <div style="background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:1.25rem;line-height:2;margin-top:.75rem;">
          <p>
            ุงุชูู ุงูุทุฑูุงู ุนูู ููุงู ุงูุทุฑู ุงูุซุงูู ุจุชูููุฐ ุฎุฏูุฉ/ุนูู ุจุนููุงู:
            <b>"{{ agreement.title }}"</b>
            ููู ูุตู ุงูุทูุจ ุฑูู <b>#{{ agreement.request.id }}</b> ููุง ูุฑุฏ ูู ูุฐู ุงูุงุชูุงููุฉ ูุจููุฏูุง.
          </p>

          {% if agreement.text %}
          <div style="margin-top:.75rem;padding:.9rem;border-radius:12px;background:#f8fafc;border:1px dashed #cbd5e1;">
            <div style="font-weight:800;margin-bottom:.35rem;">ูุตู ุชูุตููู ููุฎุฏูุฉ:</div>
            <div style="white-space:pre-line;color:#0f172a;">{{ agreement.text }}</div>
          </div>
          {% endif %}

          <p style="margin-top:.75rem;">
            ููุชุฒู ุงูุทุฑู ุงูุซุงูู ุจุชูุฏูู ุงููุฎุฑุฌุงุช ุงููุชูู ุนูููุง ุจุงููุณุชูู ุงููููู ุงููุชุนุงุฑู ุนูููุ ูุจูุง ูุญูู ุงูุบุฑุถ ุงููุดุฑูุน ููุงุชูุงููุฉ.
          </p>
        </div>
      </div>

      <div class="profile-section scroll-reveal" style="margin-top:1.25rem;">
        <h2 class="section-title">ุซุงูุซูุง: ุงููุฏุฉ ูุขููุฉ ุงูุชูููุฐ</h2>

        <div style="background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:1.25rem;line-height:2;margin-top:.75rem;">
          <p>
            ูุฏุฉ ุชูููุฐ ุงูุฎุฏูุฉ: <b>{{ agreement.duration_days }} ููููุง</b> ุชุจุฏุฃ ูู ุชุงุฑูุฎ ุงุนุชูุงุฏ ุงูุงุชูุงููุฉ ูู ุงูุทุฑู ุงูุฃูู.
          </p>
          <p>
            ูุชู ุชูููุฐ ุงูุฎุฏูุฉ ุนุจุฑ ูููุงุช ุงูููุตูุฉ ุงูุฑุณููุฉุ ูููุนุฏู ุงูุชูุงุตู ุฏุงุฎู ุงูููุตูุฉ ุฌุฒุกูุง ูู ุณุฌู ุงูุฅุซุจุงุช.
          </p>
          <p>
            ุฃู ุชุนุฏูู ุฌููุฑู ูู ุงููุทุงู ุฃู ุงููุฏุฉ ูุชุทูุจ ููุงููุฉ ุฅููุชุฑูููุฉ ุตุฑูุญุฉ ูู ุงูุทุฑููู ุนุจุฑ ุงูููุตูุฉ.
          </p>
        </div>
      </div>

      <div class="profile-section scroll-reveal" style="margin-top:1.25rem;">
        <h2 class="section-title">ุฑุงุจุนูุง: ุงูููุงุจู ุงููุงูู ูุขููุฉ ุงูุฏูุน</h2>

        <div style="background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:1.25rem;line-height:2;margin-top:.75rem;">
          <p>
            ุฅุฌูุงูู ุงูููุงุจู ุงููุงูู ุงููุทููุจ ูู ุงูุทุฑู ุงูุฃูู (ุงูุนููู):  
            <b>{{ breakdown.client_total|floatformat:2 }} ุฑูุงู ุณุนูุฏู</b> ุดุงููุฉ ูุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ.
          </p>
          <p>
            ุชุชู ุงููุฏููุนุงุช ุญุตุฑููุง ุนุจุฑ ุจูุงุจุฉ ุงูููุตูุฉุ ููุง ูุนุชุฏ ุจุฃู ุฏูุน ุฎุงุฑุฌูุง ูู ุฅุซุจุงุช ุงูุญููู.
          </p>
          <p>
            ุชูุณุชุญู ุงููุจุงูุบ ููุทุฑู ุงูุซุงูู ููู ุงููุฑุงุญู/ุงูููุงุชูุฑ ุงููุนุชูุฏุฉ ุฏุงุฎู ุงูููุตูุฉุ ูุจุนุฏ ุฅุชูุงู ุฅุฌุฑุงุกุงุช ุงูุชุญูู.
          </p>
        </div>
      </div>



      <div class="profile-section scroll-reveal" style="margin-top:1.25rem;">
        <h2 class="section-title">ุฎุงูุณูุง: ุงูุจููุฏ ูุงูุดุฑูุท ุงูุฎุงุตุฉ</h2>

        {% if agreement.clause_items.count == 0 %}
          <div class="profile-section" style="background:#fff7ed;border:1px solid #fed7aa;border-radius:14px;margin-top:.75rem;">
            <div style="font-weight:800;color:#9a3412;">ูุง ุชูุฌุฏ ุจููุฏ ูุฎุตุตุฉ ูุถุงูุฉ ุจุนุฏ.</div>
            <div style="color:#9a3412;font-size:.95rem;margin-top:.25rem;">
              ูููุตุญ ุจุฅุถุงูุฉ ุจููุฏ ูุงุถุญุฉ ูุจู ุงูุทุจุงุนุฉ ุงูููุงุฆูุฉ.
            </div>
          </div>
        {% endif %}

        <div style="margin-top:.75rem;display:flex;flex-direction:column;gap:.75rem;">
          {% for item in agreement.clause_items.all %}
            <div class="profile-section" style="background:#fff;border:1px solid #e2e8f0;border-radius:14px;">
              <div style="display:flex;gap:.8rem;align-items:flex-start;">
                <div style="width:34px;height:34px;border-radius:999px;background:#e0e7ff;color:#1d4ed8;display:flex;align-items:center;justify-content:center;font-weight:800;flex:0 0 auto;">
                  {{ forloop.counter }}
                </div>
                <div style="line-height:1.9;color:#0f172a;">
                  {% if item.clause %}
                    <div style="font-weight:800;margin-bottom:.25rem;">{{ item.clause.title }}</div>
                    <div style="white-space:pre-line;">{{ item.clause.body }}</div>
                  {% else %}
                    <div style="white-space:pre-line;">{{ item.custom_text }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="profile-section scroll-reveal" style="margin-top:1.25rem;">
        <h2 class="section-title">ุณุงุฏุณูุง: ุงูุณุฑูุฉ ูุญููู ุงูููููุฉ ุงูููุฑูุฉ</h2>

        <div style="background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:1.25rem;line-height:2;margin-top:.75rem;">
          <p>
            ููุชุฒู ุงูุทุฑูุงู ุจุงูุญูุงุธ ุนูู ุณุฑูุฉ ุฃู ุจูุงูุงุช ุฃู ูููุงุช ุฃู ูุนูููุงุช ูุชู ุชุจุงุฏููุง ุจุณุจุจ ูุฐู ุงูุงุชูุงููุฉุ
            ูุนุฏู ุฅูุดุงุฆูุง ูุฃู ุทุฑู ุซุงูุซ ุฅูุง ุจููุงููุฉ ููุชูุจุฉ ุฃู ูุฌูุฉ ุฑุณููุฉ ูุฎุชุตุฉ.
          </p>
          <p>
            ูุง ูู ูููุต ุนูู ุฎูุงูู ูู ุจููุฏ ุฎุงุตุฉุ ุชููู ูุฎุฑุฌุงุช ุงูุฎุฏูุฉ ููุทุฑู ุงูุฃูู ุจุนุฏ ุณุฏุงุฏ ูุงูู ุงูููุงุจู ุงููุงููุ
            ูุน ุงุญุชูุงุธ ุงูุทุฑู ุงูุซุงูู ุจุญูู ูู ุงูุฎุจุฑุงุช ูุงูุฃุฏูุงุช ุงูุนุงูุฉ ุบูุฑ ุงูุฎุงุตุฉ ุจุณุฑูุฉ ุงูุนููู.
          </p>
        </div>
      </div>

      <div class="profile-section scroll-reveal" style="margin-top:1.25rem;">
        <h2 class="section-title">ุณุงุจุนูุง: ุงูุฅููุงุก ูุงูููุฉ ุงููุงูุฑุฉ</h2>

        <div style="background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:1.25rem;line-height:2;margin-top:.75rem;">
          <p>
            1) ูุญู ูุฃู ุทุฑู ุทูุจ ุฅููุงุก ุงูุงุชูุงููุฉ ุนูุฏ ุฅุฎูุงู ุงูุทุฑู ุงูุขุฎุฑ ุจุงูุชุฒุงู ุฌููุฑูุ ุจุนุฏ ุฅุดุนุงุฑู ุนุจุฑ ุงูููุตูุฉ ูููุญู ูููุฉ ููุงุณุจุฉ ูููุนุงูุฌุฉ.
          </p>
          <p>
            2) ูู ุญุงู ุงูููุฉ ุงููุงูุฑุฉ ุฃู ุงูุธุฑูู ุงูุฎุงุฑุฌุฉ ุนู ุงูุฅุฑุงุฏุฉุ ูุนููู ุงูุชูููุฐ ุฎูุงู ูุชุฑุฉ ุงูุนุฐุฑุ
            ููุชู ุงูุงุชูุงู ุนูู ุชูุฏูุฏ ุงููุฏุฉ ุฏูู ูุณุคูููุฉ.
          </p>
        </div>
      </div>

      <div class="profile-section scroll-reveal" style="margin-top:1.25rem;">
        <h2 class="section-title">ุซุงูููุง: ุชุณููุฉ ุงููุฒุงุนุงุช ูุงูุงุฎุชุตุงุต ุงููุถุงุฆู</h2>

        <div style="background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:1.25rem;line-height:2;margin-top:.75rem;">
          <p>
            ุชูุฏุงุฑ ุงููุฒุงุนุงุช ุนุจุฑ ูุธุงู ุงููุฒุงุนุงุช ุฏุงุฎู ุงูููุตูุฉ ุฃูููุงุ ููููุชุฒู ุจุฅุฌุฑุงุกุงุชูุง ูุณุฌูุงุชูุง ุงูุฅููุชุฑูููุฉ.
          </p>
          <p>
            ูู ุญุงู ุนุฏู ุงูุชูุตู ูุญู ูุฏูุ ุชุฎุชุต <b>ูุญุงูู ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ</b> ุจุงููุธุฑ ูู ุงููุฒุงุนุ
            ููููู ุงููุธุงู ุงููุทุจู ูู ุฃูุธูุฉ ุงูููููุฉ ุงููุงูุฐุฉ.
          </p>
        </div>
      </div>

      <div class="profile-section scroll-reveal" style="margin-top:1.25rem;">
        <h2 class="section-title">ุชุงุณุนูุง: ุงูุฅูุฑุงุฑุงุช ูุงูุชูููุน</h2>

        <div style="background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:1.25rem;line-height:2;margin-top:.75rem;">
          <p>
            ููุฑ ุงูุทุฑูุงู ุจุฃูููุชููุง ุงูุดุฑุนูุฉ ูุงููุธุงููุฉ ููุชุนุงูุฏุ ูุจุฃู ูุจููููุง ุงูุฅููุชุฑููู ููุฐู ุงูุงุชูุงููุฉ
            ููุนุฏู ุชูููุนูุง ุฅููุชุฑููููุง ุตุญูุญูุง ููุชุฌูุง ูุขุซุงุฑู ุงููุธุงููุฉ.
          </p>
          <p>
            ุชูุซู ุณุฌูุงุช ุงูููุตูุฉ (ุงููุจููุ ุงููุฑุงุณูุงุชุ ุงูููุงุชูุฑุ ุงูุชุณูููุงุช) ูุณุงุฆู ุฅุซุจุงุช ูุนุชุจุฑุฉ ุฃูุงู ุงูุฌูุงุช ุงููุถุงุฆูุฉ.
          </p>
        </div>

        <div class="signatures-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem;margin-top:1rem;">
          <div class="profile-section text-center" style="background:#f8fafc;border:1px dashed #94a3b8;">
            <div style="font-size:.9rem;color:#64748b;">ุชูููุน ุงูุทุฑู ุงูุฃูู (ุงูุนููู)</div>
            <div style="font-weight:800;font-size:1.1rem;color:#0f172a;margin-top:.35rem;">
              {{ agreement.client_display }}
            </div>
            <div style="margin-top:1.25rem;height:56px;border-bottom:2px solid #0f172a;width:80%;margin-inline:auto;"></div>
            <div style="font-size:.8rem;color:#64748b;margin-top:.35rem;">
              ุชูููุน ุฅููุชุฑููู ุนุจุฑ ุงูููุตูุฉ
            </div>
          </div>

          <div class="profile-section text-center" style="background:#f8fafc;border:1px dashed #94a3b8;">
            <div style="font-size:.9rem;color:#64748b;">ุชูููุน ุงูุทุฑู ุงูุซุงูู (ุงูููุธู)</div>
            <div style="font-weight:800;font-size:1.1rem;color:#0f172a;margin-top:.35rem;">
              {{ agreement.employee_display }}
            </div>
            <div style="margin-top:1.25rem;height:56px;border-bottom:2px solid #0f172a;width:80%;margin-inline:auto;"></div>
            <div style="font-size:.8rem;color:#64748b;margin-top:.35rem;">
              ุชูููุน ุฅููุชุฑููู ุนุจุฑ ุงูููุตูุฉ
            </div>
          </div>
        </div>
      </div>

    </div>

    <div class="profile-section scroll-reveal no-print" style="margin-top:1.25rem;background:#f8fafc;">
      <div style="display:flex;gap:.75rem;justify-content:space-between;flex-wrap:wrap;">
        <div style="display:flex;gap:.6rem;flex-wrap:wrap;">
          {% if user.is_authenticated %}
            {% if user.is_staff or user.is_superuser or user.id == agreement.employee_id %}
              <a href="{% url 'agreements:edit' agreement.pk %}" class="btn btn-secondary">โ๏ธ ุชุญุฑูุฑ ุงูุงุชูุงููุฉ</a>
            {% endif %}
          {% endif %}
        </div>
        <div style="display:flex;gap:.6rem;flex-wrap:wrap;">
          <button id="printAgreementBtn" type="button" class="btn btn-success">๐จ๏ธ ุทุจุงุนุฉ ุงููุซููุฉ A4</button>
          <a href="{% url 'marketplace:request_detail' agreement.request.id %}" class="btn btn-outline">โฉ๏ธ ุงูุนูุฏุฉ ููุทูุจ</a>
        </div>
      </div>
    </div>

  </div>
</section>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}

{# --- Rejection Modal --- #}
<div id="rejectModal" class="modal-overlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;">
  <div class="modal-content" style="background:white;padding:2rem;border-radius:16px;width:90%;max-width:500px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);">
    <h3 style="margin-top:0;margin-bottom:1rem;color:#991b1b;">ุฑูุถ ุงูุงุชูุงููุฉ</h3>
    <form method="post" action="{% url 'agreements:reject' agreement.pk %}">
      {% csrf_token %}
      <div style="margin-bottom:1.5rem;">
        <label style="display:block;margin-bottom:0.5rem;font-weight:600;">ุณุจุจ ุงูุฑูุถ (ูุทููุจ):</label>
        <textarea name="rejection_reason" required style="width:100%;padding:0.75rem;border:1px solid #e2e8f0;border-radius:8px;min-height:100px;" placeholder="ูุฑุฌู ุชูุถูุญ ุณุจุจ ุงูุฑูุถ ููุชููู ุงูููุธู ูู ุชุนุฏูู ุงูุงุชูุงููุฉ..."></textarea>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:1rem;">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('rejectModal').style.display='none'">ุฅูุบุงุก</button>
        <button type="submit" class="btn btn-danger">ุชุฃููุฏ ุงูุฑูุถ</button>
      </div>
    </form>
  </div>
</div>

<script>
(function() {
  if (typeof initScrollReveal === 'function') {
    initScrollReveal();
  }

  document.querySelectorAll('.btn').forEach(function(button){
    button.addEventListener('click', function() {
      if (typeof animateButtonClick === 'function') {
        animateButtonClick(this);
      }
    });
  });

  var printBtn = document.getElementById('printAgreementBtn');
  var printArea = document.getElementById('agreementPrintArea');

  if (printBtn && printArea) {
    printBtn.addEventListener('click', function() {
      var win = window.open('', '_blank', 'width=900,height=1200');
      var html = `
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/app-new.css' %}">
  <style>
    @page { size: A4; margin: 12mm; }
    body { font-family: "Tajawal", sans-serif; background:#fff; color:#000; }
    .container { max-width: 100%; }
    .profile-section { box-shadow:none !important; page-break-inside: avoid; }
    a { color:#000 !important; text-decoration:none !important; }
    .no-print { display:none !important; }
  </style>
</head>
<body>
  <div class="container">
    ${printArea.innerHTML}
  </div>
  <script>
    window.onload = function() { window.print(); window.close(); };
  <\/script>
</body>
</html>`;
      win.document.open();
      win.document.write(html);
      win.document.close();
    });
  }
})();
</script>

<style>
.agreement-detail-page .profile-section {
  transition: all 0.3s ease;
}
.agreement-detail-page .profile-section:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}
.agreement-detail-page .stat-item {
  transition: all 0.3s ease;
}
.agreement-detail-page .stat-item:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-lg);
}
.agreement-detail-page .link {
  color: var(--primary-600);
  text-decoration: none;
  transition: var(--transition);
}
.agreement-detail-page .link:hover {
  color: var(--primary-700);
  text-decoration: underline;
}
@media (max-width: 768px) {
  .agreement-detail-page .signatures-grid {
    grid-template-columns: 1fr;
  }
  .agreement-detail-page .profile-section > div[style*="display:flex"] {
    flex-direction: column;
    align-items: flex-start;
  }
  .agreement-detail-page .profile-section > div[style*="display:flex"] > div {
    width: 100%;
  }
}
@media print {
  .no-print, .main-header, .main-footer {
    display: none !important;
  }
  #agreementPrintArea {
    width: 100% !important;
  }
  .profile-section {
    box-shadow: none !important;
    border: 1px solid #000 !important;
  }
  body {
    background: #fff !important;
    color: #000 !important;
  }
  a {
    color: #000 !important;
    text-decoration: none !important;
  }
}
</style>
{% endblock %}
