{# agreements/templates/agreements/finalize_clauses.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}ØªØ«Ø¨ÙŠØª Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© #{{ agreement.id }}{% endblock %}

{% block content %}
<section class="page-section finalize-clauses-page">
  <div class="container">
    
    {# ===== Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© ===== #}
    <div class="section-header" style="text-align: right; margin-bottom: 2rem;">
      <div class="section-badge">
        ğŸ“ ØªØ«Ø¨ÙŠØª Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©
      </div>
      <h1 class="section-title">
        ØªØ«Ø¨ÙŠØª/ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©
      </h1>
      <p class="section-description">
        Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙˆØ£Ø¶Ù Ø¨Ù†ÙˆØ¯Ù‹Ø§ Ù…Ø®ØµÙ‘ØµØ©. Ø³ÙŠÙØ­ÙÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨: Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ø£ÙˆÙ„Ù‹Ø§ Ø«Ù… Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø®ØµÙ‘ØµØ©.
      </p>
    </div>

    {# ===== Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© ===== #}
    <div class="profile-section" style="background: linear-gradient(135deg, var(--primary-50) 0%, var(--white) 100%); margin-bottom: 2rem;">
      <div class="card-row" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
        <div class="card-icon" style="width: 3rem; height: 3rem; background: var(--primary-100); color: var(--primary-600); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
          ğŸ“„
        </div>
        <h2 class="card-section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</h2>
      </div>

      <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <div class="info-item profile-section" style="padding: 1rem; background: var(--white);">
          <div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</div>
          <div class="info-value">#{{ agreement.id }}</div>
        </div>
        <div class="info-item profile-section" style="padding: 1rem; background: var(--white);">
          <div class="info-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
          <div class="info-value">{{ agreement.title }}</div>
        </div>
        <div class="info-item profile-section" style="padding: 1rem; background: var(--white);">
          <div class="info-label">Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ</div>
          <div class="info-value">
            <a href="{% url 'marketplace:request_detail' agreement.request.id %}" class="link">
              #{{ agreement.request.id }}
            </a>
          </div>
        </div>
      </div>
    </div>

    <form method="post" class="clauses-form" novalidate>
      {% csrf_token %}

      {# ===== Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ===== #}
      <div class="profile-section" style="margin-bottom: 2rem;">
        <div class="card-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="card-icon" style="width: 3rem; height: 3rem; background: var(--primary-100); color: var(--primary-600); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
              âœ…
            </div>
            <div>
              <h2 class="card-section-title">Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h2>
              <p class="card-section-note">Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© (Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯)</p>
            </div>
          </div>
          <div class="search-box">
            <input id="clause-filter" type="text" class="input" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨Ù†ÙˆØ¯...">
          </div>
        </div>

        {% if form.clauses.errors %}
          <div class="error-alert profile-section" style="background: #fef2f2; border-color: #fecaca; margin-bottom: 1.5rem;">
            <div class="card-row" style="display: flex; align-items: flex-start; gap: 1rem;">
              <span class="error-icon" style="color: #ef4444; font-size: 1.2rem;">âŒ</span>
              <div class="error-content">
                <div class="card-section-title" style="color: #dc2626; margin-bottom: 0.25rem;">
                  Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
                </div>
                <ul style="color: #b91c1c; margin: 0; padding-right: 1rem;">
                  {% for e in form.clauses.errors %}<li>{{ e }}</li>{% endfor %}
                </ul>
              </div>
            </div>
          </div>
        {% endif %}

        <div id="clause-list" class="clauses-list scroll-reveal">
          {% for checkbox in form.clauses %}
            <div class="clause-item profile-section">
              <label class="clause-label">
                {{ checkbox.tag }}
                <div class="clause-content">
                  <div class="clause-header">
                    <span class="clause-dot"></span>
                    <span class="clause-title">{{ checkbox.choice_label }}</span>
                  </div>
                </div>
              </label>
            </div>
          {% endfor %}
        </div>

        <div class="clause-actions employee-actions" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--dark-200);">
          <button type="button" id="select-all" class="btn btn-outline btn-sm">
            âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
          </button>
          <button type="button" id="unselect-all" class="btn btn-outline btn-sm">
            âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„
          </button>
          <span class="selection-count" style="color: var(--dark-500); font-size: 0.875rem;">
            ØªÙ… ØªØ­Ø¯ÙŠØ¯ <span id="selected-count">0</span> Ø¨Ù†Ø¯
          </span>
        </div>
      </div>

      {# ===== Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø®ØµÙ‘ØµØ© ===== #}
      <div class="profile-section" style="margin-bottom: 2rem;">
        <div class="card-row" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
          <div class="card-icon" style="width: 3rem; height: 3rem; background: var(--secondary-100); color: var(--secondary-600); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
            âœï¸
          </div>
          <div>
            <h2 class="card-section-title">Ø¨Ù†ÙˆØ¯ Ù…Ø®ØµÙ‘ØµØ©</h2>
            <p class="card-section-note">Ø£Ø¶Ù Ø¨Ù†ÙˆØ¯Ù‹Ø§ Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ ÙƒÙ„ Ø­Ù‚Ù„ ÙŠÙ…Ø«Ù„ Ø¨Ù†Ø¯Ù‹Ø§ Ù…Ø³ØªÙ‚Ù„Ù‹Ø§.</p>
          </div>
        </div>

        {% if form.custom_clauses.errors %}
          <div class="error-alert profile-section" style="background: #fef2f2; border-color: #fecaca; margin-bottom: 1.5rem;">
            <div class="card-row" style="display: flex; align-items: flex-start; gap: 1rem;">
              <span class="error-icon" style="color: #ef4444; font-size: 1.2rem;">âŒ</span>
              <div class="error-content">
                <div class="card-section-title" style="color: #dc2626; margin-bottom: 0.25rem;">
                  Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø®ØµØµØ©
                </div>
                <ul style="color: #b91c1c; margin: 0; padding-right: 1rem;">
                  {% for e in form.custom_clauses.errors %}<li>{{ e }}</li>{% endfor %}
                </ul>
              </div>
            </div>
          </div>
        {% endif %}

        <div class="custom-clauses-field">
          {# Ø­Ù‚Ù„ Ø§Ù„ÙÙˆØ±Ù… Ø§Ù„Ø£ØµÙ„ÙŠ (ÙŠÙØ³ØªØ®Ø¯Ù… Ù„Ù„ØªØ®Ø²ÙŠÙ† ÙÙ‚Ø· ÙˆÙŠÙØ®ÙÙ‰ Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…) #}
          {{ form.custom_clauses }}
          {# Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù„Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø®ØµØµØ© #}
          <div id="custom-clauses-rows" class="custom-clauses-rows"></div>

          <button type="button" id="add-custom-clause" class="btn btn-outline btn-sm" style="margin-top: 1rem;">
            â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯
          </button>

          <div class="field-hint" style="margin-top: 0.5rem;">
            ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ«Ø± Ù…Ù† Ø¨Ù†Ø¯ØŒ ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± Ø§Ù„Ø­Ø°Ù Ù„Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø¨Ù†Ø¯. Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨Ù†ÙˆØ¯ ÙƒØ³Ø·ÙˆØ± Ù…Ù†ÙØµÙ„Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….
          </div>
        </div>
      </div>

      {# ===== Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø«Ø¨ØªØ© ===== #}
      <div class="profile-section" style="margin-bottom: 2rem;">
        <div class="card-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="card-icon" style="width: 3rem; height: 3rem; background: var(--dark-100); color: var(--dark-600); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
              ğŸ‘ï¸
            </div>
            <h2 class="card-section-title">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
          </div>
          <span class="badge badge-default">
            {{ agreement.clause_items.count }} Ø¨Ù†Ø¯/Ø¨Ù†ÙˆØ¯ Ù…Ø«Ø¨ØªØ©
          </span>
        </div>

        <div class="preview-list">
          {% for item in agreement.clause_items.all %}
            <div class="preview-item profile-section scroll-reveal">
              <div class="preview-content">
                <div class="preview-number">{{ forloop.counter }}</div>
                <div class="preview-text">
                  {% if item.clause %}
                    <strong class="preview-title">{{ item.clause.title }}:</strong>
                    <span class="preview-body">{{ item.clause.body }}</span>
                  {% else %}
                    <span class="preview-custom">{{ item.custom_text }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
          {% empty %}
            <div class="empty-preview profile-section text-center" style="padding: 3rem 2rem; background: var(--dark-50);">
              <div class="empty-icon" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">ğŸ“„</div>
              <h3 class="card-section-title" style="margin-bottom: 0.5rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ù…Ø«Ø¨ØªØ©</h3>
              <p class="card-section-note">Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø«Ø¨ØªØ© Ù‡Ù†Ø§</p>
            </div>
          {% endfor %}
        </div>
      </div>

      {# ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ===== #}
      <div class="form-actions employee-actions" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--dark-200);">
        <button type="submit" class="btn btn-primary">
          ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨Ù†ÙˆØ¯
        </button>
        <a href="{% url 'agreements:detail' agreement.id %}" class="btn btn-outline">
          â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªÙØ§ØµÙŠÙ„
        </a>
      </div>
    </form>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script>
  (function(){
    // ØªÙ‡ÙŠØ¦Ø© ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØªÙ…Ø±ÙŠØ±
    if (typeof initScrollReveal === 'function') {
      initScrollReveal();
    }

    // ØªÙ‡ÙŠØ¦Ø© ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    if (typeof initButtonEffects === 'function') {
      initButtonEffects();
    }

    const filterInput = document.getElementById('clause-filter');
    const list = document.getElementById('clause-list');
    const selAll = document.getElementById('select-all');
    const unselAll = document.getElementById('unselect-all');
    const selectedCount = document.getElementById('selected-count');

    function normalize(s){ return (s || '').toString().trim().toLowerCase(); }

    function updateSelectedCount() {
      if (!list || !selectedCount) return;
      const checked = list.querySelectorAll('input[type="checkbox"]:checked').length;
      selectedCount.textContent = checked;
    }

    function updateClauseItems() {
      if (!list) return;
      const items = list.querySelectorAll('.clause-item');
      items.forEach(function(item){
        const checkbox = item.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked) {
          item.classList.add('selected');
          item.style.background = 'var(--primary-50)';
          item.style.borderColor = 'var(--primary-300)';
        } else {
          item.classList.remove('selected');
          item.style.background = '';
          item.style.borderColor = '';
        }
      });
      updateSelectedCount();
    }

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨Ù†ÙˆØ¯
    if (filterInput) {
      filterInput.addEventListener('input', function(){
        const q = normalize(this.value);
        if (!list) return;
        const items = list.querySelectorAll('.clause-item');
        items.forEach(function(item){
          const label = item.querySelector('.clause-title');
          const txt = normalize(label ? label.textContent : '');
          const isVisible = txt.includes(q);
          item.style.display = isVisible ? '' : 'none';
        });

        if (q.length > 0) {
          filterInput.style.borderColor = 'var(--primary-500)';
          filterInput.style.boxShadow = '0 0 0 3px rgba(34, 197, 94, 0.1)';
        } else {
          filterInput.style.borderColor = '';
          filterInput.style.boxShadow = '';
        }
      });
    }

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
    if (selAll) {
      selAll.addEventListener('click', function(){
        if (!list) return;
        list.querySelectorAll('input[type="checkbox"]').forEach(function(cb){
          cb.checked = true;
          cb.dispatchEvent(new Event('change'));
        });
        if (typeof animateButtonClick === 'function') {
          animateButtonClick(this);
        }
        if (typeof showToast === 'function') {
          showToast('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯', 'success');
        }
      });
    }

    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„
    if (unselAll) {
      unselAll.addEventListener('click', function(){
        if (!list) return;
        list.querySelectorAll('input[type="checkbox"]').forEach(function(cb){
          cb.checked = false;
          cb.dispatchEvent(new Event('change'));
        });
        if (typeof animateButtonClick === 'function') {
          animateButtonClick(this);
        }
        if (typeof showToast === 'function') {
          showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯', 'info');
        }
      });
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
    if (list) {
      list.addEventListener('change', function(e){
        if (e.target.type === 'checkbox') {
          const item = e.target.closest('.clause-item');
          if (item) {
            if (e.target.checked) {
              item.classList.add('selected');
              item.style.background = 'var(--primary-50)';
              item.style.borderColor = 'var(--primary-300)';
            } else {
              item.classList.remove('selected');
              item.style.background = '';
              item.style.borderColor = '';
            }
            updateSelectedCount();
          }
        }
      });
    }

    // ØªØ£Ø«ÙŠØ±Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙˆØ¯
    document.querySelectorAll('.clause-item').forEach(function(item){
      item.addEventListener('mouseenter', function() {
        if (!this.classList.contains('selected')) {
          this.style.background = 'var(--dark-50)';
        }
      });
      item.addEventListener('mouseleave', function() {
        if (!this.classList.contains('selected')) {
          this.style.background = '';
        }
      });
    });

    // ===== Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø®ØµÙ‘ØµØ© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© =====
    const rowsContainer = document.getElementById('custom-clauses-rows');
    const addCustomBtn = document.getElementById('add-custom-clause');
    const hiddenTextarea = document.querySelector('textarea[name="custom_clauses"]');
    const formEl = document.querySelector('.clauses-form');

    function createCustomClauseRow(value) {
      if (!rowsContainer) return;
      const row = document.createElement('div');
      row.className = 'custom-clause-row';

      const input = document.createElement('textarea');
      input.className = 'input custom-clause-input';
      input.placeholder = 'Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø¨Ù†Ø¯ Ù‡Ù†Ø§...';
      input.rows = 2;
      input.value = value || '';

      const delBtn = document.createElement('button');
      delBtn.type = 'button';
      delBtn.className = 'btn btn-light btn-sm custom-clause-delete';
      delBtn.textContent = 'ğŸ—‘ï¸ Ø­Ø°Ù';

      delBtn.addEventListener('click', function(){
        if (rowsContainer.children.length === 1 && input.value.trim() === '') {
          // Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ£ÙƒÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø­Ù‚Ù„Ù‹Ø§ ÙØ§Ø±ØºÙ‹Ø§ ÙˆÙˆØ­ÙŠØ¯Ù‹Ø§
          rowsContainer.removeChild(row);
          createCustomClauseRow('');
          return;
        }
        const ok = confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ù…Ø®ØµÙ‘ØµØŸ');
        if (!ok) return;
        rowsContainer.removeChild(row);
      });

      row.appendChild(input);
      row.appendChild(delBtn);
      rowsContainer.appendChild(row);
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', function(){
      if (hiddenTextarea) {
        // Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„ÙÙˆØ±Ù… Ø§Ù„Ø£ØµÙ„ÙŠ
        hiddenTextarea.style.display = 'none';

        const raw = hiddenTextarea.value || '';
        const parts = raw.split('\n').map(function(t){ return t.trim(); }).filter(function(t){ return t.length > 0; });
        if (parts.length > 0) {
          parts.forEach(function(text){
            createCustomClauseRow(text);
          });
        } else {
          // Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø­Ù‚Ù„ ÙˆØ§Ø­Ø¯ ÙØ§Ø±Øº Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø¯Ø®Ø§Ù„
          createCustomClauseRow('');
        }
      }

      if (addCustomBtn) {
        addCustomBtn.addEventListener('click', function(){
          createCustomClauseRow('');
          if (typeof animateButtonClick === 'function') {
            animateButtonClick(this);
          }
        });
      }

      // Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ØªØ¬Ù…ÙŠØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø§Ù„Ù€ textarea Ø§Ù„Ù…Ø®ÙÙŠØ© ÙƒØ³Ø·ÙˆØ±
      if (formEl && hiddenTextarea) {
        formEl.addEventListener('submit', function(){
          const values = [];
          const inputs = document.querySelectorAll('.custom-clause-input');
          inputs.forEach(function(inp){
            const v = (inp.value || '').trim();
            if (v) {
              values.push(v);
            }
          });
          hiddenTextarea.value = values.join('\n');
        });
      }

      // ØªÙˆØ³Øª Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø¨Ù†Ø¯
      const submitBtn = document.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.addEventListener('click', function(){
          if (typeof animateButtonClick === 'function') {
            animateButtonClick(this);
          }
          const selectedTextEl = document.getElementById('selected-count');
          const selectedNum = selectedTextEl ? selectedTextEl.textContent : '0';
          let anyCustom = false;
          document.querySelectorAll('.custom-clause-input').forEach(function(inp){
            if (!anyCustom && inp.value.trim() !== '') {
              anyCustom = true;
            }
          });
          if (selectedNum === '0' && !anyCustom) {
            if (typeof showToast === 'function') {
              showToast('Ù„Ù… ØªÙ‚Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¨Ù†ÙˆØ¯ Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†ÙˆØ¯ Ù…Ø®ØµØµØ©', 'warning');
            }
          }
        });
      }

      // ØªÙ‡ÙŠØ¦Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
      updateClauseItems();
    });

  })();
  </script>

  <style>
  .finalize-clauses-page .info-grid {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  }

  .finalize-clauses-page .info-item {
    border-radius: var(--radius-lg);
    border: 1px solid var(--dark-200);
    transition: all 0.3s ease;
  }

  .finalize-clauses-page .info-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .finalize-clauses-page .info-label {
    font-size: 0.875rem;
    color: var(--dark-600);
    margin-bottom: 0.5rem;
  }

  .finalize-clauses-page .info-value {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--dark-800);
  }

  .finalize-clauses-page .clauses-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-height: 400px;
    overflow-y: auto;
    padding: 1rem;
    border: 1px solid var(--dark-200);
    border-radius: var(--radius-lg);
    background: var(--white);
  }

  .finalize-clauses-page .clause-item {
    padding: 1rem;
    border: 2px solid var(--dark-200);
    border-radius: var(--radius-lg);
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .finalize-clauses-page .clause-item:hover {
    border-color: var(--primary-300);
    background: var(--primary-25);
  }

  .finalize-clauses-page .clause-item.selected {
    border-color: var(--primary-500);
    background: var(--primary-50);
  }

  .finalize-clauses-page .clause-label {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    cursor: pointer;
    margin: 0;
  }

  .finalize-clauses-page .clause-content {
    flex: 1;
  }

  .finalize-clauses-page .clause-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .finalize-clauses-page .clause-dot {
    width: 8px;
    height: 8px;
    background: var(--primary-500);
    border-radius: 50%;
    flex-shrink: 0;
  }

  .finalize-clauses-page .clause-title {
    font-weight: 600;
    color: var(--dark-800);
    line-height: 1.4;
  }

  /* Ø¥Ø®ÙØ§Ø¡ textarea Ø§Ù„Ø£ØµÙ„ÙŠ */
  .finalize-clauses-page .custom-clauses-field textarea[name="custom_clauses"] {
    display: none;
  }

  .finalize-clauses-page .custom-clauses-rows {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .finalize-clauses-page .custom-clause-row {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
  }

  .finalize-clauses-page .custom-clause-input {
    width: 100%;
    min-height: 60px;
    padding: 0.75rem 1rem;
    border: 1px solid var(--dark-300);
    border-radius: var(--radius-lg);
    background: var(--white);
    font-family: inherit;
    font-size: 0.95rem;
    line-height: 1.6;
    resize: vertical;
    transition: all 0.3s ease;
  }

  .finalize-clauses-page .custom-clause-input:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
  }

  .finalize-clauses-page .custom-clause-delete {
    white-space: nowrap;
  }

  .finalize-clauses-page .preview-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-height: 400px;
    overflow-y: auto;
    padding: 1rem;
  }

  .finalize-clauses-page .preview-item {
    border-right: 4px solid var(--primary-500);
    padding: 1.25rem;
    background: var(--white);
    border-radius: var(--radius-lg);
    border: 1px solid var(--dark-200);
    transition: all 0.3s ease;
  }

  .finalize-clauses-page .preview-item:hover {
    transform: translateX(-5px);
    box-shadow: var(--shadow-md);
  }

  .finalize-clauses-page .preview-content {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
  }

  .finalize-clauses-page .preview-number {
    width: 2rem;
    height: 2rem;
    background: var(--primary-500);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.875rem;
    flex-shrink: 0;
  }

  .finalize-clauses-page .preview-text {
    flex: 1;
  }

  .finalize-clauses-page .preview-title {
    color: var(--dark-800);
    display: block;
    margin-bottom: 0.5rem;
  }

  .finalize-clauses-page .preview-body,
  .finalize-clauses-page .preview-custom {
    color: var(--dark-600);
    line-height: 1.6;
  }

  .finalize-clauses-page .search-box {
    position: relative;
  }

  .finalize-clauses-page .search-box .input {
    padding-right: 2.5rem;
    width: 250px;
  }

  .finalize-clauses-page .clause-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .finalize-clauses-page .selection-count {
    margin-right: auto;
  }

  .finalize-clauses-page .form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-start;
  }

  @media (max-width: 768px) {
    .finalize-clauses-page .card-header-row {
      flex-direction: column;
      align-items: stretch;
      gap: 1rem;
    }
    
    .finalize-clauses-page .search-box .input {
      width: 100%;
    }
    
    .finalize-clauses-page .info-grid {
      grid-template-columns: 1fr;
    }
    
    .finalize-clauses-page .clause-actions {
      flex-direction: column;
      align-items: stretch;
    }
    
    .finalize-clauses-page .form-actions {
      flex-direction: column;
    }
    
    .finalize-clauses-page .form-actions .btn {
      width: 100%;
    }
  }

  @media (max-width: 480px) {
    .finalize-clauses-page .preview-content {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.75rem;
    }
    
    .finalize-clauses-page .clause-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }
  }

  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .finalize-clauses-page .scroll-reveal {
    animation: slideInRight 0.6s ease-out;
  }
  </style>
{% endblock %}
